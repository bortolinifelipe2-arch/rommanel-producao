<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Produ√ß√£o ‚Äî Fundi√ß√£o</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0e1a;--bg2:#111827;--bg3:#1c2537;--border:#2a3548;
  --accent:#f59e0b;--blue:#3b82f6;--green:#10b981;--red:#ef4444;--purple:#8b5cf6;
  --text:#f1f5f9;--muted:#64748b;--card:#161e2e;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.hdr{background:var(--bg2);border-bottom:2px solid var(--accent);padding:0 20px;height:54px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;letter-spacing:.05em;}
.logo span{color:var(--accent);}
.clock{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--accent);}
.date-str{font-size:10px;color:var(--muted);text-align:right;line-height:1.4;}
.tabs{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 20px;display:flex;gap:2px;overflow-x:auto;}
.tab{padding:11px 18px;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;position:relative;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-badge{position:absolute;top:6px;right:6px;background:var(--red);color:#fff;border-radius:10px;font-size:9px;font-weight:900;padding:1px 5px;min-width:16px;text-align:center;display:none;}
.tab-badge.show{display:block;}
.page{display:none;padding:20px;max-width:1200px;margin:0 auto;}
.page.active{display:block;}
.btn{border:none;border-radius:7px;padding:10px 18px;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:.07em;text-transform:uppercase;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-ac{background:var(--accent);color:#000;} .btn-ac:hover{background:#fbbf24;}
.btn-bl{background:var(--blue);color:#fff;} .btn-bl:hover{background:#2563eb;}
.btn-gn{background:var(--green);color:#fff;} .btn-gn:hover{background:#059669;}
.btn-rd{background:var(--red);color:#fff;} .btn-rd:hover{background:#dc2626;}
.btn-gy{background:var(--bg3);color:var(--muted);border:1px solid var(--border);}
.btn-pu{background:var(--purple);color:#fff;}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;}
.sec{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);}
.fi{background:var(--bg3);border:1.5px solid var(--border);border-radius:7px;padding:9px 12px;font-family:'Barlow',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;transition:border-color .2s;width:100%;}
.fi:focus{border-color:var(--accent);}
select.fi option{background:var(--bg2);}
.fl{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.fg{display:flex;flex-direction:column;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.gfull{grid-column:1/-1;}
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:800;letter-spacing:.05em;text-transform:uppercase;white-space:nowrap;}
.b-gn{background:rgba(16,185,129,.13);color:#6ee7b7;border:1px solid rgba(16,185,129,.3);}
.b-yw{background:rgba(245,158,11,.13);color:#fcd34d;border:1px solid rgba(245,158,11,.3);}
.b-rd{background:rgba(239,68,68,.13);color:#fca5a5;border:1px solid rgba(239,68,68,.3);}
.b-bl{background:rgba(59,130,246,.13);color:#93c5fd;border:1px solid rgba(59,130,246,.3);}
.b-pu{background:rgba(139,92,246,.13);color:#c4b5fd;border:1px solid rgba(139,92,246,.3);}
.b-gy{background:rgba(100,116,139,.1);color:#94a3b8;border:1px solid rgba(100,116,139,.2);}
.tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:600px;}
thead th{background:var(--bg3);padding:9px 12px;text-align:left;font-size:9px;font-weight:800;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody td{padding:9px 12px;border-bottom:1px solid rgba(42,53,72,.35);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(255,255,255,.015);}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 18px;}
.kpi-v{font-family:'Barlow Condensed',sans-serif;font-size:34px;font-weight:900;line-height:1;}
.kpi-l{font-size:11px;color:var(--muted);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:.06em;}
.kpi-s{font-size:10px;font-weight:700;margin-top:3px;}
.kpi.ac .kpi-v{color:var(--accent);} .kpi.gn .kpi-v{color:var(--green);}
.kpi.rd .kpi-v{color:var(--red);} .kpi.bl .kpi-v{color:var(--blue);}
.kpi.pu .kpi-v{color:var(--purple);}
.prog{height:5px;background:var(--border);border-radius:3px;overflow:hidden;min-width:60px;margin-top:4px;}
.prog-f{height:100%;border-radius:3px;background:var(--green);}
.prog-f.yw{background:var(--accent);} .prog-f.rd{background:var(--red);}
.scan-box{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px;}
.scan-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.scan-input{flex:1;min-width:180px;background:var(--bg3);border:2px solid var(--border);border-radius:7px;padding:11px 14px;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--text);letter-spacing:.07em;outline:none;transition:border-color .2s;}
.scan-input:focus{border-color:var(--accent);}
.scan-input::placeholder{color:var(--muted);font-size:13px;font-weight:400;}
/* ‚îÄ‚îÄ Dashboard per√≠odo buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.dash-periodo-btn{background:var(--bg3);color:var(--muted);border:1px solid var(--border);}
.dash-periodo-btn.active{background:var(--accent);color:#000;border-color:var(--accent);}
.dash-periodo-btn:hover:not(.active){border-color:var(--accent);color:var(--text);}
/* ‚îÄ‚îÄ Roteiro t√©cnico ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
details summary{list-style:none;}
details summary::-webkit-details-marker{display:none;}
details summary::before{content:'‚ñ∂ ';font-size:8px;margin-right:4px;transition:transform .2s;}
details[open] summary::before{content:'‚ñº ';}
/* ‚îÄ‚îÄ Modo Esc√¢ner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#page-scanner{position:fixed;inset:0;background:var(--bg);z-index:300;display:none;flex-direction:column;align-items:center;justify-content:flex-start;padding:0;}
#page-scanner.open{display:flex;}
.scanner-header{width:100%;background:var(--bg2);border-bottom:2px solid var(--accent);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;}
.scanner-body{width:100%;max-width:600px;padding:24px 20px;flex:1;display:flex;flex-direction:column;gap:16px;}
.scanner-input-big{width:100%;background:var(--bg3);border:3px solid var(--border);border-radius:12px;padding:18px 20px;font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--text);letter-spacing:.1em;outline:none;text-align:center;transition:border-color .2s;}
.scanner-input-big:focus{border-color:var(--accent);}
.scanner-card{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:18px;transition:border-color .2s;}
.scanner-card.loaded{border-color:var(--blue);}
.scanner-proc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-top:12px;}
.scanner-proc-btn{padding:12px;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:.05em;text-transform:uppercase;border:2px solid var(--border);background:var(--bg3);color:var(--muted);cursor:pointer;transition:all .15s;text-align:left;}
.scanner-proc-btn:hover{border-color:var(--blue);color:var(--text);}
.scanner-proc-btn.done{border-color:var(--green);color:var(--green);background:rgba(16,185,129,.07);}
.scanner-proc-btn.ativo{border-color:var(--blue);color:#93c5fd;background:rgba(59,130,246,.1);animation:borderPulse 2s infinite;}
.scanner-qtd-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.scanner-qbox{background:var(--bg3);border:2px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.scanner-qbox:focus-within{border-color:var(--accent);}
.scanner-qbox label{font-size:9px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;display:block;margin-bottom:6px;}
.scanner-qbox input{background:none;border:none;width:100%;text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;color:var(--text);outline:none;}
/* ‚îÄ‚îÄ Colaboradores melhorados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.colab-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 18px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
.colab-card.inativo{opacity:.5;border-style:dashed;}
.colab-rank{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:var(--border);width:36px;text-align:center;flex-shrink:0;}
.order-card{background:var(--card);border:2px solid var(--blue);border-radius:12px;padding:18px;margin-bottom:14px;display:none;}
.order-card.show{display:block;}
.order-info{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-bottom:14px;}
.oi{background:var(--bg3);border-radius:7px;padding:9px 11px;}
.oi-l{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:3px;}
.oi-v{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;}
.oi-v.ac{color:var(--accent);} .oi-v.gn{color:var(--green);}
.oi-v.bl{color:#93c5fd;} .oi-v.rd{color:var(--red);}
.proc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:6px;margin-bottom:14px;}
.proc-btn{background:var(--bg3);border:2px solid var(--border);border-radius:7px;padding:9px 11px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all .15s;text-align:left;display:flex;align-items:center;gap:7px;}
.proc-btn:hover{border-color:var(--blue);color:var(--text);}
.proc-btn.sel{background:rgba(59,130,246,.1);border-color:var(--blue);color:#93c5fd;}
.proc-btn.done{border-color:var(--green);color:var(--green);background:rgba(16,185,129,.06);}
.proc-btn.em-fila{border-color:var(--accent);color:var(--accent);background:rgba(245,158,11,.06);}
.proc-btn.em-fila .proc-num{background:rgba(245,158,11,.25);color:var(--accent);}
.proc-btn.em-processo{border-color:var(--blue);color:#93c5fd;background:rgba(59,130,246,.08);animation:borderPulse 2s infinite;}
.proc-btn.em-processo .proc-num{background:rgba(59,130,246,.25);color:#93c5fd;}
@keyframes borderPulse{0%,100%{border-color:var(--blue);}50%{border-color:#93c5fd;box-shadow:0 0 8px rgba(59,130,246,.4);}}
.proc-num{font-size:9px;background:var(--border);border-radius:4px;padding:1px 5px;font-weight:800;flex-shrink:0;}
.proc-btn.done .proc-num{background:rgba(16,185,129,.25);color:var(--green);}
.proc-btn.sel .proc-num{background:rgba(59,130,246,.25);color:#93c5fd;}
.form-box{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:18px;display:none;}
.form-box.show{display:block;}
.form-top{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:800;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.form-top em{color:var(--accent);font-style:normal;}
.qtd-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;}
.qbox{background:var(--bg3);border:2px solid var(--border);border-radius:9px;padding:11px;text-align:center;}
.qbox:focus-within{border-color:var(--accent);}
.qbox-l{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.qinput{background:none;border:none;width:100%;text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:900;color:var(--text);outline:none;}
.qinput.gn{color:var(--green);} .qinput.rd{color:var(--red);}
/* sugestao entrada */
.sug-ent{font-size:10px;color:var(--accent);margin-top:3px;font-weight:700;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);padding:11px 24px;border-radius:50px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;letter-spacing:.06em;transition:transform .35s cubic-bezier(.34,1.56,.64,1);z-index:999;white-space:nowrap;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.ok{background:var(--green);color:#fff;}
.toast.err{background:var(--red);color:#fff;}
.toast.info{background:var(--blue);color:#fff;}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-bg.open{display:flex;}
.modal{background:var(--bg2);border:2px solid var(--border);border-radius:14px;padding:22px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;}
.modal h3{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;margin-bottom:14px;}
.mbtns{display:flex;gap:10px;margin-top:16px;}
.mbtn{flex:1;padding:11px;border-radius:7px;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;cursor:pointer;border:none;transition:all .2s;}
.proc-view-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;}
.proc-view-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--accent);margin-bottom:10px;}
.ref-chip{display:inline-flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:5px 10px;font-size:11px;font-weight:700;margin:3px;cursor:pointer;transition:border-color .2s;}
.ref-chip:hover{border-color:var(--accent);color:var(--accent);}
.ref-timeline{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
.rt-step{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:6px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.04em;}
.rt-done{background:rgba(16,185,129,.1);color:#6ee7b7;border:1px solid rgba(16,185,129,.25);}
.rt-current{background:rgba(245,158,11,.15);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
.rt-pending{background:var(--bg3);color:var(--muted);border:1px solid var(--border);}
.qbr-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;flex:1;}
.qbr-fill{height:100%;border-radius:4px;background:var(--green);transition:width .5s;}
.qbr-fill.yw{background:var(--accent);} .qbr-fill.rd{background:var(--red);}
.dl-ok{color:var(--green);} .dl-near{color:var(--accent);} .dl-late{color:var(--red);}
.hidden{display:none!important;}
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-ico{font-size:36px;margin-bottom:10px;}
.rt-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(239,68,68,.18);color:#fca5a5;border:1.5px solid rgba(239,68,68,.4);border-radius:5px;padding:2px 9px;font-size:10px;font-weight:900;letter-spacing:.07em;text-transform:uppercase;}
.order-card.retrabalho{border-color:var(--red);}
  .order-card.recuperavel{border-color:rgba(245,158,11,.5);}
.order-card.retrabalho .order-card-banner{background:rgba(239,68,68,.1);border-bottom:1px solid rgba(239,68,68,.25);padding:8px 14px;margin:-18px -18px 14px;border-radius:10px 10px 0 0;display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#fca5a5;}
.hist-rt td{background:rgba(239,68,68,.04);}
.qbr-hist-card{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.qbr-hist-header{background:var(--bg3);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border);}
.qbr-hist-body{padding:12px 14px;}
.fase-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(42,53,72,.3);}
.fase-row:last-child{border-bottom:none;}
.fase-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.fase-fill{height:100%;border-radius:3px;background:var(--red);}
/* ALERTA GARGALO */
.alerta-gargalo{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.alerta-pulse{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--red);animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
/* COLABORADORES */
.colab-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.colab-rank{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;color:var(--accent);flex-shrink:0;width:36px;}
/* METAS */
.meta-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;}
.meta-gauge{height:12px;background:var(--border);border-radius:6px;overflow:hidden;margin:8px 0;}
.meta-fill{height:100%;border-radius:6px;transition:width .5s;}
/* AUDITORIA */
.audit-row{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid rgba(42,53,72,.3);font-size:12px;}
.audit-row:last-child{border-bottom:none;}
/* ETIQUETA */
.etq-card{background:#fff;border:2px solid #222;border-radius:4px;padding:4mm;width:80mm;font-family:Arial,sans-serif;color:#000;}
/* GR√ÅFICO TEND√äNCIA */
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
/* TURNO badge */
.turno-m{background:rgba(245,158,11,.15);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
.turno-t{background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.3);}
.turno-n{background:rgba(139,92,246,.1);color:#c4b5fd;border:1px solid rgba(139,92,246,.3);}
/* PREVIS√ÉO */
.prev-card{background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:10px 14px;font-size:12px;font-weight:700;color:#6ee7b7;margin-top:6px;}
/* BACKUP */
.backup-section{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:14px;}
/* N√£o se aplica */
.proc-btn.nao-aplica{border-color:var(--muted);color:var(--muted);background:rgba(100,116,139,.08);opacity:.7;}
.proc-btn.nao-aplica .proc-num{background:rgba(100,116,139,.2);}
/* Revis√£o bruto */
.revisao-bruto-box{background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.3);border-radius:10px;padding:14px;margin-bottom:14px;}
.qbr-tipo-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.qbr-tipo-btn{border:2px solid var(--border);border-radius:8px;padding:10px;text-align:center;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:13px;transition:all .2s;background:var(--bg3);}
.qbr-tipo-btn.sel-def{border-color:var(--red);background:rgba(239,68,68,.12);color:#fca5a5;}
.qbr-tipo-btn.sel-rec{border-color:var(--green);background:rgba(16,185,129,.12);color:#6ee7b7;}
/* Auto entrada badge */
.auto-entrada-badge{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:7px;padding:7px 12px;margin-bottom:10px;font-size:12px;font-weight:700;color:#6ee7b7;display:flex;align-items:center;gap:8px;}
/* Retrabalho ok produzindo */
.rt-ok-produzindo{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);border-radius:7px;padding:8px 12px;font-size:12px;font-weight:700;color:#6ee7b7;display:inline-flex;align-items:center;gap:6px;}
/* FRA√á√ïES */
.fracoes-panel{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:14px;margin-top:12px;}
.fracao-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(42,53,72,.3);}
.fracao-row:last-child{border-bottom:none;}
.fracao-num{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;color:var(--blue);flex-shrink:0;width:70px;}
.fracao-qtd{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;flex-shrink:0;width:60px;}
.fracao-status{flex:1;}
.fracao-actions{display:flex;gap:5px;flex-shrink:0;}
.fracao-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:3px;}
.fracao-bar-fill{height:100%;border-radius:2px;background:var(--green);}
/* Modal fracionamento */
.frac-input-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end;margin-bottom:8px;}
/* Etiqueta fra√ß√£o */
.etq-fracao-flag{background:#1d4ed8;color:#fff;font-size:9px;font-weight:900;padding:1px 5px;border-radius:3px;}

/* ‚ïê‚ïê PRINT ‚ïê‚ïê */
#printArea{display:none;}
@media print{
  html,body{margin:0;padding:0;}
  body>*:not(#printArea){display:none!important;visibility:hidden!important;}
  #printArea{display:block!important;visibility:visible!important;position:fixed;top:0;left:0;width:100%;z-index:99999;}
  @page{size:A4 portrait;margin:8mm 8mm;}
}
.po-card{border:2px solid #222;padding:5mm 6mm;height:128mm;box-sizing:border-box;overflow:hidden;position:relative;font-family:Arial,sans-serif;color:#000;background:#fff;page-break-inside:avoid;break-inside:avoid;}
.po-divider{border:none;border-top:2px dashed #bbb;margin:0;}
.po-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2mm;}
.po-logo-txt{font-size:17px;font-weight:900;letter-spacing:.04em;}
.po-logo-txt span{color:#b8860b;}
.po-order-num{font-size:22px;font-weight:900;line-height:1;text-align:right;}
.po-prio{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;}
.po-prio.critico{background:#ef4444;color:#fff;}
.po-prio.urgente{background:#f59e0b;color:#000;}
.po-prio.normal{background:#e5e7eb;color:#333;}
.po-rt-flag{display:inline-block;background:#ef4444;color:#fff;font-size:9px;font-weight:900;padding:1px 6px;border-radius:3px;margin-left:4px;}
.po-barcode-row{display:flex;gap:4mm;align-items:flex-start;margin-bottom:2mm;}
.po-barcode-row svg{flex-shrink:0;}
.po-ref{font-size:13px;font-weight:900;margin-bottom:1mm;}
.po-desc{font-size:9px;color:#333;font-weight:700;margin-bottom:1mm;}
.po-produto{font-size:8px;color:#555;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110mm;}
.po-meta{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5mm;margin-bottom:2mm;}
.po-meta-cell{border:1px solid #bbb;border-radius:2px;padding:1px 3px;}
.po-meta-lbl{font-size:7px;font-weight:700;color:#888;text-transform:uppercase;}
.po-meta-val{font-size:10px;font-weight:800;}
.po-meta-val.late{color:#ef4444;} .po-meta-val.near{color:#b8860b;}
.po-table{width:100%;border-collapse:collapse;font-size:8px;}
.po-table th{background:#1c2537;color:#fff;padding:2px 3px;font-size:7px;text-transform:uppercase;letter-spacing:.04em;}
.po-table th:first-child{text-align:left;}
.po-table td{border:1px solid #ccc;padding:2px 3px;text-align:center;line-height:1.3;}
.po-table td:first-child{text-align:left;font-weight:700;font-size:7px;}
.po-table tr.done-row td{background:#f0fdf4;}
.po-footer{position:absolute;bottom:2mm;left:6mm;right:6mm;font-size:7px;color:#aaa;display:flex;justify-content:space-between;}
/* ETIQUETA IMPRESS√ÉO */
.etq-print{border:1.5px solid #333;padding:3mm 4mm;width:78mm;font-family:Arial,sans-serif;color:#000;page-break-inside:avoid;display:inline-block;margin:1mm;}
</style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    #loginScreen{position:fixed;inset:0;background:#0d1117;display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:20px;}
    #loginScreen.hidden{display:none;}
    .login-card{background:#161b24;border:1px solid #2a3448;border-radius:16px;padding:40px 32px;text-align:center;max-width:360px;width:90%;}
    .login-logo{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;background:linear-gradient(135deg,#e8edf5,#4f9cf9);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;}
    .login-sub{font-size:12px;color:#5a6a80;margin-bottom:28px;}
    .btn-google{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:13px 20px;border-radius:10px;border:1.5px solid #2a3448;background:#1e2533;color:#e8edf5;font-size:14px;font-weight:600;cursor:pointer;transition:border-color .15s;}
    .btn-google:hover{border-color:#4f9cf9;}
    .btn-google img{width:20px;height:20px;}
    #loginError{font-size:12px;color:#f87171;margin-top:12px;display:none;}
    #loadingScreen{position:fixed;inset:0;background:#0d1117;display:flex;align-items:center;justify-content:center;z-index:9998;flex-direction:column;gap:16px;}
    #loadingScreen.hidden{display:none;}
    .loading-spinner{width:40px;height:40px;border:3px solid #2a3448;border-top-color:#4f9cf9;border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:13px;color:#5a6a80;}
    #userBar{position:fixed;bottom:0;left:0;right:0;background:#161b24;border-top:1px solid #2a3448;padding:6px 16px;display:flex;align-items:center;justify-content:space-between;font-size:11px;color:#5a6a80;z-index:100;}
    #userBar .uname{color:#e8edf5;font-weight:600;}
    #userBar .ubtn{background:none;border:1px solid #2a3448;border-radius:6px;color:#5a6a80;padding:3px 10px;cursor:pointer;font-size:10px;}
    #userBar .ubtn:hover{border-color:#f87171;color:#f87171;}
    #syncStatus{font-size:10px;display:flex;align-items:center;gap:5px;}
    .sync-dot{width:6px;height:6px;border-radius:50%;background:#3ecf8e;}
    .sync-dot.syncing{background:#f8b24d;animation:pulse .8s ease infinite;}
    .sync-dot.error{background:#f87171;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">‚öóÔ∏è Rommanel</div>
    <div class="login-sub">Sistema de Controle de Produ√ß√£o</div>
    <button class="btn-google" onclick="fazerLogin()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Entrar com Google
    </button>
    <div id="loginError">Erro ao fazer login. Tente novamente.</div>
  </div>
</div>

<!-- TELA DE CARREGANDO -->
<div id="loadingScreen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Carregando dados...</div>
</div>

<!-- BARRA DE USU√ÅRIO -->
<div id="userBar" style="display:none;">
  <div><span class="uname" id="userNome"></span> <span id="userEmail" style="margin-left:6px;"></span></div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="sync-dot" id="syncDot"></div>
    <span id="syncText">sincronizado</span>
    <button class="ubtn" onclick="fazerLogout()">Sair</button>
  </div>
</div>



<div class="hdr">
  <div class="logo">FUNDI√á√ÉO <span>CONTROLE</span></div>
  <div style="display:flex;align-items:center;gap:16px;">
    <div id="alertaHdr" style="display:none;"></div>
    <div>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date-str" id="dateStr"></div>
    </div>
  </div>
</div>

<div class="tabs">
  <button class="tab active"  onclick="goPage('lancamento',this)">‚ö° Lan√ßamento</button>
  <button class="tab"         onclick="goPage('pedidos',this)">üõí Pedidos<span class="tab-badge" id="badgePedidos"></span></button>
  <button class="tab"         onclick="goPage('por-ordem',this)">üìã Por Ordem</button>
  <button class="tab"         onclick="goPage('por-processo',this)">üîÑ Por Processo<span class="tab-badge" id="badgeGargalo"></span></button>
  <button class="tab"         onclick="goPage('cadastro-ref',this)">üì¶ Cadastro</button>
  <button class="tab"         onclick="goPage('referencias',this)">üîç Refer√™ncias</button>
  <button class="tab"         onclick="goPage('quebras',this)">‚ùå Quebras</button>
  <button class="tab"         onclick="goPage('dashboard',this)">üìä Dashboard</button>
  <button class="tab"         onclick="goPage('historico',this)">üóÇ Hist√≥rico</button>
  <button class="tab"         onclick="goPage('colaboradores',this)">üë• Colaboradores</button>
  <button class="tab"         onclick="goPage('arvores',this)">üå≥ √Årvores<span class="tab-badge" id="badgeArvores"></span></button>
  <button class="tab"         onclick="goPage('metal',this)">‚öóÔ∏è Metal</button>
  <button class="tab"         onclick="goPage('config',this)">‚öôÔ∏è Config</button>
</div>

<!-- LAN√áAMENTO -->
<div class="page active" id="page-lancamento">
  <div class="scan-box">
    <div class="fl">üì° Bipe o c√≥digo de barras ou digite o n√∫mero da ordem</div>
    <div class="scan-row">
      <input class="scan-input" id="scanInput" type="text" placeholder="Bipe ou digite N¬∫ da ordem ‚Üí Enter" autocomplete="off" autofocus onkeydown="if(event.key==='Enter')buscarOrdem()">
      <button class="btn btn-ac" onclick="buscarOrdem()">BUSCAR</button>
      <button class="btn btn-bl" onclick="abrirModal('nova-ordem')">+ NOVA ORDEM</button>
      <button class="btn" style="background:rgba(245,158,11,.15);color:var(--accent);border:1px solid rgba(245,158,11,.3);padding:10px 16px;font-size:13px;" onclick="abrirScanner()" title="Modo esc√¢ner fullscreen ‚Äî ideal para tablet no ch√£o de f√°brica">üì° MODO ESC√ÇNER</button>
    </div>
  </div>
  <div id="alertaGargaloLan"></div>
  <div class="order-card" id="orderCard">
    <div class="order-info" id="orderInfo"></div>
    <!-- Roteiro t√©cnico da refer√™ncia -->
    <div id="ordemRoteiroPanel" style="display:none;"></div>
    <div class="fl" style="margin-bottom:8px;">Selecione o processo a lan√ßar</div>
    <div class="proc-grid" id="procGrid"></div>
    <!-- Painel de fra√ß√µes ativas -->
    <div id="fracoesPanel" style="display:none;" class="fracoes-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:#93c5fd;">‚úÇÔ∏è SUBLOTES DESTA ORDEM</div>
        <button class="btn btn-gy" style="padding:5px 10px;font-size:11px;" onclick="imprimirEtiquetasFracoes()">üè∑Ô∏è Imprimir Etiquetas das Fra√ß√µes</button>
      </div>
      <div id="fracoesLista"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;margin-bottom:4px;flex-wrap:wrap;" id="ordemAcoes">
      <button class="btn" style="background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.3);padding:6px 14px;font-size:12px;" onclick="abrirModal('fracionar-ordem')">‚úÇÔ∏è Fracionar Ordem</button>
    </div>
    <div class="form-box" id="formBox">
      <div class="form-top">Lan√ßar ‚Üí <em id="procNome"></em> <span id="turnoAtual" class="badge" style="margin-left:8px;"></span></div>
      <div id="sugEntrada" class="sug-ent hidden"></div>
      <div id="entradaBanner" style="display:none;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.35);border-radius:8px;padding:9px 14px;margin-bottom:10px;align-items:center;gap:8px;">
        <span style="font-size:18px;">üîÑ</span>
        <span style="font-size:12px;font-weight:700;color:#93c5fd;"></span>
      </div>
      <div class="qtd-row">
        <div class="qbox">
          <div class="qbox-l">Entrada</div>
          <input class="qinput" id="fEnt" type="number" min="0" placeholder="0" oninput="autoQbr()">
        </div>
        <div class="qbox">
          <div class="qbox-l">Sa√≠da ‚úÖ</div>
          <input class="qinput gn" id="fSai" type="number" min="0" placeholder="0" oninput="autoQbr()">
        </div>
        <div class="qbox" id="qboxQuebra" style="border-color:rgba(239,68,68,.35);display:none;">
          <div class="qbox-l" style="color:var(--red)">Quebra ‚ùå</div>
          <input class="qinput rd" id="fQbr" type="number" min="0" placeholder="0" readonly>
        </div>
      </div>
      <!-- ‚ïê‚ïê‚ïê PAINEL TRATAR DEFEITO ‚ïê‚ïê‚ïê -->
      <div class="hidden" id="motivoRow" style="margin-bottom:12px;">
        <div style="background:rgba(239,68,68,.07);border:1.5px solid rgba(239,68,68,.35);border-radius:10px;padding:12px 14px;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:900;color:var(--red);letter-spacing:.08em;margin-bottom:10px;">
            üî¥ TRATAR DEFEITO
          </div>
          <!-- Tipo do defeito -->
          <div class="fg" style="margin-bottom:10px;">
            <div class="fl" style="margin-bottom:4px;">Tipo de Defeito *</div>
            <select class="fi" id="fMotivo" style="font-size:12px;">
              <option value="">Selecione o defeito...</option>
              <option>Def. na textura</option>
              <option>Furo/Corte</option>
              <option>Poroso</option>
              <option>Sem solda ou excesso</option>
              <option>Sem pedra e Defeito na pedra</option>
              <option>Amassado</option>
              <option>Quebrado</option>
              <option>M√° forma√ß√£o</option>
              <option>Excesso de fundi√ß√£o</option>
              <option>Esfera dentro</option>
              <option>Mancha</option>
              <option>Marca de impress√£o</option>
              <option>Grade errada / Grava√ß√£o incorreta</option>
              <option>Pe√ßa misturada</option>
              <option>Sem acess√≥rio</option>
              <option>SEM CONTRASTE</option>
              <option>SOBRA</option>
              <option>Porosidade</option>
              <option>Mal formados</option>
              <option>N√£o formou</option>
              <option>Falha de impress√£o</option>
              <option>√Åspero</option>
              <option>Risco</option>
              <option>Outro</option>
            </select>
          </div>
          <!-- RECUPER√ÅVEL ou DEFINITIVO -->
          <div style="margin-bottom:10px;">
            <div class="fl" style="margin-bottom:6px;">Este defeito √© *</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div id="defBtn_REC" onclick="selTipoDefeito('RECUPERAVEL')"
                style="cursor:pointer;border-radius:8px;border:2px solid var(--border);background:var(--bg3);padding:9px 11px;transition:all .15s;user-select:none;">
                <div style="font-size:11px;font-weight:900;color:var(--accent);">üîÑ RECUPER√ÅVEL</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px;line-height:1.4;">Defei¬≠to trat√°vel ‚Äî sublote retorna a partir de um processo</div>
              </div>
              <div id="defBtn_DEF" onclick="selTipoDefeito('DEFINITIVO')"
                style="cursor:pointer;border-radius:8px;border:2px solid var(--border);background:var(--bg3);padding:9px 11px;transition:all .15s;user-select:none;">
                <div style="font-size:11px;font-weight:900;color:var(--red);">‚ö†Ô∏è DEFINITIVO</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px;line-height:1.4;">Quebra total ‚Äî novo lote gerado do zero na fila</div>
              </div>
            </div>
            <input type="hidden" id="fTipoDefeito" value="">
          </div>
          <!-- Processo de retorno ‚Äî s√≥ para RECUPER√ÅVEL -->
          <div id="painelRetorno" style="display:none;margin-top:2px;">
            <div class="fl" style="margin-bottom:4px;">Retorna a partir de qual processo? *</div>
            <select class="fi" id="fProcRetorno" style="font-size:12px;">
            </select>
            <div style="font-size:10px;color:var(--muted);margin-top:5px;line-height:1.5;">
              ‚ö° O sublote de recupera√ß√£o entra direto neste processo, sem voltar √† impressora.
            </div>
          </div>
        </div>
      </div>
      <div class="hidden" id="subRow" style="margin-bottom:12px;">
        <div class="fg"><div class="fl">Sub Processo</div>
          <select class="fi" id="fSub"><option value="">N√£o se aplica</option></select>
        </div>
      </div>
      <div class="g2" style="margin-bottom:12px;">
        <div class="fg"><div class="fl">Colaborador *</div>
          <select class="fi" id="fColab"><option value="">Selecione...</option></select>
        </div>
        <div class="fg"><div class="fl">Hora In√≠cio</div>
          <input class="fi" id="fHini" type="time">
        </div>
      </div>
      <div class="g2" style="margin-bottom:14px;">
        <div class="fg"><div class="fl">Hora T√©rmino</div>
          <input class="fi" id="fHfim" type="time">
        </div>
        <div class="fg"><div class="fl">Observa√ß√£o</div>
          <input class="fi" id="fObs" type="text" placeholder="Opcional">
        </div>
      </div>
      <div id="metalRow" class="hidden" style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:14px;margin-bottom:14px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:7px;">‚öóÔ∏è CONTROLE DE METAL</div>
        <div class="g3" style="gap:10px;margin-bottom:10px;">
          <div class="fg"><div class="fl">Tipo de Metal</div>
            <select class="fi" id="fMetalTipo">
              <option value="">Selecione...</option>
              <option>LAT√ÉO</option>
              <option>PRATA</option>
              <option>OURO</option>
              <option>OUTRO</option>
            </select>
          </div>
          <div class="fg"><div class="fl">Peso Entrada (g)</div>
            <input class="fi" id="fMetalEnt" type="number" min="0" step="0.01" placeholder="0.00" oninput="autoMetalPerda()">
          </div>
          <div class="fg"><div class="fl">Peso Sa√≠da (g)</div>
            <input class="fi" id="fMetalSai" type="number" min="0" step="0.01" placeholder="0.00" oninput="autoMetalPerda()">
          </div>
        </div>
        <div id="metalPerdaRow" class="hidden" style="display:flex;align-items:center;gap:12px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:7px;padding:8px 12px;">
          <span style="font-size:18px;">‚ö†Ô∏è</span>
          <span style="font-size:12px;font-weight:700;color:#fca5a5;">Perda de metal: <strong id="metalPerdaVal" style="font-size:16px;">0.00g</strong></span>
          <span id="metalPerdaPct" style="font-size:11px;color:var(--muted);"></span>
        </div>
      </div>
      <button class="btn btn-gn" style="width:100%;padding:13px;font-size:17px;border-radius:9px;" onclick="lancar()">‚úÖ CONFIRMAR LAN√áAMENTO</button>
      <button id="btnSubLancamento" class="btn" style="width:100%;padding:10px;font-size:13px;border-radius:9px;margin-top:6px;background:rgba(245,158,11,.12);color:var(--accent);border:1px solid rgba(245,158,11,.3);display:none;" onclick="lancarSubPassagem()">‚ûï Registrar Sub-passagem (mesma quantidade, continua aberto)</button>
      <div id="subPassagensBanner" style="display:none;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:12px;font-weight:700;color:var(--accent);gap:8px;align-items:flex-start;flex-direction:row;flex-wrap:wrap;"></div>
      <div id="skipProcRow" style="display:none;margin-top:8px;">
        <button class="btn" style="width:100%;padding:10px;font-size:13px;border-radius:9px;background:rgba(100,116,139,.15);color:var(--muted);border:1px solid var(--border);" onclick="pularProcesso()">‚è≠ Marcar como "N√£o se Aplica" e pular</button>
      </div>
      <!-- Revis√£o Bruto - se√ß√£o especial -->
      <div id="revisaoBrutoBox" style="display:none;">
        <div class="revisao-bruto-box">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:#c4b5fd;margin-bottom:12px;">üîç CLASSIFICA√á√ÉO DE DEFEITOS ‚Äî REVIS√ÉO BRUTO</div>
          <div id="qbrDetalhesList"></div>
          <button class="btn btn-pu" style="width:100%;margin-top:8px;font-size:13px;padding:9px;" onclick="adicionarItemQbrDetalhe()">+ Adicionar Defeito</button>
        </div>
        <button class="btn btn-gn" style="width:100%;padding:13px;font-size:17px;border-radius:9px;margin-top:4px;" onclick="lancarRevisaoBruto()">‚úÖ CONFIRMAR REVIS√ÉO BRUTO</button>
      </div>
    </div>
  </div>
</div>

<!-- POR ORDEM -->
<!-- PEDIDOS -->
<div class="page" id="page-pedidos">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">üõí Pedidos de Produ√ß√£o</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Crie pedidos e emita ordens fracionadas abatendo o saldo at√© completar o total</div>
    </div>
    <button class="btn btn-gn" onclick="abrirModal('novo-pedido')">+ Novo Pedido</button>
  </div>
  <div id="pedidosKpis" class="g4" style="margin-bottom:20px;"></div>
  <div style="margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <input class="fi" id="filtPedido" type="text" placeholder="Buscar por N¬∫, refer√™ncia ou descri√ß√£o..." oninput="renderPedidos()" style="max-width:320px;">
    <select class="fi" id="filtStatusPedido" onchange="renderPedidos()" style="max-width:160px;">
      <option value="">Todos</option>
      <option value="aberto">Sem emiss√£o</option>
      <option value="parcial">Parcialmente emitido</option>
      <option value="concluido">Completamente emitido</option>
    </select>
  </div>
  <div id="pedidosLista"></div>
</div>

<div class="page" id="page-por-ordem">
  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:flex-end;">
    <div class="fg" style="flex:1;min-width:160px;"><div class="fl">Buscar ordem</div>
      <input class="fi" id="filtOrdemPO" type="text" placeholder="N¬∫ da ordem ou refer√™ncia..." oninput="renderPorOrdem()"></div>
    <div class="fg" style="min-width:130px;"><div class="fl">Status</div>
      <select class="fi" id="filtStatusPO" onchange="renderPorOrdem()"><option value="">Todos</option><option value="andamento">Em andamento</option><option value="concluida">Conclu√≠da</option></select></div>
    <div class="fg" style="min-width:130px;"><div class="fl">Prioridade</div>
      <select class="fi" id="filtPrioPO" onchange="renderPorOrdem()"><option value="">Todas</option><option>CRIT√çCO</option><option>URG√äNTE</option><option>NORMAL</option></select></div>
    <button class="btn btn-bl" onclick="abrirModal('nova-ordem')">+ Nova Ordem</button>
  </div>
  <div id="printToolbar" style="display:none;background:rgba(59,130,246,.1);border:1px solid var(--blue);border-radius:8px;padding:9px 14px;margin-bottom:10px;align-items:center;gap:10px;flex-wrap:wrap;">
    <span id="printCount" style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:#93c5fd;">0 ordens selecionadas</span>
    <button class="btn btn-bl" onclick="imprimirSelecionadas()" style="padding:6px 14px;font-size:12px;">üñ®Ô∏è IMPRIMIR SELECIONADAS</button>
    <button class="btn btn-pu" onclick="imprimirEtiquetasSelecionadas()" style="padding:6px 14px;font-size:12px;">üè∑Ô∏è ETIQUETAS</button>
    <button class="btn btn-gy" onclick="limparSelecao()" style="padding:6px 12px;font-size:11px;">‚úï Limpar</button>
  </div>
  <div id="ordemLista"></div>
</div>

<!-- POR PROCESSO -->
<div class="page" id="page-por-processo">
  <div style="margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;">
    <div class="fg" style="flex:1;min-width:160px;"><div class="fl">Filtrar por processo</div>
      <select class="fi" id="filtProcPP" onchange="renderPorProcesso()">
        <option value="">Todos os processos</option>
        <option>FILA IMPRESS√ÉO</option><option>IMPRESS√ÉO 3D</option><option>LIMPEZA DE CERA X SUPORTE</option>
        <option>CRAVA√á√ÉO CERA</option><option>MONTAGEM √ÅRVORE</option><option>FUNDI√á√ÉO</option>
        <option>REVIS√ÉO BRUTO</option><option>CORTE DE √ÅRVORE</option><option>LIXA</option><option>ACABAMENTO AUTOM√ÅTICO</option>
        <option>SOLDA</option><option>MONTAGEM</option><option>CRAVA√á√ÉO METAL</option><option>ENVIADO PARA REVIS√ÉO</option>
      </select></div>
  </div>
  <div id="alertasProcesso"></div>
  <div id="processoLista"></div>
</div>

<!-- CADASTRO DE REFER√äNCIAS -->
<div class="page" id="page-cadastro-ref">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">üì¶ Cadastro de Refer√™ncias</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Cadastre refer√™ncias com acess√≥rios para agilizar a cria√ß√£o de ordens</div>
    </div>
    <button class="btn btn-gn" onclick="abrirFormCadRef()">+ Nova Refer√™ncia</button>
  </div>

  <!-- Formul√°rio de cadastro (colaps√°vel) -->
  <div id="formCadRef" class="card" style="display:none;margin-bottom:20px;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);">
      <span id="formCadRefTitulo">‚ûï Nova Refer√™ncia</span>
    </div>

    <!-- Dados b√°sicos -->
    <div class="sec">Dados da Pe√ßa</div>

    <!-- Campo de foto ‚Äî simples e direto -->
    <div style="margin-bottom:16px;padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;">
      <div class="fl" style="margin-bottom:10px;">üì∑ FOTO DO PRODUTO</div>
      <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <div id="crFotoThumb" style="width:100px;height:100px;border-radius:8px;border:2px dashed var(--accent);background:var(--bg2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;">
          <span id="crFotoThumbIco" style="font-size:36px;">üì∑</span>
          <img id="crFotoImg" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover;">
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label style="display:inline-flex;align-items:center;gap:8px;background:var(--blue);color:#fff;border-radius:7px;padding:9px 16px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:.07em;text-transform:uppercase;cursor:pointer;">
            üìÇ ESCOLHER FOTO
            <input type="file" id="crFotoInput" accept="image/*" style="display:none;" onchange="carregarFotoCadRef(this)">
          </label>
          <button id="crFotoRemoveBtn" class="btn btn-rd" style="padding:7px 14px;font-size:12px;display:none;" onclick="removerFotoCadRef()">‚úï Remover foto</button>
          <div style="font-size:10px;color:var(--muted);">JPG ¬∑ PNG ¬∑ WEBP ¬∑ m√°x. 5MB</div>
        </div>
      </div>
    </div>

    <!-- Demais campos em grid -->
    <div class="g2" style="gap:10px;margin-bottom:12px;">
      <div class="fg"><div class="fl">Refer√™ncia Bruta *</div><input class="fi" id="crRef" type="text" placeholder="Ex: FAN-0118" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="fg"><div class="fl">Refer√™ncia Acabada</div><input class="fi" id="crRefAcab" type="text" placeholder="Ex: 513426"></div>
      <div class="fg gfull"><div class="fl">Descri√ß√£o do Produto *</div><input class="fi" id="crDesc" type="text" placeholder="Ex: ANEL LAT√ÉO ‚Äî Anel alian√ßa m√©dia com Mickey"></div>
      <div class="fg"><div class="fl">Tamanho Final</div><input class="fi" id="crTam" type="text" placeholder="Ex: 16, 18, 20..."></div>
      <div class="fg"><div class="fl">Tipo / Material</div>
        <select class="fi" id="crTipo">
          <option value="">Selecione...</option>
          <option>ANEL LAT√ÉO</option><option>ANEL PRATA</option><option>ANEL OURO</option>
          <option>BRINCO LAT√ÉO</option><option>BRINCO PRATA</option>
          <option>PINGENTE LAT√ÉO</option><option>PINGENTE PRATA</option>
          <option>GARGANTILHA LAT√ÉO</option><option>GARGANTILHA PRATA</option>
          <option>PULSEIRA LAT√ÉO</option><option>PULSEIRA PRATA</option><option>OUTRO</option>
        </select>
      </div>
      <div class="fg"><div class="fl">Prioridade Padr√£o</div>
        <select class="fi" id="crPrio"><option>NORMAL</option><option>URG√äNTE</option><option>CRIT√çCO</option></select>
      </div>
    </div>

    <!-- Pedras na Fundi√ß√£o -->
    <div class="sec" style="margin-top:6px;">Fundi√ß√£o</div>
    <div class="g2">
      <div class="fg">
        <div class="fl">Peso das Pedras na Cera (g/pe√ßa) <span style="font-size:9px;color:var(--muted);">(0 = sem pedra)</span></div>
        <input class="fi" id="crPesoPedrasFund" type="number" step="0.001" min="0" placeholder="0.000">
      </div>
      <div class="fg">
        <div class="fl">Metal da Fundi√ß√£o</div>
        <select class="fi" id="crMetalFund">
          <option value="">‚Äî</option>
          <option value="prata">Prata 925</option>
          <option value="latao">Lat√£o</option>
        </select>
      </div>
    </div>
    <!-- Acess√≥rio Interno -->
    <div class="sec" style="margin-top:6px;">Acess√≥rio Interno</div>
    <div id="acessoriosInternosList"></div>
    <button class="btn btn-gy" style="padding:6px 14px;font-size:12px;margin-bottom:16px;" onclick="addAcessorio('interno')">+ Adicionar Acess√≥rio Interno</button>

    <!-- Acess√≥rio Externo -->
    <div class="sec">Acess√≥rio Externo</div>
    <div id="acessoriosExternosList"></div>
    <button class="btn btn-gy" style="padding:6px 14px;font-size:12px;margin-bottom:16px;" onclick="addAcessorio('externo')">+ Adicionar Acess√≥rio Externo</button>

    <!-- Sub-processos padr√£o por processo -->
    <div class="sec">Sub-processo Padr√£o por Processo
      <span style="font-size:10px;font-weight:400;color:var(--muted);margin-left:8px;">(auto-sugerido ao lan√ßar ‚Äî opcional)</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-bottom:16px;" id="subPadraoGrid">
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;">
      <button class="btn btn-gy" onclick="fecharFormCadRef()">Cancelar</button>
      <button class="btn btn-gn" onclick="salvarCadRef()">‚úÖ SALVAR REFER√äNCIA</button>
    </div>
  </div>

  <!-- Filtro e listagem -->
  <div style="margin-bottom:12px;">
    <input class="fi" id="filtCadRef" type="text" placeholder="Buscar por refer√™ncia ou descri√ß√£o..." oninput="renderCadastroRefs()" style="max-width:380px;">
  </div>
  <div id="cadRefLista"></div>
</div>

<!-- REFER√äNCIAS -->
<div class="page" id="page-referencias">
  <div style="margin-bottom:14px;">
    <div class="fl">Buscar refer√™ncia bruta ou descri√ß√£o</div>
    <input class="fi" id="filtRef" type="text" placeholder="Ex: FAN-0118 ou anel..." oninput="renderReferencias()" style="margin-top:5px;">
  </div>
  <div id="refLista"></div>
</div>

<!-- QUEBRAS -->
<div class="page" id="page-quebras">
  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:flex-end;">
    <div class="fg" style="flex:1;min-width:140px;"><div class="fl">Filtrar refer√™ncia</div>
      <input class="fi" id="filtQbrRef" type="text" placeholder="Refer√™ncia..." oninput="renderQuebras()"></div>
    <div class="fg" style="min-width:180px;"><div class="fl">Filtrar processo</div>
      <select class="fi" id="filtQbrProc" onchange="renderQuebras()">
        <option value="">Todos</option>
        <option>FILA IMPRESS√ÉO</option><option>IMPRESS√ÉO 3D</option><option>LIMPEZA DE CERA X SUPORTE</option>
        <option>CRAVA√á√ÉO CERA</option><option>MONTAGEM √ÅRVORE</option><option>FUNDI√á√ÉO</option>
        <option>REVIS√ÉO BRUTO</option><option>CORTE DE √ÅRVORE</option><option>LIXA</option><option>ACABAMENTO AUTOM√ÅTICO</option>
        <option>SOLDA</option><option>MONTAGEM</option><option>CRAVA√á√ÉO METAL</option><option>ENVIADO PARA REVIS√ÉO</option>
      </select></div>
    <button class="btn btn-gy" onclick="exportarQbrCSV()">‚¨á Exportar CSV</button>
  </div>
  <div class="g2" style="margin-bottom:20px;" id="qbrKpis"></div>
  <div class="sec">Quebra por Refer√™ncia √ó Processo</div>
  <div class="tbl-wrap" style="margin-bottom:20px;">
    <table><thead><tr><th>Refer√™ncia</th><th>Descri√ß√£o</th><th>Processo</th><th>Sub Processo</th><th>Entrada</th><th>Sa√≠da</th><th>Quebra</th><th>% Quebra</th><th>Motivo Principal</th><th>A√ß√£o</th></tr></thead>
    <tbody id="qbrTbl"></tbody></table>
  </div>
  <div class="sec">Ranking de Quebra por Processo</div>
  <div id="qbrRanking"></div>
  <div class="sec" style="margin-top:20px;">üìà Tend√™ncia de Quebras por Semana</div>
  <div class="chart-wrap" style="margin-bottom:20px;"><canvas id="chartTendencia" height="90"></canvas></div>
  <div class="sec">üîÅ Hist√≥rico de Retrabalhos Gerados</div>
  <div id="rtHistorico"></div>
</div>

<!-- DASHBOARD -->
<div class="page" id="page-dashboard">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
    <span style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;">Per√≠odo:</span>
    <button class="btn dash-periodo-btn active" id="dashBtnHoje"   onclick="setDashPeriodo('hoje')"   style="padding:6px 14px;font-size:12px;">Hoje</button>
    <button class="btn dash-periodo-btn"        id="dashBtnSemana" onclick="setDashPeriodo('semana')" style="padding:6px 14px;font-size:12px;">Semana</button>
    <button class="btn dash-periodo-btn"        id="dashBtnMes"    onclick="setDashPeriodo('mes')"    style="padding:6px 14px;font-size:12px;">M√™s</button>
    <button class="btn dash-periodo-btn"        id="dashBtnTudo"   onclick="setDashPeriodo('tudo')"   style="padding:6px 14px;font-size:12px;">Tudo</button>
    <span id="dashPeriodoLabel" style="font-size:11px;color:var(--muted);margin-left:4px;"></span>
  </div>
  <div class="g4" style="margin-bottom:20px;" id="dashKpis"></div>
  <div class="g2" style="margin-bottom:20px;">
    <div>
      <div class="sec">‚è∞ Prazo de Entrega ‚Äî Ordens em Risco</div>
      <div class="tbl-wrap">
        <table><thead><tr><th>N¬∫ Ordem</th><th>Refer√™ncia</th><th>Prazo</th><th>Dias restantes</th><th>Previs√£o Conclus√£o</th><th>Etapa Atual</th><th>Status</th></tr></thead>
        <tbody id="dashPrazo"></tbody></table>
      </div>
    </div>
    <div>
      <div class="sec">üè≠ Capacidade Produtiva por Processo</div>
      <div id="dashCapac"></div>
    </div>
  </div>
  <div class="g2" style="margin-bottom:20px;">
    <div>
      <div class="sec">üéØ Metas do Dia por Processo</div>
      <div id="dashMetas"></div>
    </div>
    <div>
      <div class="sec">üîÑ Comparativo por Turno</div>
      <div id="dashTurnos"></div>
    </div>
  </div>
  <div class="sec">Vis√£o Geral ‚Äî Todas as Ordens</div>
  <div class="tbl-wrap">
    <table><thead><tr><th>N¬∫ Ordem</th><th>Refer√™ncia</th><th>Descri√ß√£o</th><th>Qtde</th><th>Prioridade</th><th>Prazo</th><th>Previs√£o</th><th>Etapa Atual</th><th>Avan√ßo</th><th>% Quebra</th><th>Status</th></tr></thead>
    <tbody id="dashGeral"></tbody></table>
  </div>
</div>

<!-- HIST√ìRICO -->
<div class="page" id="page-historico">
  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:flex-end;">
    <div class="fg" style="flex:1;min-width:130px;"><div class="fl">N¬∫ Ordem / Ref.</div><input class="fi" id="hFiltOrdem" type="text" oninput="renderHistorico()"></div>
    <div class="fg" style="min-width:160px;"><div class="fl">Processo</div>
      <select class="fi" id="hFiltProc" onchange="renderHistorico()">
        <option value="">Todos</option>
        <option>FILA IMPRESS√ÉO</option><option>IMPRESS√ÉO 3D</option><option>LIMPEZA DE CERA X SUPORTE</option>
        <option>CRAVA√á√ÉO CERA</option><option>MONTAGEM √ÅRVORE</option><option>FUNDI√á√ÉO</option>
        <option>REVIS√ÉO BRUTO</option><option>CORTE DE √ÅRVORE</option><option>LIXA</option><option>ACABAMENTO AUTOM√ÅTICO</option>
        <option>SOLDA</option><option>MONTAGEM</option><option>CRAVA√á√ÉO METAL</option><option>ENVIADO PARA REVIS√ÉO</option>
      </select></div>
    <div class="fg" style="min-width:120px;"><div class="fl">Colaborador</div><input class="fi" id="hFiltColab" type="text" oninput="renderHistorico()"></div>
    <div class="fg" style="min-width:110px;"><div class="fl">Turno</div>
      <select class="fi" id="hFiltTurno" onchange="renderHistorico()"><option value="">Todos</option><option>MANH√É</option><option>TARDE</option><option>NOITE</option></select></div>
    <div class="fg" style="min-width:120px;"><div class="fl">Data in√≠cio</div><input class="fi" id="hFiltDtIni" type="date" onchange="renderHistorico()"></div>
    <div class="fg" style="min-width:120px;"><div class="fl">Data fim</div><input class="fi" id="hFiltDtFim" type="date" onchange="renderHistorico()"></div>
    <div style="display:flex;gap:6px;align-items:flex-end;">
      <button class="btn btn-gy" style="padding:8px 10px;font-size:11px;" onclick="filtrarHistoricoHoje()">Hoje</button>
      <button class="btn btn-gy" style="padding:8px 10px;font-size:11px;" onclick="filtrarHistoricoSemana()">Semana</button>
      <button class="btn btn-gy" onclick="exportarCSV()">‚¨á CSV</button>
    </div>
  </div>
  <div id="histResumo" style="display:none;background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2);border-radius:8px;padding:10px 14px;margin-bottom:10px;font-size:12px;font-weight:700;color:#93c5fd;"></div>
  <div class="tbl-wrap">
    <table><thead><tr><th>Data/Hora</th><th>N¬∫ Ordem</th><th>Refer√™ncia</th><th>Processo</th><th>Sub Proc.</th><th>Colaborador</th><th>Turno</th><th>Entrada</th><th>Sa√≠da</th><th>Quebra</th><th>P√ß/h</th><th>Motivo</th><th>H.Ini</th><th>H.Fim</th><th>Obs</th></tr></thead>
    <tbody id="histTbl"></tbody></table>
  </div>
  <div style="margin-top:14px;">
    <div class="sec">üìã Log de Auditoria</div>
    <div id="auditLog" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;max-height:300px;overflow-y:auto;"></div>
  </div>
</div>

<!-- COLABORADORES -->
<div class="page" id="page-colaboradores">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">üë• Gest√£o de Colaboradores</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Cadastro, turno, processos e ranking de produtividade</div>
    </div>
    <button class="btn btn-gn" onclick="abrirModal('novo-colab')">+ Cadastrar Colaborador</button>
  </div>
  <div class="g3" style="margin-bottom:20px;" id="colabKpis"></div>
  <div class="sec">Ranking de Produtividade</div>
  <div id="colabRanking"></div>
</div>

<!-- METAL -->

<!-- √ÅRVORES DE FUNDI√á√ÉO -->
<div class="page" id="page-arvores">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">üå≥ √Årvores de Fundi√ß√£o</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Bipe as ordens ‚Üí calcule o cadinho ‚Üí gere a etiqueta do tubo</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-yw" style="font-size:12px;padding:7px 13px;" onclick="novoCicloFund()">üîÑ Novo Ciclo</button>
      <button class="btn btn-gn" style="font-size:12px;padding:7px 13px;" onclick="abrirModal('nova-arvore')">+ Nova √Årvore</button>
    </div>
  </div>

  <!-- KPIs ciclo atual -->
  <div class="g4" id="arvoreKpis" style="margin-bottom:16px;"></div>

  <!-- Lista de √°rvores do ciclo -->
  <div id="arvoreLista"></div>
</div>

<div class="page" id="page-metal">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
    <div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">‚öóÔ∏è Controle de Metal</div>
      <div style="font-size:12px;color:var(--muted);margin-top:3px;">Entrada ‚Üí Processo ‚Üí Sucata ‚Üí Recuperadora ‚Üí Fechamento Real</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-rd" style="font-size:12px;padding:7px 13px;" onclick="abrirModal('nova-sucata')">üóë Lan√ßar Sucata</button>
      <button class="btn btn-bl" style="font-size:12px;padding:7px 13px;" onclick="abrirModal('retorno-metal')">‚ôªÔ∏è Retorno Recuperadora</button>
      <button class="btn btn-gy" onclick="exportarMetalCSV()">‚¨á CSV</button>
    </div>
  </div>
  <div id="metalKpis" class="g4" style="margin-bottom:14px;"></div>
  <div id="metalAlertas" style="margin-bottom:14px;"></div>
  <div id="metalFechamento" style="margin-bottom:20px;"></div>
  <div id="metalConsumoPanel" style="margin-bottom:20px;"></div>
  <div class="g2" style="margin-bottom:20px;gap:16px;">
    <div>
      <div class="sec">üìä Por Tipo de Metal</div>
      <div id="metalPorTipo"></div>
    </div>
    <div>
      <div class="sec">üè≠ Perda por Processo</div>
      <div id="metalPorProcesso"></div>
    </div>
  </div>
  <div style="margin-bottom:20px;">
    <div class="sec" style="display:flex;justify-content:space-between;align-items:center;">
      <span>üóë Sucatas Enviadas para Recupera√ß√£o</span>
      <button class="btn btn-rd" style="font-size:11px;padding:4px 12px;" onclick="abrirModal('nova-sucata')">+ Lan√ßar</button>
    </div>
    <div id="metalSucatasList"></div>
  </div>
  <div style="margin-bottom:20px;">
    <div class="sec" style="display:flex;justify-content:space-between;align-items:center;">
      <span>‚ôªÔ∏è Retornos da Recuperadora</span>
      <button class="btn btn-bl" style="font-size:11px;padding:4px 12px;" onclick="abrirModal('retorno-metal')">+ Lan√ßar</button>
    </div>
    <div id="metalRetornosList"></div>
  </div>
  <div class="sec">üìã Lan√ßamentos por Ordem/Processo</div>
  <div style="margin-bottom:10px;display:flex;gap:10px;flex-wrap:wrap;">
    <input class="fi" id="filtMetalOrdem" type="text" placeholder="Filtrar por ordem ou refer√™ncia..." oninput="renderMetal()" style="max-width:280px;">
    <select class="fi" id="filtMetalTipo" onchange="renderMetal()" style="max-width:160px;">
      <option value="">Todos os metais</option>
      <option>LAT√ÉO</option><option>PRATA</option><option>OURO</option><option>OUTRO</option>
    </select>
  </div>
  <div class="tbl-wrap">
    <table><thead><tr>
      <th>Data</th><th>N¬∫ Ordem</th><th>Refer√™ncia</th><th>Processo</th>
      <th>Tipo</th><th>Entrada (g)</th><th>Sa√≠da (g)</th><th>Perda (g)</th><th>% Perda</th>
    </tr></thead>
    <tbody id="metalTbl"></tbody></table>
  </div>
</div>

<!-- CONFIG -->
<div class="page" id="page-config">
  <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;margin-bottom:20px;">‚öôÔ∏è Configura√ß√µes</div>
  <div class="g2" style="gap:20px;">
    <div>
      <div class="sec">üéØ Metas de Produ√ß√£o por Processo</div>
      <div id="configMetas"></div>
    </div>
    <div>
      <div class="sec">üíæ Backup & Restaura√ß√£o</div>
      <div class="backup-section">
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">O sistema salva no navegador (localStorage). Use o backup para n√£o perder dados se limpar o cache.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button class="btn btn-gn" onclick="exportarBackup()">‚¨á Exportar Backup JSON</button>
          <label class="btn btn-bl" style="cursor:pointer;">‚¨Ü Importar Backup <input type="file" accept=".json" style="display:none" onchange="importarBackup(this)"></label>
        </div>
        <div id="backupInfo" style="font-size:11px;color:var(--muted);"></div>
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
          <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px;">‚ö†Ô∏è Zona de Risco</div>
          <button class="btn btn-rd" onclick="confirmarLimparDados()" style="font-size:12px;padding:7px 14px;">üóë Limpar Todos os Dados</button>
        </div>
      </div>
    </div>

  <!-- TOLER√ÇNCIAS DE QUEBRA POR PROCESSO -->
  <div style="margin-top:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div class="sec" style="margin-bottom:0;">‚ö†Ô∏è Toler√¢ncias de Quebra de Metal por Processo</div>
      <button class="btn btn-gn" style="font-size:12px;padding:7px 14px;" onclick="salvarTolerancia()">üíæ Salvar Toler√¢ncias</button>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.7;">
      Defina a quebra m√°xima tolerada (%) para cada processo com uso de metal. O sistema alertar√° automaticamente quando uma ordem ultrapassar esses limites na aba ‚öóÔ∏è Metal.
      <br>Dica: comece com valores conservadores (ex: FUNDI√á√ÉO 3%, LIXA 1%) e ajuste conforme hist√≥rico da f√°brica.
    </p>
    <div id="configToleranciaGrid"></div>
    <div style="margin-top:14px;padding:12px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:8px;">
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px;">üìä Como √© calculado</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.7;">
        Para cada lan√ßamento com metal, o sistema calcula <strong style="color:var(--text)">% perda = (perda √∑ entrada) √ó 100</strong>.
        Se ultrapassar o limite configurado, um alerta vermelho aparece na aba ‚öóÔ∏è Metal identificando a ordem e o processo.
        Ordens sem entrada de metal n√£o geram alerta.
      </div>
    </div>
  </div>

  </div>
</div>

<!-- MODO ESC√ÇNER FULLSCREEN -->
<div id="page-scanner">
  <div class="scanner-header">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;">üì° MODO ESC√ÇNER</div>
    <div id="scannerTurnoInfo" style="font-size:12px;color:var(--muted);"></div>
    <button class="btn btn-gy" style="padding:6px 14px;font-size:12px;" onclick="fecharScanner()">‚úï Fechar</button>
  </div>
  <div class="scanner-body">
    <!-- Campo de scan -->
    <div>
      <div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;">üì° Bipe ou digite o N¬∫ da ordem</div>
      <input class="scanner-input-big" id="scannerInput" type="text" placeholder="‚Üí BIPE AQUI ‚Üê" autocomplete="off"
             onkeydown="if(event.key==='Enter')scannerBuscar()">
    </div>

    <!-- Card da ordem encontrada -->
    <div class="scanner-card" id="scannerCard" style="display:none;">
      <div id="scannerOrdemInfo" style="margin-bottom:12px;"></div>

      <!-- Grade de processos -->
      <div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;">Selecione o processo</div>
      <div class="scanner-proc-grid" id="scannerProcGrid"></div>

      <!-- Form de lan√ßamento (aparece ao selecionar processo) -->
      <div id="scannerFormBox" style="display:none;margin-top:14px;border-top:1px solid var(--border);padding-top:14px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--accent);margin-bottom:12px;" id="scannerProcLabel"></div>
        <!-- Sub-processo (se houver) -->
        <div id="scannerSubRow" style="display:none;margin-bottom:10px;">
          <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:5px;">Sub-processo</div>
          <select class="fi" id="scannerSub"></select>
        </div>
        <!-- Qtd Entrada / Sa√≠da -->
        <div class="scanner-qtd-row">
          <div class="scanner-qbox">
            <label>Entrada</label>
            <input type="number" id="scannerEnt" min="0" placeholder="0" oninput="scannerAutoQbr()">
          </div>
          <div class="scanner-qbox">
            <label>Sa√≠da ‚úÖ</label>
            <input type="number" id="scannerSai" min="0" placeholder="0" style="color:var(--green);" oninput="scannerAutoQbr()">
          </div>
        </div>
        <div id="scannerQbrInfo" style="display:none;text-align:center;font-size:13px;font-weight:800;color:var(--red);margin-top:6px;"></div>
        <!-- Colaborador -->
        <div style="margin-top:10px;">
          <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:5px;">Colaborador *</div>
          <select class="fi" id="scannerColab"></select>
        </div>
        <!-- Bot√µes -->
        <div style="display:flex;gap:8px;margin-top:14px;">
          <button class="btn btn-gn" style="flex:1;padding:14px;font-size:16px;" onclick="scannerLancar()">‚úÖ CONFIRMAR</button>
          <button class="btn btn-gy" style="padding:14px 16px;" onclick="scannerCancelarProc()">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Feedback toast interno -->
    <div id="scannerFeedback" style="display:none;border-radius:10px;padding:14px 18px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;text-align:center;"></div>
  </div>
</div>


<!-- MODAL NOVA √ÅRVORE -->
<script id="tplNovaArvore" type="text/x-template">
<div style="max-width:600px;">
  <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
    üå≥ Nova √Årvore de Fundi√ß√£o
  </div>

  <!-- Metal -->
  <div class="g2" style="margin-bottom:14px;">
    <div class="fg">
      <div class="fl">Metal</div>
      <select class="fi" id="arvMetal" onchange="onArvMetalChange()">
        <option value="prata">ü•à Prata 925</option>
        <option value="latao">üü° Lat√£o</option>
      </select>
    </div>
    <div class="fg">
      <div class="fl">N¬∫ da √Årvore</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input class="fi" id="arvNr" type="number" min="1" max="200" style="font-size:22px;font-weight:900;text-align:center;color:var(--accent);" readonly>
        <span style="font-size:10px;color:var(--muted);line-height:1.4;">gerado<br>auto</span>
      </div>
    </div>
  </div>

  <!-- Fator -->
  <div class="fg" style="margin-bottom:14px;">
    <div class="fl">Fator de Convers√£o Cera ‚Üí Metal</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <input class="fi" id="arvFator" type="number" step="0.01" style="width:100px;text-align:center;font-size:18px;font-weight:700;">
      <span style="color:var(--muted);font-size:13px;">√ó (padr√£o: Prata=10,0 / Lat√£o=9,0)</span>
    </div>
  </div>

  <!-- Bipe de ordens -->
  <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
    <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:10px;">üì° Bipe as Ordens desta √Årvore</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <input class="fi" id="arvBipeInput" type="text" placeholder="‚Üí Bipe ou digite o N¬∫ da ordem" style="flex:1;" onkeydown="if(event.key==='Enter')adicionarOrdemArvore()">
      <button class="btn btn-bl" onclick="adicionarOrdemArvore()" style="padding:8px 14px;font-size:13px;">+ Add</button>
    </div>
    <div id="arvOrdensList" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto;"></div>
    <div id="arvOrdensEmpty" style="font-size:12px;color:var(--muted);text-align:center;padding:12px;">Nenhuma ordem adicionada</div>
  </div>

  <!-- Totais calculados -->
  <div id="arvTotais" style="display:none;margin-bottom:14px;">
    <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;">üìä Resumo</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:10px;color:var(--muted);">Ordens</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;" id="arvTotOrdens">0</div>
      </div>
      <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:10px;color:var(--muted);">Total Pe√ßas</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;" id="arvTotPecas">0</div>
      </div>
      <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:10px;text-align:center;">
        <div style="font-size:10px;color:var(--muted);">Pedras (total)</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--accent);" id="arvTotPedras">0g</div>
      </div>
    </div>
  </div>

  <!-- Peso cera -->
  <div class="fg" style="margin-bottom:14px;">
    <div class="fl">Peso da √Årvore em Cera (g)</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <input class="fi" id="arvPesoCera" type="number" step="0.01" placeholder="0,00" oninput="calcArvore()" style="font-size:20px;font-weight:700;">
      <div id="arvPesoEspDisplay" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;color:var(--muted);line-height:1.5;min-width:120px;"></div>
    </div>
  </div>

  <!-- Bot√µes -->
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button class="btn btn-gn" onclick="salvarArvore()" style="flex:1;">‚úÖ Criar √Årvore</button>
    <button class="btn btn-bl" onclick="imprimirEtiquetaArvore()" style="flex:1;">üñ® Imprimir Etiqueta</button>
    <button class="btn btn-gy" onclick="fecharModal()">Cancelar</button>
  </div>
</div>
</script>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modalContent"></div>
</div>
<div class="toast" id="toast"></div>
<div id="printArea"></div>

<script>
// ‚ïê‚ïê DADOS BASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROCESSOS = [
  {id:'01',nome:'FILA IMPRESS√ÉO',       subs:[], skipavel:false},
  {id:'02',nome:'IMPRESS√ÉO 3D',         subs:['400 NOVA','400 ANTIGA','410','530'], skipavel:false},
  {id:'03',nome:'LIMPEZA DE CERA X SUPORTE',subs:[], skipavel:false},
  {id:'04',nome:'CRAVA√á√ÉO CERA',        subs:['AUTOM√ÅTICA','MANUAL','REVIS√ÉO DA CRAVA√á√ÉO'], skipavel:true},
  {id:'05',nome:'MONTAGEM √ÅRVORE',      subs:[], skipavel:false},
  {id:'06',nome:'FUNDI√á√ÉO',             subs:['JITO'], skipavel:false},
  {id:'07',nome:'REVIS√ÉO BRUTO',        subs:[], skipavel:false, temQuebraDetalhada:true},
  {id:'08',nome:'CORTE DE √ÅRVORE',      subs:[], skipavel:false},
  {id:'09',nome:'LIXA',                 subs:['LIXA INTERNA','LIXA EXTERNA','LIXA ESTRELA','JITO','RODA','CHICOTE','POLIMENTO'], skipavel:false},
  {id:'10',nome:'ACABAMENTO AUTOM√ÅTICO',subs:['CHIPAGEM','COMPLETO','POLIMENTO'], skipavel:true},
  {id:'11',nome:'SOLDA',                subs:['LASER','FOGO'], skipavel:true},
  {id:'12',nome:'MONTAGEM',             subs:['SIMPLES','COMPLEXA'], skipavel:true},
  {id:'13',nome:'CRAVA√á√ÉO METAL',       subs:['CRAVA√á√ÉO MANUAL','CRAVA√á√ÉO AUTOM√ÅTICA','REVIS√ÉO DA CRAVA√á√ÉO','CRAVA√á√ÉO PEDRA MAIOR','REPOSI√á√ÉO PEDRAS','PEDRA MAIOR'], skipavel:true},
  {id:'14',nome:'ENVIADO PARA REVIS√ÉO', subs:['REPOSI√á√ÉO PEDRAS','REVIS√ÉO DA CRAVA√á√ÉO','FINALIZADO'], skipavel:false}
];
// Processos produtivos reais ‚Äî exclui a FILA IMPRESS√ÉO (automatica)
// Usado em todos os calculos de conclusao e progresso
const PROCESSOS_REAIS = PROCESSOS.filter(p=>p.nome!=='FILA IMPRESS√ÉO');
const N_PROC = PROCESSOS_REAIS.length; // 13

// Helper central: verifica se uma ordem est√° conclu√≠da
// Considera que ENVIADO PARA REVIS√ÉO com sub=FINALIZADO √© necess√°rio para fechar
function isOrdemConcluida(lans){
  const done=new Set(lans.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc));
  return PROCESSOS_REAIS.every(p=>done.has(p.nome)||p.skipavel);
}
// Calcula progresso real (0-N_PROC) de uma lista de lan√ßamentos
function calcProgresso(lans){
  return new Set(lans.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc)).size;
}

const COLABORADORES_CATALOGO = [
  {matricula:"3393",nome:"FELIPE BORTOLINI",ativo:true},
  {matricula:"3579",nome:"AMANDA DE OLIVEIRA SILVA",ativo:true},
  {matricula:"1860",nome:"DEISE XAVIER CRUZ",ativo:true},
  {matricula:"1208",nome:"JANAINA AGUIAR GONCALVES",ativo:true},
  {matricula:"3451",nome:"MARIA CARLA FRANCA FONTES",ativo:true},
  {matricula:"3519",nome:"ANDERSON RIBEIRO GOES",ativo:true},
  {matricula:"2041",nome:"CRISTIANO FELIPE M DA SILVA",ativo:true},
  {matricula:"3313",nome:"MATHEUS COSTA GOMES PEREIRA",ativo:true},
  {matricula:"3348",nome:"MICHEL LOPES ABEL",ativo:true},
  {matricula:"1400",nome:"ROBERT RODRIGO ALVES",ativo:true},
  {matricula:"3242",nome:"SAMUEL EVANGELISTA DE S JUNIOR",ativo:true},
  {matricula:"3453",nome:"JULIANA SANTOS MIRANDA",ativo:true},
  {matricula:"1705",nome:"DANIELE SOUZA DE OLIVEIRA",ativo:true},
  {matricula:"3517",nome:"MARIA JOSE DO S A NASCIMENTO",ativo:true},
  {matricula:"3435",nome:"RIAN HENRIQUE COSTA",ativo:true},
  {matricula:"3521",nome:"JALMACIRA BEZERRA R DA SILVA",ativo:true},
  {matricula:"3516",nome:"JANAINA B MAXIMINO DA SILVA",ativo:true},
  {matricula:"3431",nome:"MARIA EDUARDA M FRANCISCO",ativo:true},
  {matricula:"3520",nome:"MARINA DE SOUSA CAMPOS",ativo:true},
  {matricula:"13",nome:"GABRIELA DOS SANTOS MAGALHAES",ativo:true},
  {matricula:"3454",nome:"GLENIA LIZIANE MENDES ARANTES",ativo:true},
  {matricula:"1771",nome:"ELAINE EVANGELISTA N LEAL",ativo:true},
  {matricula:"713",nome:"JOELMA MARIA DOS SANTOS",ativo:true},
  {matricula:"3671",nome:"RAYSSA GONCALVES MATOS",ativo:true},
  {matricula:"3738",nome:"ANDRE LUIZ SANTOS FERRAZ",ativo:true},
  {matricula:"3674",nome:"BRUNA SILVA RIOS",ativo:true},
  {matricula:"3535",nome:"CRISTIANE C DA SILVA SANTANA",ativo:true},
  {matricula:"3580",nome:"EDNA DE ANDRADE ROSENDO",ativo:true},
  {matricula:"3672",nome:"FERNANDA CAVALCANTE DOS SANTOS",ativo:true},
  {matricula:"3523",nome:"FLAVIANE MACARIO BRAGA",ativo:true},
  {matricula:"1772",nome:"FRANCISCA ROSIANE DAMASO",ativo:true},
  {matricula:"3742",nome:"GABRIELLY AP R DOS SANTOS",ativo:true},
  {matricula:"3610",nome:"JEOVA BENTO DOS SANTOS JUNIOR",ativo:true},
  {matricula:"199",nome:"JOANES CARNEIRO DE CARVALHO",ativo:true},
  {matricula:"3335",nome:"JOSE CARLOS DA ROCHA SILVA",ativo:true},
  {matricula:"3744",nome:"KAIQUE JORGE DOMINGUES",ativo:true},
  {matricula:"3334",nome:"KLEBER ALISSON FERNANDES ROSA",ativo:true},
  {matricula:"1153",nome:"LEIDIANE DA CRUZ SOUZA",ativo:true},
  {matricula:"3350",nome:"LUCAS CARDOSO DA SILVA",ativo:true},
  {matricula:"171",nome:"MEIRE DE JESUS CAMARGO",ativo:true},
  {matricula:"2083",nome:"RAYANE DOS SANTOS BARBOSA",ativo:true},
  {matricula:"3614",nome:"RYAN HENRIQUE DA SILVA GOMES",ativo:true},
  {matricula:"1773",nome:"SHIRLEIY PRATES MARTINS",ativo:true},
  {matricula:"1774",nome:"SUZANA NATALIA CLEMENTE XAVIER",ativo:true},
  {matricula:"3456",nome:"THAMIRES CARVALHO AGUILAR",ativo:true},
  {matricula:"3433",nome:"RHUAN SOUZA DE FREITAS",ativo:true},
  {matricula:"1391",nome:"VANESSA LUCIA DA SILVA ALVES",ativo:true}
];

const CATALOGO = [
  {"ref":"FAN-0118","refAcabada":"513426","desc":"ANEL LAT√ÉO","produto":"Anel alian√ßa m√©dia com mickey vazados ao redor do aro","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Def. na textura","impressora":"410","cravacaoCera":"AUTOM√ÅTICA","lixa":"LIXA EXTERNA","acabamento":"CHIPAGEM","solda":"LASER","montagem":"SIMPLES","cravacaoMetal":"REPOSI√á√ÉO PEDRAS"},
  {"ref":"FAN-0141","refAcabada":"513623","desc":"ANEL LAT√ÉO","produto":"ANEL ARO FINO FORMADO POR INFINITOS","prioridade":"URG√äNTE","tipoLote":"RECUPERAVEL","defeito":"Furo/Corte","impressora":"400 NOVA","cravacaoCera":"MANUAL","lixa":"LIXA INTERNA","acabamento":"POLIMENTO","solda":"FOGO","montagem":"COMPLEXA","cravacaoMetal":"PEDRA MAIOR"},
  {"ref":"FAN-0154","refAcabada":"513651","desc":"ANEL LAT√ÉO","produto":"ANEL FORMADO POR DOIS FIOS INTRELA√áADO","prioridade":"CRIT√çCO","tipoLote":"RETRABALHO","defeito":"Poroso","impressora":"400ANTIGA","cravacaoCera":"REVIS√ÉO DA CRAVA√á√ÉO","lixa":"LIXA ESTRELA","acabamento":"COMPLETO","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0106","refAcabada":"527226","desc":"BRINCO LAT√ÉO","produto":"Brinco solit√°rio cara do Mickey abaulado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Sem solda ou excesso","impressora":"530","cravacaoCera":"","lixa":"JITO","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0105","refAcabada":"527228","desc":"BRINCO LAT√ÉO","produto":"Brinco cara da Minnie cravejada com tr√™s zirc√¥nias","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Sem pedra e Defeito na pedra","impressora":"","cravacaoCera":"","lixa":"RODA","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0115","refAcabada":"527294","desc":"BRINCO LAT√ÉO","produto":"Brinco base pedra solit√°ria com rosa chapa lisa pendurada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Amassado","impressora":"","cravacaoCera":"","lixa":"CHICOTE","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0123","refAcabada":"527350","desc":"BRINCO LAT√ÉO","produto":"Brinco Minnie baby cravejada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Quebrado","impressora":"","cravacaoCera":"","lixa":"POLIMENTO","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0147","refAcabada":"527533","desc":"BRINCO LAT√ÉO","produto":"Brinco chapa gata Marie para aplica√ß√£o de resina","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"M√° forma√ß√£o","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0144","refAcabada":"527534","desc":"BRINCO LAT√ÉO","produto":"Brinco pata da gata Marie para aplica√ß√£o de resina","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Excesso de fundi√ß√£o","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0145","refAcabada":"527535","desc":"BRINCO LAT√ÉO","produto":"Brinco la√ßo de pedra de cora√ß√£o","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Esfera dentro","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0146","refAcabada":"527536","desc":"BRINCO LAT√ÉO","produto":"Brinco argola pequena com detalhes de cora√ß√µes com la√ßo de pedra de cora√ß√£o pendurado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Mancha","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0148","refAcabada":"527597","desc":"BRINCO LAT√ÉO","produto":"Brinco pequeno formato borboleta cravejada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Marca de impress√£o","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBR-0140","refAcabada":"527606","desc":"BRINCO LAT√ÉO","produto":"Brinco gota lisa com tam GG 25mm com pedra cravejada no centro","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Grade errada / Grava√ß√£o incorreta","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPG-0139","refAcabada":"532626","desc":"PINGENTE LAT√ÉO","produto":"Pingente espirito santo com malha embitida atr√°s","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Pe√ßa misturada","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPG-0131","refAcabada":"542949","desc":"PINGENTE LAT√ÉO","produto":"Berloque cavalo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"Sem acess√≥rio","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPG-0142","refAcabada":"542989","desc":"PINGENTE LAT√ÉO","produto":"Pingente cora√ß√£o gande prote√ß√£o, com desenhos de olho grego, infinito, pimenta, ferradura e trevo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"SEM CONTRASTE","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0065","refAcabada":"810377","desc":"ANEL PRATA","produto":"Anel formado por cora√ß√µes","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"SOBRA","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0027","refAcabada":"810382","desc":"ANEL PRATA","produto":"Anel aparador todo cravejado CRISTAL","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0069","refAcabada":"810388","desc":"ANEL PRATA","produto":"Anel formado por estrela do mar","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0054","refAcabada":"810389","desc":"ANEL PRATA","produto":"ANEL ARO FINO COM PARTE DE CIMA COM BORBOLETA VAZADA COM DETALHES DE BOLINHAS E DUAS BORBOLETAS LISAS NAS LATERAIS","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0049","refAcabada":"810390","desc":"ANEL PRATA","produto":"Anel parte de cima oval com pedra oval no centro e bordas cravejadas com duas fileiras","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0003","refAcabada":"810391","desc":"ANEL PRATA","produto":"Anel borboleta cravejada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0087","refAcabada":"810394","desc":"ANEL PRATA","produto":"Anel aro fino com pedra cushion no centro e laterais cravejadas formando um tri√¢ngulo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0042","refAcabada":"810395","desc":"ANEL PRATA","produto":"ANEL COM A CABE√áA OVAL E PARTE DE CIMA CRAVEJADA","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0006","refAcabada":"810396","desc":"ANEL PRATA","produto":"Anel com lateral dupla e crava√ß√µes estilizadas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0025","refAcabada":"810397","desc":"ANEL PRATA","produto":"Anel pedra cora√ß√£o no centro com zirc√¥nias cravejadas ao redor","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0017","refAcabada":"810398","desc":"ANEL PRATA","produto":"Anel formado por tr√™s aros separados com pedras de formatos redondo e gota e no centro navete cravejada.","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0070","refAcabada":"810399","desc":"ANEL PRATA","produto":"Anel aparador formado por zirc√¥nias de 2,50mm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0110","refAcabada":"810400","desc":"ANEL PRATA","produto":"Anel estilo alian√ßa todo cravejado, no centro zirc. navete e nas laterais  redonda","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0092","refAcabada":"810401","desc":"ANEL PRATA","produto":"Anel aro quadrado fino com crava√ß√£o no centro e com detalhes curvados","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0108","refAcabada":"810402","desc":"ANEL PRATA","produto":"Anel estilo corda intrela√ßada com detalhes de bolinhas e nos centros pedra cravejada RUBY","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0119","refAcabada":"810402","desc":"ANEL PRATA","produto":"Anel estilo corda intrela√ßada com detalhes de bolinhas e nos centros pedra cravejada LONDON","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0145","refAcabada":"810403","desc":"ANEL PRATA","produto":"Anel crava√ß√£o em gota e com cora√ß√£o na frente","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0101","refAcabada":"810405","desc":"ANEL PRATA","produto":"Anel aro fino com estrela no centro cravejada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0079","refAcabada":"810406","desc":"ANEL PRATA","produto":"Anel aro fino com detalhes de bolinhas e cravejado em cima","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0063","refAcabada":"810407","desc":"ANEL PRATA","produto":"Anel grande estilo organico","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0036","refAcabada":"810409","desc":"ANEL PRATA","produto":"Anel alian√ßa fina com parafusos e parte vazada no meio, cravejado por inteiro no centro","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0084","refAcabada":"810410","desc":"ANEL PRATA","produto":"Anel com aro no centro liso meia cana e detalhes de bolinhas nas duas laterais","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0052","refAcabada":"810411","desc":"ANEL PRATA","produto":"Anel estilo riviera cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FANAG-0111","refAcabada":"810412","desc":"ANEL PRATA","produto":"Anel aro fino com crava√ß√£o nas laterais e parte de cima gota cravejada com galeria","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0006","refAcabada":"820154","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0008","refAcabada":"820225","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o pequeno","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0009","refAcabada":"820225","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o m√©dio","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0010","refAcabada":"820226","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o grande","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0030","refAcabada":"820228","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o liso vazado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0018","refAcabada":"820230","desc":"BRINCO PRATA","produto":"Brinco borboleta pequena de um lado liso e do outro cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0020","refAcabada":"820231","desc":"BRINCO PRATA","produto":"Brinco infinito meia cana","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0017","refAcabada":"820236","desc":"BRINCO PRATA","produto":"Brinco tervo com detalhes de bolinha","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0016","refAcabada":"820246","desc":"BRINCO PRATA","produto":"brinco estrela vazada na parte de tr√°s","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0045","refAcabada":"820247","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0046","refAcabada":"820253","desc":"BRINCO PRATA","produto":"Brinco gota com crava√ß√£o trilho, vazado atr√°s","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0044","refAcabada":"820259","desc":"BRINCO PRATA","produto":"Brinco artilulado formato cora√ß√£o","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0112","refAcabada":"820286","desc":"BRINCO PRATA","produto":"Brinco solit√°rio com 3 garras e pedra de 4mm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0086","refAcabada":"820294","desc":"BRINCO PRATA","produto":"Brinco argola formato oval abaulado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0034","refAcabada":"820297","desc":"BRINCO PRATA","produto":"Brinco argola pav√™ com tr√™s fileiras cravejadas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0083","refAcabada":"820301","desc":"BRINCO PRATA","produto":"Brinco estrela do mar","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0092","refAcabada":"820305","desc":"BRINCO PRATA","produto":"Brinco formado por fios intrela√ßados formando um circulo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0108","refAcabada":"820306","desc":"BRINCO PRATA","produto":"Brinco croissant","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0081","refAcabada":"820307","desc":"BRINCO PRATA","produto":"Brinco cora√ß√£o abaulado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0063","refAcabada":"820308","desc":"BRINCO PRATA","produto":"Brinco argola dupla sendo uma cravejada e a outra com detalhes de bolinhas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0080","refAcabada":"820309","desc":"BRINCO PRATA","produto":"Brinco argola pequena com crava√ß√£o pav√™ de 5 fileiras","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0101","refAcabada":"820310","desc":"BRINCO PRATA","produto":"Brinco oval com pedra oval no centro e bordas cravejadas com duas fileiras","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0035","refAcabada":"820311","desc":"BRINCO PRATA","produto":"Brinco argola pav√™ com cinco fileiras cravejadas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0011","refAcabada":"820312","desc":"BRINCO PRATA","produto":"BRINCO BORBOLETA CRAVEJADA","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0078","refAcabada":"820313","desc":"BRINCO PRATA","produto":"Brinco redondo formato pedra estilizado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0013","refAcabada":"820315","desc":"BRINCO PRATA","produto":"Brinco argola meia cana articulado pequena","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0026","refAcabada":"820316","desc":"BRINCO PRATA","produto":"Brinco argola meia cana articulado m√©dio","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0043","refAcabada":"820317","desc":"BRINCO PRATA","produto":"Brinco Earcuff folhas cravejadas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0061","refAcabada":"820318","desc":"BRINCO PRATA","produto":"Brinco era cuff com pino e fios intrela√ßadaos. Brinco de lado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0065","refAcabada":"820319","desc":"BRINCO PRATA","produto":"Brinco pedra cora√ß√£o 4x4 no centro com zirc√¥nias cravejadas ao redor","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0058","refAcabada":"820320","desc":"BRINCO PRATA","produto":"Brinco formado por base com pedras gota e redonda cravejadas e parte de baixo formato gota vazada e cravejada por pedras intercaladas de gora e redonda","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0145","refAcabada":"820321","desc":"BRINCO PRATA","produto":"Brinco gota com a ponta curvada e forro atr√°s","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0115","refAcabada":"820324","desc":"BRINCO PRATA","produto":"Brinco pequeno formato quadrado com detalhe sde bolinhas e no centro pedras cravejadas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0100","refAcabada":"820325","desc":"BRINCO PRATA","produto":"Brinco tartaruga","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0103","refAcabada":"820327","desc":"BRINCO PRATA","produto":"Brinco alongado estilo riviera cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0048","refAcabada":"820328","desc":"BRINCO PRATA","produto":"Brinco argola articulada meia cana m√©dia PP","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0076","refAcabada":"820329","desc":"BRINCO PRATA","produto":"Brinco parte de cima redonda e parte de baixo oval formato pedra estilizado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0173","refAcabada":"820330","desc":"BRINCO PRATA","produto":"Brinco gota","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0105","refAcabada":"820331","desc":"BRINCO PRATA","produto":"BRINCO ESTRELA QUATRO PONTAS CRAVEJADO","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0062","refAcabada":"820333","desc":"BRINCO PRATA","produto":"Brinco pneu com zirc√¥nias cravejadas no centro","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0175","refAcabada":"820336","desc":"BRINCO PRATA","produto":"Brinco solitario crava√ß√£o inglesa 4mm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FBRAG-0187","refAcabada":"820339","desc":"BRINCO PRATA","produto":"Brinco com base cora√ß√£o e parte de baixo crava√ß√£o em gota e com cora√ß√£o na frente","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0039","refAcabada":"830117","desc":"GARGANTILHA PRATA","produto":"Gargantilha gota com tilho cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0027","refAcabada":"830118","desc":"GARGANTILHA PRATA","produto":"Gargantilha estrela vazada nas laterais","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0095","refAcabada":"830142","desc":"GARGANTILHA PRATA","produto":"Acess√≥rio oval com pedra oval no centro e bordas cravejadas com duas fileiras, para gargantilha","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0082","refAcabada":"830143","desc":"GARGANTILHA PRATA","produto":"PINGENTE BORBOLETA CRAVEJADA","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0083","refAcabada":"830146","desc":"GARGANTILHA PRATA","produto":"Pingente pedra cora√ß√£o 4x4 no centro com zirc√¥nias cravejadas ao redor","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0069","refAcabada":"830154","desc":"GARGANTILHA PRATA","produto":"Gargantilha riviera formada por 3 camadas cravejada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0266","refAcabada":"830156","desc":"GARGANTILHA PRATA","produto":"Pingente ponto de luz 6mm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0109","refAcabada":"830157","desc":"GARGANTILHA PRATA","produto":"Pingente espirito santo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0122","refAcabada":"830162","desc":"GARGANTILHA PRATA","produto":"Pingente gota cravejada com galeria atr√°s","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0123","refAcabada":"830163","desc":"GARGANTILHA PRATA","produto":"Acess√≥rio formato pneu com zirc√¥nias cravejadas no centro, com lateral passante, para gargantilha","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0108","refAcabada":"830164","desc":"GARGANTILHA PRATA","produto":"Gargantilha de crava√ß√£o inglesa","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0031","refAcabada":"840068","desc":"PINGENTE PRATA","produto":"Pingente cora√ß√£o cravejado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0011","refAcabada":"840089","desc":"PINGENTE PRATA","produto":"Berloque cruz com contra argola","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0007","refAcabada":"840091","desc":"PINGENTE PRATA","produto":"Berloque Nossa Senhora cravejado com contra argola","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0004","refAcabada":"840094","desc":"PINGENTE PRATA","produto":"Berloque cora√ß√£o liso com contra argola","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0037","refAcabada":"840139","desc":"PINGENTE PRATA","produto":"Berloque Nossa Sra. Aparecida","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0035","refAcabada":"840140","desc":"PINGENTE PRATA","produto":"Berloque S√£o Bento","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0061","refAcabada":"840151","desc":"PINGENTE PRATA","produto":"Berloque casal com cora√ß√£o","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0114","refAcabada":"840179","desc":"PINGENTE PRATA","produto":"Pingente crucifixo","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0112","refAcabada":"840185","desc":"PINGENTE PRATA","produto":"Berloque estrela gordinha vazada na lateral","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0144","refAcabada":"840190","desc":"PINGENTE PRATA","produto":"Berloque batom e perfume","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0177","refAcabada":"840267","desc":"PINGENTE PRATA","produto":"Berloque donuts","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0243","refAcabada":"840276","desc":"PINGENTE PRATA","produto":"Berloque Gata Marie resinado","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0230","refAcabada":"840286","desc":"PINGENTE PRATA","produto":"Berloque escrita JESUS","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0198","refAcabada":"840294","desc":"PINGENTE PRATA","produto":"Berloque golfinho","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0232","refAcabada":"840295","desc":"PINGENTE PRATA","produto":"Berloque avi√£o 3D com contra argola pendurada","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0299","refAcabada":"840296","desc":"PINGENTE PRATA","produto":"Pingente rabo de baleia 13MM","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0314","refAcabada":"840299","desc":"PINGENTE PRATA","produto":"Berloque passante de morango para resinar","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0168","refAcabada":"840301","desc":"PINGENTE PRATA","produto":"Berloque vinho e ta√ßa","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0167","refAcabada":"840303","desc":"PINGENTE PRATA","produto":"Berloque ta√ßa de drink","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0253","refAcabada":"840305","desc":"PINGENTE PRATA","produto":"Pingente solit√°rio ponto de luz 5mm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0311","refAcabada":"840312","desc":"PINGENTE PRATA","produto":"Berloque formato de lim√£o","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0313","refAcabada":"840313","desc":"PINGENTE PRATA","produto":"Berloque cerejas para resinar","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0363","refAcabada":"840315","desc":"PINGENTE PRATA","produto":"Berloque formato de fatia de melancia","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0354","refAcabada":"840318","desc":"PINGENTE PRATA","produto":"Pingente com escrita M√£e PRATA","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0237","refAcabada":"840319","desc":"PINGENTE PRATA","produto":"Berloque rosa","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0328","refAcabada":"840326","desc":"PINGENTE PRATA","produto":"Berloque formato de trofeu","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FPAG-0209","refAcabada":"840327","desc":"PINGENTE PRATA","produto":"Berloque chaveiro carro com controle e chave","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0112","refAcabada":"850114","desc":"PULSEIRA PRATA","produto":"Pulseira formada por esferas lisas de 3,5mm - 20cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0102","refAcabada":"850117","desc":"PULSEIRA PRATA","produto":"Pulseira riviera crava√ß√£o inglesa 16cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0089","refAcabada":"850118","desc":"PULSEIRA PRATA","produto":"Pulseira riviera crava√ß√£o inglesa","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0061","refAcabada":"850123","desc":"PULSEIRA PRATA","produto":"Pulseira Riviera grossa cravejada 19cm- 80 fileiras","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0130","refAcabada":"850123","desc":"PULSEIRA PRATA","produto":"Pulseira Riviera grossa cravejada 17cm - com 72 filairas","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0131","refAcabada":"850123","desc":"PULSEIRA PRATA","produto":"Pulseira Riviera grossa cravejada 18cm- 76 fileiras","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0118","refAcabada":"850124","desc":"PULSEIRA PRATA","produto":"Pulseira formada por esferas lisas de 5mm - 17cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0096","refAcabada":"850125","desc":"PULSEIRA PRATA","produto":"Pulseira formada por esferas lisas de 5mm - 18cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0117","refAcabada":"850126","desc":"PULSEIRA PRATA","produto":"Pulseira formada por esferas lisas de 3,5mm - 17cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0111","refAcabada":"850127","desc":"PULSEIRA PRATA","produto":"Pulseira formada por esferas lisas de 3,5mm - 18cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0125","refAcabada":"850128","desc":"PULSEIRA PRATA","produto":"Pulseira riviera crava√ß√£o inglesa viollet blue 16cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""},
  {"ref":"FACAG-0124","refAcabada":"850129","desc":"PULSEIRA PRATA","produto":"Pulseira riviera crava√ß√£o inglesa viollet blue 17cm","prioridade":"NORMAL","tipoLote":"PADR√ÉO","defeito":"","impressora":"","cravacaoCera":"","lixa":"","acabamento":"","solda":"","montagem":"","cravacaoMetal":""}
];


// ‚ïê‚ïê DB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê FIREBASE CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBuTOkYH1jej9s4jUi2b4stjDOnkylWa1U",
  authDomain: "rommanel-fundicao.firebaseapp.com",
  projectId: "rommanel-fundicao",
  storageBucket: "rommanel-fundicao.firebasestorage.app",
  messagingSenderId: "648909844672",
  appId: "1:648909844672:web:91d2cf6bc492e1ff4a7d25"
};
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db   = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

// ‚ïê‚ïê DB em mem√≥ria ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DB = {};
let _saveTimer = null;
let _currentUser = null;

function _initDB(data){
  DB = data || {};
  if(!DB.ordens)        DB.ordens=[];
  if(!DB.lancamentos)   DB.lancamentos=[];
  if(!DB.colaboradores) DB.colaboradores=[];
  if(!DB.metas)         DB.metas={};
  if(!DB.auditoria)     DB.auditoria=[];
  if(!DB.refs)          DB.refs=[];
  if(!DB.pedidos)       DB.pedidos=[];
  if(!DB.sucatas)       DB.sucatas=[];
  if(!DB.retornosMetal) DB.retornosMetal=[];
  if(!DB.quebrasTolerancia) DB.quebrasTolerancia={};
  if(!DB.arvores)       DB.arvores=[];
  if(!DB.cicloFund)     DB.cicloFund={prata:1,latao:101};
  // Seed colaboradores
  if(!DB.colaboradores.some(c=>c.cadastrado)){
    COLABORADORES_CATALOGO.forEach(cc=>{
      if(!DB.colaboradores.find(c=>c.nome===cc.nome))
        DB.colaboradores.push({nome:cc.nome,matricula:cc.matricula,turno:'MANH√É',setor:'',ativo:true,cadastrado:true});
    });
  }
}

// save() com debounce 1s ‚Äî evita gravar a cada tecla
function save(){
  setSyncStatus('syncing');
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=>_saveToFirestore(), 1000);
}

async function _saveToFirestore(){
  if(!_currentUser) return;
  try{
    // Salva em chunks de 500KB (Firestore limite por doc = 1MB)
    const chunks = _chunkDB(DB);
    const batch = db.batch();
    chunks.forEach((chunk, i)=>{
      const ref = db.collection('dados').doc('db_' + i);
      batch.set(ref, {data: JSON.stringify(chunk), ts: Date.now(), chunk: i, total: chunks.length});
    });
    await batch.commit();
    setSyncStatus('ok');
  } catch(e){
    console.error('Firestore save error:', e);
    setSyncStatus('error');
    // Fallback: salva no localStorage tamb√©m
    try{ localStorage.setItem('fundDB4_backup', JSON.stringify(DB)); }catch(x){}
  }
}

function _chunkDB(data){
  // Divide o DB em partes menores para n√£o estourar limite de 1MB por documento
  const str = JSON.stringify(data);
  if(str.length < 800000) return [data]; // cabe num doc s√≥
  // Divide arrays grandes
  const parts = [{}];
  const keys = Object.keys(data);
  let size = 0;
  keys.forEach(k=>{
    const val = JSON.stringify(data[k]);
    if(size + val.length > 700000){ parts.push({}); size=0; }
    parts[parts.length-1][k] = data[k];
    size += val.length;
  });
  return parts;
}

async function _loadFromFirestore(){
  try{
    const snap = await db.collection('dados').get();
    if(snap.empty){
      // Primeira vez ‚Äî tenta migrar do localStorage
      const backup = localStorage.getItem('fundDB4') || localStorage.getItem('fundDB4_backup');
      _initDB(backup ? JSON.parse(backup) : {});
      save(); // persiste no Firestore
    } else {
      // Reconstr√≥i DB dos chunks
      const chunks = [];
      snap.forEach(doc=>{ const d=doc.data(); chunks[d.chunk]={...JSON.parse(d.data)}; });
      const merged = Object.assign({}, ...chunks.filter(Boolean));
      _initDB(merged);
    }
    return true;
  } catch(e){
    console.error('Firestore load error:', e);
    // Fallback offline
    const backup = localStorage.getItem('fundDB4') || localStorage.getItem('fundDB4_backup');
    _initDB(backup ? JSON.parse(backup) : {});
    return false;
  }
}

function setSyncStatus(status){
  const dot  = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  if(!dot||!text) return;
  dot.className = 'sync-dot' + (status==='syncing'?' syncing':status==='error'?' error':'');
  text.textContent = status==='syncing'?'salvando...':status==='error'?'erro ao salvar':'sincronizado';
}

// ‚ïê‚ïê LOGIN / LOGOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fazerLogin(){
  document.getElementById('loginError').style.display='none';
  auth.signInWithPopup(provider).catch(e=>{
    console.error(e);
    document.getElementById('loginError').style.display='block';
  });
}

function fazerLogout(){
  if(!confirm('Sair do sistema?')) return;
  auth.signOut();
}

// ‚ïê‚ïê AUTH STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
auth.onAuthStateChanged(async user=>{
  if(user){
    _currentUser = user;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loadingScreen').classList.remove('hidden');
    document.getElementById('userBar').style.display='flex';
    document.getElementById('userNome').textContent = user.displayName||'';
    document.getElementById('userEmail').textContent = '('+user.email+')';
    // Carrega dados
    await _loadFromFirestore();
    document.getElementById('loadingScreen').classList.add('hidden');
    // Renderiza app
    atualizarBadges();
    goPage('lancamento', document.querySelector('.tab'));
    setSyncStatus('ok');
  } else {
    _currentUser = null;
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('userBar').style.display='none';
  }
});

function atualizarBadges(){
  try{ atualizarBadgePedidos(); }catch(e){}
  try{ atualizarBadgeGargalo(); }catch(e){}
  try{ atualizarBadgeArvores(); }catch(e){}
}

// ‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,tipo='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+tipo; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

// Um lan√ßamento tem sa√≠da registrada se saiPreenchida=true OU sai>0 (retrocompat) OU √© naoSeAplica
function temSaida(l){ return !l.filaAuto && (l.naoSeAplica || l.saiPreenchida || l.sai>0); }

let ordemAtual=null, procAtual=null;
let chartTendencia=null;

// ‚ïê‚ïê GERADOR DE N√öMERO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gerarNrOrdem(){
  const ano=String(new Date().getFullYear()).slice(2);
  const existentes=DB.ordens.map(o=>o.nr).filter(nr=>nr.startsWith(ano)&&/^\d{6}$/.test(nr)).map(nr=>parseInt(nr.slice(2))).filter(n=>!isNaN(n));
  const proximo=existentes.length?Math.max(...existentes)+1:1;
  return ano+String(proximo).padStart(4,'0');
}

// ‚ïê‚ïê TURNO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTurno(hora){
  if(!hora) hora=new Date().getHours()+':00';
  const h=parseInt(hora.split(':')[0]);
  if(h>=6&&h<14) return 'MANH√É';
  if(h>=14&&h<22) return 'TARDE';
  return 'NOITE';
}
function turnoBadgeClass(t){ return t==='MANH√É'?'turno-m':t==='TARDE'?'turno-t':'turno-n'; }

// ‚ïê‚ïê COLABORADORES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLABS_DEFAULT=['AIME ARCANJO DE C ALVES NUNES','AMANDA DE OLIVEIRA SILVA','AMANDA PIMENTEL CAIADO','ANDERSON RIBEIRO GOES','ANDRE LUIZ SANTOS FERRAZ','BRUNA SILVA RIOS','BRYAN LUCAS GOUVEIA','CAMILLY SOUZA SANTOS','CILEIDE ARAUJO FERREIRA','CLESBIANI SILVA SANTOS','CRISTIANA SILVA LAURENTINO','CRISTIANE C DA SILVA SANTANA','CRISTIANO FELIPE M DA SILVA','DANIELA DA SILVA','DANIELE SOUZA DE OLIVEIRA','DEISE XAVIER CRUZ','DIEGO COSTA ROCHA','EDNA DE ANDRADE ROSENDO','EDUARDA ARAUJO VIEIRA','ELAINE EVANGELISTA N LEAL','FELIPE BORTOLINI','FERNANDA CAVALCANTE DOS SANTOS','FLAVIANE MACARIO BRAGA','FRANCISCA ROSIANE DAMASO','GABRIELA DOS SANTOS MAGALHAES','GABRIELLY AP R DOS SANTOS','GIOVANNA ALVES','GLENIA LIZIANE MENDES ARANTES','GRAZIELE DE LIMA','HAGATA JENNIFER MARTINS','JALMACIRA BEZERRA R DA SILVA','JANAINA AGUIAR GONCALVES','JANAINA B MAXIMINO DA SILVA','JEOVA BENTO DOS SANTOS JUNIOR','JOANES CARNEIRO DE CARVALHO','JOELMA MARIA DOS SANTOS','JOICE BRITO DE SOUZA','JOSE CARLOS DA ROCHA SILVA','JOYCE LIBANIA ALVES ROMERO','JULIANA SANTOS MIRANDA','KAIQUE JORGE DOMINGUES','KAREN DOS SANTOS OLIMPIO','KETELLY DAS CHAGAS SILVA SOUSA','KLEBER ALISSON FERNANDES ROSA','LARISSA SANTOS','LEIDIANE DA CRUZ SOUZA','LUCAS CARDOSO DA SILVA','MAISA RIBEIRO PEREIRA','MARIA CARLA FRANCA FONTES','MARIA EDUARDA M FRANCISCO','MARIA JOSE DO S A NASCIMENTO','MARIA JOSE LIMA DA SILVA','MARILLYN CRISTINE R GONCALVES','MARINA DE SOUSA CAMPOS','MARYA LUYZA AMARO BERNARDO','MATHEUS COSTA GOMES PEREIRA','MEIRE DE JESUS CAMARGO','MICHEL LOPES ABEL','MICHELE MORAES DA S MOREIRA','MILENA DE SOUSA ARAUJO','NICOLY VERA DA CRUZ','PATRICIA DA CONCEICAO','PEDRO HENRIQUE','RAYANE DOS SANTOS BARBOSA','RAYSSA GONCALVES MATOS','RHUAN SOUZA DE FREITAS','RIAN HENRIQUE COSTA','ROBERT RODRIGO ALVES','RYAN HENRIQUE DA SILVA GOMES','SAMUEL EVANGELISTA DE S JUNIOR','SHEILA DA SILVA LOPES','SHIRLEIY PRATES MARTINS','SILVIA DE PAULA B PEREIRA','SUZANA NATALIA CLEMENTE XAVIER','TAWANE FERNANDA PIRES EUZEBIO','THAIS APARECIDA DA CONCEICAO','THAIS FREITAS DE OLIVEIRA','THAMIRES CARVALHO AGUILAR','THYAGO DOS SANTOS POTENTE','VALTER APARECIDO SALVATI','VANESSA LUCIA DA SILVA ALVES','VANESSA PEREIRA','VICTOR YAN BORTOLIM CERQUEIRA','VITOR HUGO MARTINS DOS SANTOS'];

function getColabs(){
  const nomes=DB.colaboradores.map(c=>c.nome);
  const extra=COLABS_DEFAULT.filter(n=>!nomes.includes(n)).map(n=>({nome:n,turno:'',setor:'',ativo:true,cadastrado:false}));
  return [...DB.colaboradores,...extra].filter(c=>c.ativo!==false);
}
function preencherSelectColab(){
  const sel=document.getElementById('fColab');
  if(!sel) return;
  sel.innerHTML='<option value="">Selecione...</option>';
  getColabs().sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(c=>{
    const o=document.createElement('option');
    o.textContent=c.turno?c.nome+' ('+c.turno+')':c.nome;
    o.value=c.nome;
    sel.appendChild(o);
  });
}

// ‚ïê‚ïê AUDITORIA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function audit(tipo, descricao, dados={}){
  DB.auditoria.unshift({ts:new Date().toLocaleString('pt-BR'),tipo,descricao,dados});
  if(DB.auditoria.length>500) DB.auditoria=DB.auditoria.slice(0,500);
}

// ‚ïê‚ïê BACKUP AUTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checarBackupAuto(){
  const ultima=DB.backupTs?new Date(DB.backupTs):null;
  const agora=new Date();
  const diasSemBackup=ultima?((agora-ultima)/(1000*60*60*24)):999;
  const el=document.getElementById('backupInfo');
  // Snapshot automatico no localStorage (nao √© o backup exportado, mas protege contra reload)
  try{
    const snap={...DB,_snapTs:agora.toISOString()};
    // snapshot migrado para Firestore
  }catch(e){}
  if(el){
    if(diasSemBackup>=7){
      el.innerHTML=`<span style="color:var(--accent);">‚ö†Ô∏è √öltimo backup: ${ultima?ultima.toLocaleDateString('pt-BR'):'nunca'} ‚Äî Recomendamos exportar agora!</span>`;
    } else if(diasSemBackup>=3){
      el.innerHTML=`<span style="color:var(--muted);">üïê √öltimo backup: ${ultima.toLocaleDateString('pt-BR')} (${Math.floor(diasSemBackup)} dias atr√°s)</span>`;
    } else if(ultima){
      el.innerHTML=`<span style="color:var(--green);">‚úÖ √öltimo backup: ${ultima.toLocaleDateString('pt-BR')}</span>`;
    }
  }
}
// Snapshot autom√°tico a cada 30 minutos enquanto a aba est√° aberta
setInterval(()=>{
  try{ /* snapshot migrado para Firestore */ }catch(e){}
},30*60*1000);
// Snapshot ao sair da p√°gina
window.addEventListener('beforeunload',()=>{
  try{ /* snapshot migrado para Firestore */ }catch(e){}
});
function exportarBackup(){
  DB.backupTs=new Date().toISOString();
  save();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}));
  a.download='backup_fundi√ß√£o_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  toast('‚úÖ Backup exportado com sucesso!');
  const el=document.getElementById('backupInfo');
  if(el) el.innerHTML='<span style="color:var(--green);">‚úÖ √öltimo backup: '+new Date().toLocaleDateString('pt-BR')+'</span>';
  audit('BACKUP','Backup exportado pelo usu√°rio');
}
function importarBackup(input){
  const file=input.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const dados=JSON.parse(e.target.result);
      if(!dados.ordens||!dados.lancamentos) throw new Error('Arquivo inv√°lido');
      if(!confirm('‚ö†Ô∏è Isso ir√° SUBSTITUIR todos os dados atuais pelo backup. Confirma?')) return;
      DB={ordens:dados.ordens||[],lancamentos:dados.lancamentos||[],colaboradores:dados.colaboradores||[],metas:dados.metas||{},auditoria:dados.auditoria||[],backupTs:dados.backupTs||null};
      save(); toast('‚úÖ Backup restaurado! '+DB.ordens.length+' ordens, '+DB.lancamentos.length+' lan√ßamentos.','info');
      audit('RESTAURA√á√ÉO','Backup restaurado de arquivo: '+file.name);
    } catch(err){ toast('‚ùå Arquivo de backup inv√°lido','err'); }
  };
  r.readAsText(file);
}
function confirmarLimparDados(){
  if(!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° apagar TODOS os dados permanentemente. Tem certeza absoluta?')) return;
  if(!confirm('√öltima confirma√ß√£o: TODOS os dados ser√£o perdidos. Continuar?')) return;
  DB={ordens:[],lancamentos:[],colaboradores:[],metas:{},auditoria:[],backupTs:null};
  save(); toast('Dados apagados.','err');
}

// ‚ïê‚ïê PE√áAS/HORA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcPcHora(l){
  if(!l.hini||!l.hfim||!l.sai) return null;
  const [h1,m1]=l.hini.split(':').map(Number);
  const [h2,m2]=l.hfim.split(':').map(Number);
  let mins=(h2*60+m2)-(h1*60+m1);
  if(mins<=0) return null;
  return (l.sai/mins*60).toFixed(1);
}

// ‚ïê‚ïê PREVIS√ÉO DE CONCLUS√ÉO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcPrevisao(ordem){
  const lans=DB.lancamentos.filter(l=>l.nr===ordem.nr);
  const done=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
  const restantes=PROCESSOS.filter(p=>!done.includes(p.nome));
  if(!restantes.length) return {texto:'CONCLU√çDA',dias:0};
  // Calcula tempo m√©dio por processo com base em lan√ßamentos com hini+hfim
  const tempos=lans.filter(l=>l.hini&&l.hfim).map(l=>{
    const [h1,m1]=l.hini.split(':').map(Number);
    const [h2,m2]=l.hfim.split(':').map(Number);
    return (h2*60+m2)-(h1*60+m1);
  }).filter(t=>t>0);
  if(!tempos.length) return null;
  const avgMin=tempos.reduce((s,t)=>s+t,0)/tempos.length;
  const totalMin=restantes.length*avgMin;
  const diasUteis=Math.ceil(totalMin/(60*8)); // 8h/dia √∫til
  const dataPrevisao=new Date();
  dataPrevisao.setDate(dataPrevisao.getDate()+diasUteis);
  return {texto:dataPrevisao.toLocaleDateString('pt-BR'),dias:diasUteis};
}

// ‚ïê‚ïê GARGALO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcGargalos(){
  return PROCESSOS.map(p=>{
    const aguardando=DB.ordens.filter(o=>{
      const lansO=DB.lancamentos.filter(l=>l.nr===o.nr);
      if(p.nome==='FILA IMPRESS√ÉO'){
        const filaLans=lansO.filter(l=>l.proc==='FILA IMPRESS√ÉO');
        return filaLans.length>0&&filaLans.every(l=>l.filaAuto)&&lansO.filter(l=>!l.filaAuto).length===0;
      }
      const lansProc=lansO.filter(l=>l.proc===p.nome&&!l.filaAuto);
      if(lansProc.some(l=>l.ent>0&&!temSaida(l))) return true;
      const done=[...new Set(lansO.filter(l=>temSaida(l)).map(l=>l.proc))];
      const prox=PROCESSOS.find(pr=>!done.includes(pr.nome)&&pr.nome!=='FILA IMPRESS√ÉO');
      return prox&&prox.nome===p.nome;
    }).length;
    return {proc:p.nome,aguardando};
  }).filter(g=>g.aguardando>0);
}
function atualizarBadgeGargalo(){
  const gargalos=calcGargalos().filter(g=>g.aguardando>5);
  const badge=document.getElementById('badgeGargalo');
  if(badge){ badge.textContent=gargalos.length; badge.className='tab-badge'+(gargalos.length>0?' show':''); }
  const hdr=document.getElementById('alertaHdr');
  if(hdr && gargalos.length>0){
    hdr.style.display='flex';
    hdr.innerHTML=gargalos.map(g=>`<span style="display:flex;align-items:center;gap:5px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:700;color:#fca5a5;"><span class="alerta-pulse"></span>${g.proc.split(' ')[0]}: ${g.aguardando}</span>`).join('');
  } else if(hdr) { hdr.style.display='none'; }
}

// ‚ïê‚ïê CLOCK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tick(){
  const n=new Date();
  document.getElementById('clock').textContent=n.toLocaleTimeString('pt-BR');
  document.getElementById('dateStr').textContent=n.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  // badges inicializados pelo auth.onAuthStateChanged
}
setInterval(tick,1000); tick();


// ‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  const renders={'cadastro-ref':renderCadastroRefs,'por-ordem':renderPorOrdem,'pedidos':renderPedidos,'por-processo':renderPorProcesso,'referencias':renderReferencias,'quebras':renderQuebras,'dashboard':renderDashboard,'historico':renderHistorico,'colaboradores':renderColaboradores,'arvores':renderArvores,'metal':renderMetal,'config':()=>{renderConfig();renderConfigTolerancia();}};
  if(renders[id]) renders[id]();
}

// ‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirModal(tipo, data={}){
  const bg=document.getElementById('modalBg');
  const c=document.getElementById('modalContent');
  if(tipo==='nova-ordem'){
    c.innerHTML=`
    <h3>üìã Nova Ordem de Produ√ß√£o</h3>
    <div class="g2" style="gap:10px;">
      <div class="fg"><div class="fl" style="display:flex;justify-content:space-between;align-items:center;">N¬∫ da Ordem <span style="color:var(--green);font-size:9px;">‚óè AUTOM√ÅTICO</span></div>
        <input class="fi" id="mNr" type="text" readonly style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;letter-spacing:.05em;"></div>
      <div class="fg"><div class="fl">Refer√™ncia Bruta *</div>
        <input class="fi" id="mRef" type="text" placeholder="Ex: FAN-0118" oninput="autoFillRef()" list="refListModal">
        <datalist id="refListModal">${[...DB.refs.map(r=>r.ref),...CATALOGO.map(c=>c.ref)].filter((v,i,a)=>a.indexOf(v)===i).map(r=>`<option value="${r}">`).join('')}</datalist></div>
      <div class="fg"><div class="fl">Refer√™ncia Acabada</div><input class="fi" id="mRefAcab" type="text" placeholder="Ex: 513426" readonly style="opacity:.7"></div>
      <div class="fg"><div class="fl">Descri√ß√£o</div><input class="fi" id="mDesc" type="text" placeholder="Auto-preenchido do cadastro"></div>
      <div class="fg"><div class="fl">Produto</div><input class="fi" id="mProd" type="text" placeholder="Auto-preenchido do cadastro"></div>
      <div class="fg"><div class="fl">Quantidade *</div><input class="fi" id="mQtd" type="number" min="1" placeholder="Ex: 10"></div>
      <div class="fg"><div class="fl">Tamanho</div><input class="fi" id="mTam" type="text" placeholder="Auto-preenchido do cadastro"></div>
      <div class="fg"><div class="fl">Prazo de Entrega</div><input class="fi" id="mPrazo" type="date"></div>
      <div class="fg"><div class="fl">Prioridade</div>
        <select class="fi" id="mPrio"><option>NORMAL</option><option>URG√äNTE</option><option>CRIT√çCO</option></select></div>
    </div>
    <!-- Tipo de Lote -->
    <div style="margin-top:12px;">
      <div class="fl" style="margin-bottom:7px;font-weight:700;">Tipo de Lote</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <div id="tlCard_PADR√ÉO" onclick="selTipoLote('PADR√ÉO')"
          style="cursor:pointer;border-radius:9px;border:2px solid var(--green);background:rgba(16,185,129,.1);padding:10px 12px;transition:all .15s;user-select:none;">
          <div style="font-size:11px;font-weight:900;color:var(--green);letter-spacing:.06em;">‚úÖ PADR√ÉO</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4;">Lote normal ‚Äî segue todo o roteiro do in√≠cio ao fim</div>
        </div>
        <div id="tlCard_RECUPERAVEL" onclick="selTipoLote('RECUPERAVEL')"
          style="cursor:pointer;border-radius:9px;border:2px solid var(--border);background:var(--bg3);padding:10px 12px;transition:all .15s;user-select:none;">
          <div style="font-size:11px;font-weight:900;color:var(--accent);letter-spacing:.06em;">üîÑ RECUPER√ÅVEL</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4;">Defeito recuper√°vel ‚Äî sublote entra a partir do processo de recupera√ß√£o</div>
        </div>
        <div id="tlCard_RETRABALHO" onclick="selTipoLote('RETRABALHO')"
          style="cursor:pointer;border-radius:9px;border:2px solid var(--border);background:var(--bg3);padding:10px 12px;transition:all .15s;user-select:none;">
          <div style="font-size:11px;font-weight:900;color:var(--red);letter-spacing:.06em;">‚ö†Ô∏è RETRABALHO</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4;">Quebra definitiva ‚Äî novo lote do zero, original continua sem essas pe√ßas</div>
        </div>
      </div>
      <input type="hidden" id="mTipoLote" value="PADR√ÉO">
    </div>
    <div id="mAcessoriosPreview" style="display:none;margin-top:10px;"></div>
    <div id="mFotoPreview" style="display:none;margin-top:10px;"></div>
    <div class="fg" style="margin-top:10px;"><div class="fl">Observa√ß√£o</div><input class="fi" id="mObs" type="text"></div>
    <div style="margin-top:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;display:flex;align-items:center;gap:16px;">
      <div><div class="fl" style="margin-bottom:6px;">Pr√©-visualiza√ß√£o C√≥digo de Barras</div><svg id="bcPreview"></svg></div>
      <div style="flex:1;"><div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--accent)" id="nrPreview">‚Äî</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;">Impresso na Ordem de Produ√ß√£o</div></div>
    </div>
    <div style="margin-top:10px;text-align:right;"><span style="font-size:11px;color:var(--muted);">Refer√™ncia n√£o cadastrada? <a href="#" onclick="fecharModal();document.querySelectorAll('.tab')[3].click();" style="color:var(--blue);">Cadastrar aqui ‚Üí</a></span></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="salvarOrdem()">‚úÖ CRIAR ORDEM</button>
    </div>`;
    setTimeout(()=>{
      const nr=gerarNrOrdem();
      document.getElementById('mNr').value=nr;
      document.getElementById('nrPreview').textContent='#'+nr;
      if(typeof JsBarcode!=='undefined'){
        try{ JsBarcode('#bcPreview',nr,{format:'CODE128',width:1.8,height:42,displayValue:true,fontSize:11,margin:2}); }catch(e){}
      }
    },50);
  } else if(tipo==='novo-colab'){
    c.innerHTML=`
    <h3>üë§ Cadastrar Colaborador</h3>
    <div class="g2" style="gap:10px;">
      <div class="fg gfull"><div class="fl">Nome Completo *</div><input class="fi" id="cNome" type="text" placeholder="Nome do colaborador"></div>
      <div class="fg"><div class="fl">Matr√≠cula</div><input class="fi" id="cMatricula" type="text" placeholder="Ex: 00123"></div>
      <div class="fg"><div class="fl">Turno</div>
        <select class="fi" id="cTurno"><option value="">N√£o definido</option><option>MANH√É</option><option>TARDE</option><option>NOITE</option></select></div>
      <div class="fg"><div class="fl">Setor / Processo Principal</div>
        <select class="fi" id="cSetor"><option value="">Geral</option>${PROCESSOS.map(p=>`<option>${p.nome}</option>`).join('')}</select></div>
      <div class="fg"><div class="fl">Status</div>
        <select class="fi" id="cAtivo"><option value="true">‚úÖ Ativo</option><option value="false">‚õî Inativo</option></select></div>
    </div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="salvarColab()">‚úÖ SALVAR</button>
    </div>`;
  } else if(tipo==='fracionar-ordem'){
    if(!ordemAtual){ toast('Busque uma ordem primeiro','err'); fecharModal(); return; }
    const o = ordemAtual;
    const fracExist = DB.ordens.filter(x=>x.ordemPai===o.nr);
    const qtdDisp = calcQtdDisponivel(o.nr);
    // BUG 6 FIX: bloqueia se n√£o h√° pe√ßas dispon√≠veis para fracionamento
    if(qtdDisp<=0){
      c.innerHTML=`
      <h3>‚úÇÔ∏è Fracionar Ordem #${o.nr}</h3>
      <div style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:16px;text-align:center;margin:10px 0;">
        <div style="font-size:32px;margin-bottom:8px;">‚ö†Ô∏è</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:#fca5a5;margin-bottom:6px;">Sem pe√ßas dispon√≠veis para fracionar</div>
        <div style="font-size:12px;color:var(--muted);">Todas as ${o.qtd} pe√ßas desta ordem j√° foram distribu√≠das em ${fracExist.length} sublote(s) ou registradas como quebra.</div>
      </div>
      <div class="mbtns"><button class="mbtn btn-gy" onclick="fecharModal()">Fechar</button></div>`;
      bg.classList.add('open'); return;
    }
    c.innerHTML=`
    <h3>‚úÇÔ∏è Fracionar Ordem #${o.nr}</h3>
    <div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-radius:8px;padding:12px;margin-bottom:14px;">
      <div style="font-size:12px;color:#93c5fd;font-weight:700;">${o.ref} ¬∑ ${o.desc||''}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px;">Quantidade total: <strong style="color:var(--text)">${o.qtd}</strong> p√ß &nbsp;|&nbsp; Dispon√≠vel: <strong style="color:var(--accent)">${qtdDisp}</strong> p√ß${fracExist.length?` &nbsp;|&nbsp; Fra√ß√µes j√° existentes: <strong style="color:#93c5fd">${fracExist.length}</strong>`:''}
      </div>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:10px;">Defina as fra√ß√µes. O total deve ser ‚â§ ${qtdDisp} pe√ßas dispon√≠veis.</div>
    <div id="fracInputList"></div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
      <button class="btn btn-bl" style="padding:6px 14px;font-size:12px;" onclick="adicionarLinhaFrac()">+ Adicionar Fra√ß√£o</button>
      <button class="btn btn-gy" style="padding:6px 14px;font-size:12px;" onclick="distribuirFracoesIgual()">‚öñÔ∏è Distribuir Igual</button>
    </div>
    <div id="fracTotalInfo" style="background:var(--bg3);border-radius:7px;padding:8px 12px;font-size:12px;font-weight:700;margin-bottom:14px;"></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="confirmarFracionamento()">‚úÇÔ∏è GERAR SUBLOTES + ETIQUETAS</button>
    </div>`;
    window._fracOrdem = o;
    window._fracQtdDisp = qtdDisp;
    window._fracExistCount = fracExist.length;
    setTimeout(()=>{ adicionarLinhaFrac(); adicionarLinhaFrac(); atualizarTotalFrac(); },30);
  } else if(tipo==='refazer-modelo'){
    const q=data;
    const existing=DB.ordens.filter(o=>o.ordemOrigem===q.ordemNr||o.nr.startsWith(q.ordemNr+'-R'));
    const ordemRetrabalhoAtiva = existing.find(o=>{
      const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
      const done=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
      const prg=calcProgresso(lans); return lans.length>0 && prg<N_PROC;
    });
    if(ordemRetrabalhoAtiva){
      c.innerHTML=`
      <h3>üîÅ Retrabalho</h3>
      <div class="rt-ok-produzindo" style="width:100%;justify-content:center;margin-bottom:14px;font-size:14px;padding:14px;">
        ‚úÖ OK ‚Äî PRODUZINDO
      </div>
      <div style="font-size:13px;color:var(--muted);text-align:center;margin-bottom:14px;">
        Ordem de retrabalho <strong style="color:var(--accent)">#${ordemRetrabalhoAtiva.nr}</strong> j√° est√° na fila / em produ√ß√£o.
      </div>
      <div class="mbtns">
        <button class="mbtn btn-bl" onclick="irOrdem('${ordemRetrabalhoAtiva.nr}');fecharModal()">VER ORDEM ‚Üí</button>
        <button class="mbtn btn-gy" onclick="fecharModal()">Fechar</button>
      </div>`;
      bg.classList.add('open');
      return;
    }
    const rNum=existing.length+1;
    const newNr=q.ordemNr+'-R'+rNum;
    c.innerHTML=`
    <h3>üîÅ Gerar Lote de Retrabalho</h3>
    <div style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:12px;margin-bottom:14px;">
      <div style="font-size:11px;font-weight:700;color:#fca5a5;margin-bottom:4px;">ORDEM ORIGINAL ‚Üí NOVA ORDEM DE RETRABALHO</div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--accent)">#${q.ordemNr}</span>
        <span style="color:var(--muted)">‚Üí</span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--red)">#${newNr}</span>
        <span style="font-size:11px;color:var(--muted)">${q.ref} ¬∑ ${q.desc||''}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px;">Fase da quebra: <strong style="color:#fca5a5">${q.proc}</strong> ¬∑ Motivo: <strong style="color:#fca5a5">${q.motivo}</strong></div>
    </div>
    <div class="g2" style="gap:10px;margin-bottom:12px;">
      <div class="fg"><div class="fl">Quantidade a refazer *</div><input class="fi" id="rQtd" type="number" value="${q.qbr}" min="1"></div>
      <div class="fg"><div class="fl">Nova N¬∫ Ordem</div><input class="fi" id="rNr" value="${newNr}" readonly style="opacity:.7"></div>
    </div>
    <div class="fg" style="margin-bottom:12px;"><div class="fl">Observa√ß√£o</div><input class="fi" id="rObs" type="text" placeholder="Ex: defeito definitivo na fundi√ß√£o"></div>
    <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:10px;margin-bottom:14px;font-size:12px;color:var(--accent);">‚ö†Ô∏è Esta ordem entrar√° automaticamente na <strong>FILA IMPRESS√ÉO</strong> marcada como RETRABALHO.</div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-rd" onclick="gerarRetrabalho(window._rtData)">üîÅ GERAR LOTE DE RETRABALHO</button>
    </div>`;
    window._rtData=q;
  }

  // ‚îÄ‚îÄ MODAL: Nova Sucata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(tipo==='nova-sucata'){
    c.innerHTML=`
    <h3>üóë Lan√ßar Sucata</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Registre o peso das pe√ßas estragadas enviadas para recupera√ß√£o. Esse valor fecha o ciclo da quebra real.</p>
    <div class="g2" style="gap:10px;">
      <div class="fg"><div class="fl">Data do Envio *</div>
        <input class="fi" id="sSucDt" type="date"></div>
      <div class="fg"><div class="fl">Tipo de Metal *</div>
        <select class="fi" id="sSucTipo">
          <option value="">Selecione...</option>
          <option>LAT√ÉO</option><option>PRATA</option><option>OURO</option><option>OUTRO</option>
        </select></div>
      <div class="fg"><div class="fl">Peso Total (g) *</div>
        <input class="fi" id="sSucPeso" type="number" min="0" step="0.01" placeholder="0.00"></div>
      <div class="fg"><div class="fl">N¬∫ Ordem (opcional)</div>
        <input class="fi" id="sSucOrdem" type="text" placeholder="Ex: 260001"></div>
    </div>
    <div class="fg" style="margin-top:10px;"><div class="fl">Observa√ß√£o</div>
      <input class="fi" id="sSucObs" type="text" placeholder="Ex: Lote com defeito de fundi√ß√£o"></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-rd" onclick="salvarSucata()">üóë REGISTRAR</button>
    </div>`;
    setTimeout(()=>{ const d=document.getElementById('sSucDt'); if(d) d.value=new Date().toISOString().slice(0,10); },30);
    bg.classList.add('open'); return;
  }

  // ‚îÄ‚îÄ MODAL: Retorno Metal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(tipo==='retorno-metal'){
    const pendentes = (DB.sucatas||[]).filter(s=>{
      const ret=(DB.retornosMetal||[]).filter(r=>r.sucataId===s.id).reduce((t,r)=>t+r.peso,0);
      return ret < s.peso;
    });
    const optsSuc = pendentes.map(s=>{
      const ret=(DB.retornosMetal||[]).filter(r=>r.sucataId===s.id).reduce((t,r)=>t+r.peso,0);
      const saldo=(s.peso-ret).toFixed(2);
      return `<option value="${s.id}">${s.dt||s.data} ‚Äî ${s.tipo} ‚Äî ${s.peso}g env. ‚Äî saldo: ${saldo}g</option>`;
    }).join('');
    c.innerHTML=`
    <h3>‚ôªÔ∏è Retorno da Recuperadora</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Lance o metal retornado para fechar o ciclo e calcular a quebra real definitiva da f√°brica.</p>
    <div class="g2" style="gap:10px;">
      <div class="fg"><div class="fl">Data do Retorno *</div>
        <input class="fi" id="sRetDt" type="date"></div>
      <div class="fg"><div class="fl">Tipo de Metal *</div>
        <select class="fi" id="sRetTipo">
          <option value="">Selecione...</option>
          <option>LAT√ÉO</option><option>PRATA</option><option>OURO</option><option>OUTRO</option>
        </select></div>
      <div class="fg" style="grid-column:1/-1;"><div class="fl">Vincular a Sucata Pendente (opcional)</div>
        <select class="fi" id="sRetSucRef">
          <option value="">Sem v√≠nculo</option>
          ${optsSuc||'<option disabled>Nenhuma sucata com saldo pendente</option>'}
        </select></div>
      <div class="fg"><div class="fl">Peso Retornado (g) *</div>
        <input class="fi" id="sRetPeso" type="number" min="0" step="0.01" placeholder="0.00"></div>
      <div class="fg"><div class="fl">NF / Ref. Recuperadora</div>
        <input class="fi" id="sRetNF" type="text" placeholder="Ex: NF-123456"></div>
    </div>
    <div class="fg" style="margin-top:10px;"><div class="fl">Observa√ß√£o</div>
      <input class="fi" id="sRetObs" type="text" placeholder="Ex: 2¬™ remessa ‚Äî retorno parcial"></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="salvarRetornoMetal()">‚ôªÔ∏è REGISTRAR</button>
    </div>`;
    setTimeout(()=>{ const d=document.getElementById('sRetDt'); if(d) d.value=new Date().toISOString().slice(0,10); },30);
    bg.classList.add('open'); return;
  }

  // ‚îÄ‚îÄ MODAL: Novo Pedido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(tipo==='novo-pedido'){
    const nrP=gerarNrPedido();
    const refsAll=[...new Set([...DB.refs.map(r=>r.ref),...CATALOGO.map(c=>c.ref)])];
    c.innerHTML=`
    <h3>üõí Novo Pedido de Produ√ß√£o</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;">Um pedido define o total a produzir. Voc√™ emite ordens parciais e o saldo √© abatido automaticamente.</p>
    <div class="g2" style="gap:10px;">
      <div class="fg"><div class="fl">N¬∫ do Pedido</div>
        <input class="fi" id="pNr" type="text" value="${nrP}" readonly style="font-weight:900;opacity:.7;"></div>
      <div class="fg"><div class="fl">Refer√™ncia Bruta *</div>
        <input class="fi" id="pRef" type="text" placeholder="Ex: FAN-0118" oninput="autoFillPedido()" list="refListPed">
        <datalist id="refListPed">${refsAll.map(r=>`<option value="${r}">`).join('')}</datalist></div>
      <div class="fg"><div class="fl">Ref. Acabada</div>
        <input class="fi" id="pRefAcab" type="text" placeholder="Auto" readonly style="opacity:.7;"></div>
      <div class="fg"><div class="fl">Descri√ß√£o</div>
        <input class="fi" id="pDesc" type="text" placeholder="Auto-preenchido do cadastro"></div>
      <div class="fg"><div class="fl">Qtde TOTAL do Pedido *</div>
        <input class="fi" id="pQtdTotal" type="number" min="1" placeholder="Ex: 500"></div>
      <div class="fg"><div class="fl">Tamanho</div>
        <input class="fi" id="pTam" type="text" placeholder="Ex: 18"></div>
      <div class="fg"><div class="fl">Prazo Final</div>
        <input class="fi" id="pPrazo" type="date"></div>
      <div class="fg"><div class="fl">Prioridade</div>
        <select class="fi" id="pPrio"><option>NORMAL</option><option>URG√äNTE</option><option>CRIT√çCO</option></select></div>
    </div>
    <div class="fg" style="margin-top:10px;"><div class="fl">Observa√ß√£o / Cliente</div>
      <input class="fi" id="pObs" type="text" placeholder="Ex: Cliente XPTO ‚Äî PO-2026-001"></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="salvarPedido()">‚úÖ CRIAR PEDIDO</button>
    </div>`;
    bg.classList.add('open'); return;
  }

  // ‚îÄ‚îÄ MODAL: Emitir Ordem de Pedido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(tipo==='emitir-ordem-pedido'){
    const pNr=window._emitirPedidoNr;
    const p=DB.pedidos.find(x=>x.nr===pNr);
    if(!p){ toast('Pedido n√£o encontrado','err'); return; }
    const saldo=calcSaldoPedido(pNr);
    const ordemNr=gerarNrOrdem();
    if(saldo<=0){
      c.innerHTML=`<h3>‚úÖ Pedido Conclu√≠do</h3>
        <p style="text-align:center;padding:20px;color:var(--green);font-weight:700;">Todas as ${p.qtdTotal} pe√ßas j√° foram emitidas em ordens de produ√ß√£o.</p>
        <div class="mbtns"><button class="mbtn btn-gy" onclick="fecharModal()">Fechar</button></div>`;
      bg.classList.add('open'); return;
    }
    c.innerHTML=`
    <h3>üñ®Ô∏è Emitir Ordem ‚Äî Pedido <span style="color:var(--accent)">#${pNr}</span></h3>
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;font-size:12px;text-align:center;">
        <div><div style="color:var(--muted);font-size:10px;">Refer√™ncia</div><div style="font-weight:900;color:var(--blue)">${p.ref}</div></div>
        <div><div style="color:var(--muted);font-size:10px;">Total Pedido</div><div style="font-weight:900;">${p.qtdTotal} p√ß</div></div>
        <div><div style="color:var(--muted);font-size:10px;">Saldo Restante</div><div style="font-weight:900;color:var(--accent);">${saldo} p√ß</div></div>
      </div>
    </div>
    <div class="g2" style="gap:10px;">
      <div class="fg"><div class="fl">N¬∫ da Ordem</div>
        <input class="fi" id="eoNr" type="text" value="${ordemNr}" readonly style="font-weight:900;opacity:.7;"></div>
      <div class="fg"><div class="fl">Quantidade desta Ordem * <small style="color:var(--accent)">(m√°x ${saldo})</small></div>
        <input class="fi" id="eoQtd" type="number" min="1" max="${saldo}" value="${Math.min(saldo,50)}"></div>
      <div class="fg"><div class="fl">Tamanho</div>
        <input class="fi" id="eoTam" type="text" value="${p.tam||''}"></div>
      <div class="fg"><div class="fl">Prioridade</div>
        <select class="fi" id="eoPrio">
          <option${p.prio==='NORMAL'?' selected':''}>NORMAL</option>
          <option${p.prio==='URG√äNTE'?' selected':''}>URG√äNTE</option>
          <option${p.prio==='CRIT√çCO'?' selected':''}>CRIT√çCO</option>
        </select></div>
    </div>
    <div class="fg" style="margin-top:8px;"><div class="fl">Observa√ß√£o</div>
      <input class="fi" id="eoObs" type="text" placeholder="Opcional"></div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="emitirOrdemDoPedido('${pNr}')">üñ®Ô∏è EMITIR E IMPRIMIR</button>
    </div>`;
    bg.classList.add('open'); return;
  }

  if(tipo==='nova-arvore'){
    const tpl = document.getElementById('tplNovaArvore');
    c.innerHTML = tpl ? tpl.innerHTML : '<p>Template n√£o encontrado</p>';
    _arvOrdens = [];
    onArvMetalChange();
    renderArvOrdensList();
    bg.classList.add('open');
    setTimeout(()=>document.getElementById('arvBipeInput')?.focus(),200);
    return;
  }

  bg.classList.add('open');
}
function fecharModal(){ document.getElementById('modalBg').classList.remove('open'); }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') fecharModal(); });
document.getElementById('modalBg').addEventListener('click',e=>{ if(e.target.id==='modalBg') fecharModal(); });

// ‚ïê‚ïê AUTO FILL REF ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SISTEMA DE 3 TIPOS DE LOTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Seleciona visualmente o tipo de lote no modal nova-ordem
function selTipoLote(tipo){
  const cfg = {
    'PADR√ÉO':     {border:'var(--green)',  bg:'rgba(16,185,129,.1)'},
    'RECUPERAVEL':{border:'var(--accent)', bg:'rgba(245,158,11,.1)'},
    'RETRABALHO': {border:'var(--red)',    bg:'rgba(239,68,68,.1)'},
  };
  ['PADR√ÉO','RECUPERAVEL','RETRABALHO'].forEach(t=>{
    const el=document.getElementById('tlCard_'+t);
    if(!el) return;
    if(t===tipo){ el.style.borderColor=cfg[t].border; el.style.background=cfg[t].bg; }
    else        { el.style.borderColor='var(--border)'; el.style.background='var(--bg3)'; }
  });
  const inp=document.getElementById('mTipoLote');
  if(inp) inp.value=tipo;
}

// Seleciona RECUPER√ÅVEL ou DEFINITIVO no painel de defeito do lan√ßamento
function selTipoDefeito(tipo){
  const rec=document.getElementById('defBtn_REC');
  const def=document.getElementById('defBtn_DEF');
  const inp=document.getElementById('fTipoDefeito');
  const painel=document.getElementById('painelRetorno');
  if(rec&&def){
    if(tipo==='RECUPERAVEL'){
      rec.style.borderColor='var(--accent)'; rec.style.background='rgba(245,158,11,.12)';
      def.style.borderColor='var(--border)'; def.style.background='var(--bg3)';
    } else {
      def.style.borderColor='var(--red)';    def.style.background='rgba(239,68,68,.12)';
      rec.style.borderColor='var(--border)'; rec.style.background='var(--bg3)';
    }
  }
  if(inp) inp.value=tipo;
  if(painel){
    if(tipo==='RECUPERAVEL'){
      // Preenche o select de processo de retorno
      const procAtualIdx = PROCESSOS_REAIS.findIndex(p=>p.nome===procAtual);
      const opts = PROCESSOS_REAIS
        .map((p,i)=>`<option value="${p.nome}" ${i===procAtualIdx?'selected':''}>${p.id} ‚Äî ${p.nome}</option>`)
        .join('');
      document.getElementById('fProcRetorno').innerHTML=opts;
      painel.style.display='block';
    } else {
      painel.style.display='none';
    }
  }
}

// Gera sublote RECUPER√ÅVEL ‚Äî entra diretamente no processo escolhido
function gerarLoteRecuperavel(ordemPai, qtd, procInicio, defeito){
  const o = DB.ordens.find(x=>x.nr===ordemPai);
  if(!o) return;
  const existing = DB.ordens.filter(x=>x.ordemOrigem===ordemPai&&x.isRecuperavel);
  const rNum = existing.length + 1;
  const nr = ordemPai + '-RC' + rNum;
  const novaOrdem = {
    nr, ref:o.ref, desc:o.desc||'', produto:o.produto||'',
    refAcabada:o.refAcabada||'', tam:o.tam||'',
    prazo:o.prazo||'', prio:o.prio||'NORMAL',
    qtd, tipoLote:'RECUPERAVEL', isRecuperavel:true,
    ordemOrigem:ordemPai, procInicio,
    motivoDefeito:defeito,
    obs:'Recupera√ß√£o de '+ordemPai+' ‚Äî '+defeito,
    acessoriosInternos:o.acessoriosInternos||[],
    acessoriosExternos:o.acessoriosExternos||[],
    criado:new Date().toLocaleString('pt-BR'),
  };
  DB.ordens.push(novaOrdem);
  // Lan√ßamentos virtuais para todos os processos ANTERIORES ao de retorno
  const idxInicio = PROCESSOS_REAIS.findIndex(p=>p.nome===procInicio);
  PROCESSOS_REAIS.slice(0, Math.max(0,idxInicio)).forEach(p=>{
    DB.lancamentos.push({
      id:Date.now()+Math.random(),
      dt:new Date().toLocaleString('pt-BR'),
      nr, ref:o.ref, desc:o.desc||'',
      proc:p.nome, sub:'', colab:'SISTEMA',
      ent:0, sai:0, qbr:0, motivo:'',
      hini:'', hfim:'', obs:'Processo anterior ‚Äî lote recuper√°vel entra em: '+procInicio,
      turno:'', pcHora:null, pulado:true, naoSeAplica:true,
    });
  });
  audit('RECUPER√ÅVEL','Sublote #'+nr+' gerado a partir de #'+ordemPai+' ‚Äî entra em: '+procInicio,{nr,ordemPai,qtd,procInicio,defeito});
  save();
  atualizarBadgeGargalo();
  renderPorOrdem();
  fecharModal();
  toast('üîÑ Lote recuper√°vel #'+nr+' criado ‚Äî entra em: '+procInicio,'ok');
}

// Gera retrabalho autom√°tico ap√≥s lan√ßamento com defeito DEFINITIVO
function gerarRetrabalhoAuto(ordemPai, qtd, defeito, proc){
  const o = DB.ordens.find(x=>x.nr===ordemPai);
  if(!o) return;
  const existing = DB.ordens.filter(x=>x.ordemOrigem===ordemPai&&x.isRetrabalho);
  const rNum = existing.length + 1;
  const nr = ordemPai + '-R' + rNum;
  DB.ordens.push({
    nr, ref:o.ref, desc:o.desc||'', produto:o.produto||'',
    refAcabada:o.refAcabada||'', tam:o.tam||'',
    prazo:o.prazo||'', prio:o.prio||'NORMAL',
    qtd, tipoLote:'RETRABALHO', isRetrabalho:true,
    ordemOrigem:ordemPai, motivoRetrabalho:defeito, faseQuebra:proc,
    obs:'Retrabalho de '+ordemPai+' ‚Äî '+defeito,
    acessoriosInternos:o.acessoriosInternos||[],
    acessoriosExternos:o.acessoriosExternos||[],
    criado:new Date().toLocaleString('pt-BR'),
  });
  DB.lancamentos.push({
    id:Date.now(), dt:new Date().toLocaleString('pt-BR'),
    nr, ref:o.ref, desc:o.desc||'',
    proc:'FILA IMPRESS√ÉO', sub:'', colab:'SISTEMA',
    ent:0, sai:0, qbr:0, motivo:'',
    hini:'', hfim:'', obs:'Retrabalho ‚Äî entrada autom√°tica na fila',
    turno:'', pcHora:null, filaAuto:true,
  });
  audit('RETRABALHO','Retrabalho #'+nr+' gerado de #'+ordemPai+' ‚Äî '+defeito+' em '+proc,{nr,ordemPai,qtd,defeito,proc});
  save();
  atualizarBadgeGargalo();
  renderPorOrdem();
  fecharModal();
  toast('‚ö†Ô∏è Retrabalho #'+nr+' gerado ‚Äî na FILA IMPRESS√ÉO','info');
}


function autoFillRef(){
  const v=document.getElementById('mRef').value.trim().toUpperCase();
  const r=DB.refs.find(x=>x.ref===v);
  const c=CATALOGO.find(x=>x.ref===v);
  const fonte=r||c;
  const refAcabEl=document.getElementById('mRefAcab');
  if(fonte){
    if(document.getElementById('mDesc')) document.getElementById('mDesc').value=r?r.desc:(c.desc||'');
    if(document.getElementById('mProd')) document.getElementById('mProd').value=r?r.produto:(c.produto||'');
    if(document.getElementById('mTam'))  document.getElementById('mTam').value=r?r.tam||'':(c.tam||'');
    if(document.getElementById('mPrio')) document.getElementById('mPrio').value=r?r.prio||'NORMAL':(c.prioridade||'NORMAL');
    // Auto-preenche tipo de lote e defeito padr√£o do cat√°logo
    const _tl=(r&&r.tipoLote)||(c&&c.tipoLote)||'PADR√ÉO';
    if(typeof selTipoLote==='function') selTipoLote(_tl);
    if(refAcabEl){ refAcabEl.value=r?r.refAcabada||'':(c.refAcabada||''); refAcabEl.style.opacity=''; refAcabEl.readOnly=false; }
    // Preview de foto na modal de nova ordem
    const fotoPreviewModal = document.getElementById('mFotoPreview');
    if(fotoPreviewModal){
      if(r&&r.foto){ fotoPreviewModal.style.display='block'; fotoPreviewModal.innerHTML=`<img src="${r.foto}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);cursor:pointer;" onclick="verFotoAmpliada('${v}')" title="Ver foto">`; }
      else fotoPreviewModal.style.display='none';
    }
    // Preview de acess√≥rios
    const prevEl=document.getElementById('mAcessoriosPreview');
    if(prevEl&&r&&(r.acessoriosInternos?.length||r.acessoriosExternos?.length)){
      const rows=[
        ...(r.acessoriosInternos||[]).map(a=>`<span style="background:rgba(139,92,246,.1);color:#c4b5fd;border:1px solid rgba(139,92,246,.25);border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;">üî© INT ¬∑ ${a.ref||''} ${a.cor||''} ${a.tam||''} ¬∑ ${a.qtd||1} un</span>`),
        ...(r.acessoriosExternos||[]).map(a=>`<span style="background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.25);border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;">üì¶ EXT ¬∑ ${a.ref||''} ${a.cor||''} ${a.tam||''} ¬∑ ${a.qtd||1} un</span>`)
      ];
      prevEl.style.display='block';
      prevEl.innerHTML=`<div style="font-size:10px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.07em;">Acess√≥rios do cadastro</div><div style="display:flex;flex-wrap:wrap;gap:5px;">${rows.join('')}</div>`;
    } else if(prevEl){ prevEl.style.display='none'; }
  } else {
    // BUG 7 FIX: ref n√£o cadastrada ‚Äî libera campo ref acabada para edi√ß√£o manual e sinaliza
    if(refAcabEl){ refAcabEl.readOnly=false; refAcabEl.style.opacity=''; refAcabEl.placeholder='Digite a ref. acabada manualmente'; refAcabEl.style.borderColor=v.length>3?'var(--accent)':''; }
    const prevEl=document.getElementById('mAcessoriosPreview');
    if(prevEl) prevEl.style.display='none';
    const fotoPreviewModal=document.getElementById('mFotoPreview');
    if(fotoPreviewModal) fotoPreviewModal.style.display='none';
  }
}

// ‚ïê‚ïê SALVAR ORDEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function salvarOrdem(){
  const nr=document.getElementById('mNr').value.trim();
  const ref=document.getElementById('mRef').value.trim().toUpperCase();
  const qtd=parseInt(document.getElementById('mQtd').value)||0;
  if(!nr||!ref||qtd<1){ toast('Preencha campos obrigat√≥rios (*)','err'); return; }
  if(DB.ordens.find(o=>o.nr===nr)){ toast('Ordem '+nr+' j√° existe!','err'); return; }
  const cadRef=DB.refs.find(x=>x.ref===ref)||{};
  const cat=CATALOGO.find(x=>x.ref===ref)||{};
  const tipoLote = document.getElementById('mTipoLote')?.value || 'PADR√ÉO';
  const novaOrdem={
    nr, ref, qtd,
    tipoLote,
    isRetrabalho:  tipoLote==='RETRABALHO',
    isRecuperavel: tipoLote==='RECUPERAVEL',
    refAcabada: document.getElementById('mRefAcab')?.value||(cadRef.refAcabada||cat.refAcabada||''),
    desc:    document.getElementById('mDesc').value||cadRef.desc||cat.desc||'',
    produto: document.getElementById('mProd').value||cadRef.produto||cat.produto||'',
    tam:     document.getElementById('mTam').value||cadRef.tam||'',
    prazo:   document.getElementById('mPrazo').value,
    prio:    document.getElementById('mPrio').value,
    obs:     document.getElementById('mObs').value,
    acessoriosInternos: cadRef.acessoriosInternos||[],
    acessoriosExternos: cadRef.acessoriosExternos||[],
    criado:  new Date().toLocaleString('pt-BR'),
  };
  DB.ordens.push(novaOrdem);
  // Entrada autom√°tica na FILA IMPRESS√ÉO
  DB.lancamentos.push({
    id:Date.now(), dt:new Date().toLocaleString('pt-BR'),
    nr:novaOrdem.nr, ref:novaOrdem.ref, desc:novaOrdem.desc||'',
    proc:'FILA IMPRESS√ÉO', sub:'', colab:'SISTEMA', ent:0, sai:0, qbr:0,
    motivo:'', hini:'', hfim:'', obs:'Entrada autom√°tica na fila', turno:'', pcHora:null,
    filaAuto:true,
  });
  audit('NOVA ORDEM','Ordem #'+nr+' ('+tipoLote+') criada ‚Äî Ref: '+ref+' Qtde: '+qtd,{nr,ref,qtd,tipoLote});
  save();
  atualizarBadgeGargalo();
  renderPorOrdem();

  // Mostra painel de confirma√ß√£o com op√ß√µes de impress√£o
  const modalBg=document.getElementById('modalBg');
  const c=document.getElementById('modalContent');
  c.innerHTML=`
    <h3 style="color:var(--green);">‚úÖ Ordem Criada!</h3>
    <div style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:16px;margin-bottom:18px;text-align:center;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:var(--accent);">#${nr}</div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-top:4px;">${ref}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px;">${novaOrdem.desc||''} ¬∑ ${qtd} pe√ßas</div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--muted);text-align:center;margin-bottom:14px;text-transform:uppercase;letter-spacing:.07em;">O que deseja imprimir?</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <button class="btn btn-bl" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:6px;border-radius:10px;" onclick="imprimirOrdem('${nr}')">
        <span style="font-size:28px;">üñ®Ô∏è</span>
        <span>ORDEM DE PRODU√á√ÉO</span>
        <span style="font-size:10px;font-weight:400;opacity:.7;">Folha completa com processos</span>
      </button>
      <button class="btn btn-pu" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:6px;border-radius:10px;" onclick="imprimirEtiqueta('${nr}')">
        <span style="font-size:28px;">üè∑Ô∏è</span>
        <span>ETIQUETA</span>
        <span style="font-size:10px;font-weight:400;opacity:.7;">Etiqueta com c√≥digo de barras</span>
      </button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:6px;">
      <button class="btn btn-gn" style="padding:12px;" onclick="imprimirAmbos('${nr}')">
        üñ®Ô∏è + üè∑Ô∏è IMPRIMIR AMBOS
      </button>
      <button class="btn btn-gy" style="padding:12px;" onclick="irOrdem('${nr}');fecharModal()">
        ‚Üí ABRIR ORDEM
      </button>
    </div>
    <div style="text-align:center;margin-top:8px;">
      <button onclick="fecharModal()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;text-decoration:underline;">Fechar sem imprimir</button>
    </div>`;
  modalBg.classList.add('open');
}

// ‚ïê‚ïê SALVAR COLABORADOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function salvarColab(){
  const nome=document.getElementById('cNome').value.trim();
  if(!nome){ toast('Informe o nome','err'); return; }
  if(DB.colaboradores.find(c=>c.nome.toLowerCase()===nome.toLowerCase())){
    toast('Colaborador j√° cadastrado','err'); return;
  }
  DB.colaboradores.push({
    nome,
    matricula: (document.getElementById('cMatricula')?.value||'').trim(),
    turno: document.getElementById('cTurno').value,
    setor: document.getElementById('cSetor').value,
    ativo: (document.getElementById('cAtivo')?.value||'true')==='true',
    cadastrado: true,
    criado: new Date().toLocaleString('pt-BR')
  });
  audit('COLABORADOR','Colaborador cadastrado: '+nome);
  save(); fecharModal(); toast('‚úÖ Colaborador cadastrado!');
  preencherSelectColab();
  renderColaboradores();
}

// ‚ïê‚ïê LAN√áAMENTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buscarOrdem(){
  const v=document.getElementById('scanInput').value.trim();
  if(!v){ toast('Digite ou bipe o n√∫mero da ordem','err'); return; }
  const o=DB.ordens.find(x=>x.nr===v||x.nr===v.replace(/\D/g,''));
  if(!o){ toast('Ordem "'+v+'" n√£o encontrada ‚Äî crie primeiro','err'); return; }
  ordemAtual=o; procAtual=null;
  renderOrderCard(o);
  document.getElementById('scanInput').value='';
  document.getElementById('scanInput').focus();
  preencherSelectColab();
}

function renderOrderCard(o){
  const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
  const done=[...new Set(lans.map(l=>l.proc))];
  const doneReais=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
  const qbr=lans.reduce((s,l)=>s+(l.qbr||0),0);
  const ent=lans.reduce((s,l)=>s+(l.ent||0),0);
  const pct=ent>0?(qbr/ent*100).toFixed(1):0;
  const diasRestantes=o.prazo?Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)):null;
  const prazoColor=diasRestantes===null?'':diasRestantes<0?'rd':diasRestantes<=3?'ac':'gn';
  const prev=calcPrevisao(o);
  const qtdDisp = calcQtdDisponivel(o.nr);

  // MELHORIA 12: Calcula h√° quantos dias a ordem est√° sem movimenta√ß√£o real
  const lansReais=lans.filter(l=>!l.filaAuto&&l.dt);
  let diasParada=null;
  if(lansReais.length&&!isOrdemConcluida(lans)){
    const ultimo=lansReais[lansReais.length-1];
    // dt formato "dd/mm/yyyy, hh:mm:ss"
    const partes=ultimo.dt.split(/[/,\s:]+/);
    if(partes.length>=3){
      const dtUltimo=new Date(+partes[2],+partes[1]-1,+partes[0]);
      diasParada=Math.floor((new Date()-dtUltimo)/(1000*60*60*24));
    }
  }

  const fracoes = DB.ordens.filter(f=>f.ordemPai===o.nr);
  const fracConsolidado = fracoes.length ? (() => {
    const totalFracPcs = fracoes.reduce((s,f)=>s+f.qtd,0);
    const fracConcluidas = fracoes.filter(f=>{ const dl=DB.lancamentos.filter(l=>l.nr===f.nr); const dd=[...new Set(dl.filter(l=>temSaida(l)).map(l=>l.proc))]; return isOrdemConcluida(dl); }).length;
    return `<div class="oi" style="grid-column:1/-1;background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.3);">
      <div class="oi-l">Sublotes</div>
      <div class="oi-v bl">${fracConcluidas}/${fracoes.length} conclu√≠dos ¬∑ ${totalFracPcs} p√ß fracionadas</div>
    </div>`;
  })() : '';

  const cadRef = DB.refs.find(x=>x.ref===o.ref);
  const fotoOrdem = cadRef?.foto || null;
  const fotoOiHtml = fotoOrdem ? `<div class="oi" style="grid-column:1/-1;">
    <div class="oi-l">Foto</div>
    <div class="oi-v"><img src="${fotoOrdem}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);cursor:pointer;" onclick="verFotoAmpliada('${o.ref}')" title="Ver foto ampliada"></div>
  </div>` : '';

  document.getElementById('orderInfo').innerHTML=`
    <div class="oi"><div class="oi-l">N¬∫ Ordem</div><div class="oi-v ac">${o.nr}</div></div>
    <div class="oi"><div class="oi-l">Ref. Bruta</div><div class="oi-v bl">${o.ref}</div></div>
    ${o.refAcabada?`<div class="oi"><div class="oi-l">Ref. Acabada</div><div class="oi-v">${o.refAcabada}</div></div>`:''}
    <div class="oi"><div class="oi-l">Descri√ß√£o</div><div class="oi-v" style="font-size:12px">${o.desc||'‚Äî'}</div></div>
    <div class="oi"><div class="oi-l">Qtde ${o.isFracao?'Sublote':'Total'}</div><div class="oi-v">${o.qtd}</div></div>
    <div class="oi"><div class="oi-l">Qtde Dispon√≠vel</div><div class="oi-v ${qtdDisp<o.qtd?'ac':''}">${qtdDisp}</div></div>
    <div class="oi"><div class="oi-l">Etapas</div><div class="oi-v gn">${calcProgresso(lans)}/${N_PROC}</div></div>
    <div class="oi"><div class="oi-l">Quebra</div><div class="oi-v ${qbr>0?'rd':''}">${qbr} (${pct}%)</div></div>
    <div class="oi"><div class="oi-l">Prioridade</div><div class="oi-v">${prioBadge(o.prio)}</div></div>
    ${diasParada!==null?`<div class="oi" style="${diasParada>=3?'border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.06)':''}"><div class="oi-l">√öltima mov.</div><div class="oi-v ${diasParada>=3?'rd':diasParada>=1?'ac':''}">${diasParada===0?'Hoje':diasParada===1?'Ontem':diasParada+' dias atr√°s'}</div></div>`:''}
    ${diasRestantes!==null?`<div class="oi"><div class="oi-l">Prazo</div><div class="oi-v ${prazoColor}">${diasRestantes<0?'ATRASADO':diasRestantes+' dias'}</div></div>`:''}
    ${prev?`<div class="oi"><div class="oi-l">Previs√£o Conclus√£o</div><div class="oi-v" style="font-size:12px;color:var(--green)">${prev.texto}</div></div>`:''}
    ${(o.acessoriosInternos?.length||o.acessoriosExternos?.length)?`<div class="oi" style="grid-column:1/-1;">
      <div class="oi-l">Acess√≥rios</div>
      <div class="oi-v" style="display:flex;flex-wrap:wrap;gap:4px;">
        ${(o.acessoriosInternos||[]).map(a=>`<span style="background:rgba(139,92,246,.1);color:#c4b5fd;border:1px solid rgba(139,92,246,.2);border-radius:3px;font-size:9px;font-weight:800;padding:1px 6px;">üî© INT ${a.ref} ${a.cor?'¬∑ '+a.cor:''} ${a.tam?a.tam:''} ¬∑ ${a.qtd}un</span>`).join('')}
        ${(o.acessoriosExternos||[]).map(a=>`<span style="background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.2);border-radius:3px;font-size:9px;font-weight:800;padding:1px 6px;">üì¶ EXT ${a.ref} ${a.cor?'¬∑ '+a.cor:''} ${a.tam?a.tam:''} ¬∑ ${a.qtd}un</span>`).join('')}
      </div>
    </div>`:''}
    ${fotoOiHtml}
    ${fracConsolidado}
    ${diasParada!==null&&diasParada>=3?`<div class="oi" style="grid-column:1/-1;background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.35);">
      <div style="display:flex;align-items:center;gap:8px;color:#fca5a5;font-size:12px;font-weight:700;">
        <span style="font-size:18px;">‚è∏Ô∏è</span>
        <span>Ordem parada h√° <strong>${diasParada} dias</strong> sem movimenta√ß√£o${diasRestantes!==null&&diasRestantes<diasParada?' ‚Äî prazo em risco!':''}</span>
      </div>
    </div>`:''}
  `;

  // ‚îÄ‚îÄ Roteiro t√©cnico da refer√™ncia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const roteiroRef = DB.refs.find(x=>x.ref===o.ref) || {};
  const temRoteiro = Object.keys(roteiroRef.subPadrao||{}).length > 0;
  const roteiroEl = document.getElementById('ordemRoteiroPanel');
  if(roteiroEl){
    roteiroEl.style.display = 'block';
    const roteiroHtml = buildRoteiroHTMLOrdem(o.ref, lans);
    const temConf = temRoteiro;
    roteiroEl.innerHTML = `
      <details ${temConf ? 'open' : ''} style="margin-bottom:12px;">
        <summary style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;padding:8px 12px;background:var(--bg3);border:1px solid ${temConf?'rgba(59,130,246,.3)':'var(--border)'};border-radius:8px;font-size:11px;font-weight:800;color:${temConf?'#93c5fd':'var(--muted)'};">
          <span>üó∫Ô∏è</span>
          <span>Roteiro T√©cnico ‚Äî ${temConf ? 'Roteiro definido' : 'Sem roteiro cadastrado'}</span>
          ${!temConf ? '<span style="font-size:9px;opacity:.7;margin-left:auto;">Fa√ßa o piloto e cadastre na aba Refer√™ncias</span>' : ''}
        </summary>
        <div style="background:var(--bg3);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;padding:10px 12px;">
          ${roteiroHtml}
        </div>
      </details>`;
  }

  const grid=document.getElementById('procGrid');
  grid.innerHTML='';
  PROCESSOS.forEach(p=>{
    const lansProc=lans.filter(l=>l.proc===p.nome);
    const soFila=lansProc.length>0 && lansProc.every(l=>l.filaAuto);
    const temEntrada=lansProc.some(l=>!l.filaAuto && l.ent>0 && !temSaida(l));
    const temSaidaReal=lansProc.some(l=>temSaida(l));
    const naoSeAplica=lansProc.some(l=>l.naoSeAplica);
    // FILA IMPRESS√ÉO √© gerenciada automaticamente ‚Äî bloqueia clique manual
    const isFilaAuto = p.nome==='FILA IMPRESS√ÉO';
    // Fila conclu√≠da automaticamente quando IMPRESS√ÉO 3D tem entrada
    const imp3dTemEntrada = lans.some(l=>l.proc==='IMPRESS√ÉO 3D'&&!l.filaAuto);
    const filaAutoFinalizada = isFilaAuto && (temSaidaReal || imp3dTemEntrada);
    const btn=document.createElement('button');
    let cls='proc-btn';
    let ico='';
    // Conta sub-passagens registradas (ehSubPassagem=true)
    const subPassagens=lansProc.filter(l=>l.ehSubPassagem);
    const subBadge=subPassagens.length>0?`<span style="background:rgba(245,158,11,.25);color:var(--accent);font-size:8px;font-weight:900;padding:1px 5px;border-radius:3px;margin-left:4px;">+${subPassagens.length} sub</span>`:'';
    if(naoSeAplica){ cls+=' nao-aplica'; ico='‚è≠ '; }
    else if(temSaidaReal||filaAutoFinalizada){ cls+=' done'; ico=isFilaAuto?'ü§ñ ':''; }
    else if(temEntrada||subPassagens.length>0){ cls+=' em-processo'; ico='üîÑ '; }
    else if(soFila&&!isFilaAuto){ cls+=' em-fila'; ico='‚è≥ '; }
    else if(isFilaAuto&&soFila){ cls+=' em-fila'; }
    btn.className=cls;
    btn.innerHTML=`<span class="proc-num">${p.id}</span>${ico}${p.nome}${isFilaAuto?'<span style="font-size:8px;color:var(--muted);margin-left:4px;">(AUTO)</span>':''}${subBadge}`;
    if(isFilaAuto){
      // Fila n√£o √© clic√°vel manualmente ‚Äî s√≥ mostra o status
      btn.style.cursor='default';
      btn.title='Gerenciado automaticamente ‚Äî finaliza ao iniciar Impress√£o 3D';
      btn.onclick=()=>toast('A Fila de Impress√£o √© gerenciada automaticamente','info');
    } else {
      btn.onclick=()=>selecionarProc(p,btn);
    }
    grid.appendChild(btn);
  });

  const oc=document.getElementById('orderCard');
  oc.className='order-card show'+(o.isRetrabalho?' retrabalho':'')+(o.isRecuperavel?' recuperavel':'')+(o.isFracao?' fracao':'');
  const oldBanner=oc.querySelector('.order-card-banner');
  if(oldBanner) oldBanner.remove();
  if(o.isRecuperavel){
    const banner=document.createElement('div');
    banner.className='order-card-banner';
    banner.style.cssText='background:rgba(245,158,11,.1);border-bottom:1px solid rgba(245,158,11,.3);padding:8px 14px;margin:-18px -18px 14px;border-radius:10px 10px 0 0;font-size:11px;font-weight:700;color:#fbbf24;';
    banner.innerHTML='üîÑ RECUPER√ÅVEL &nbsp;|&nbsp; Origem: <strong>#'+o.ordemOrigem+'</strong>'+(o.procInicio?' &nbsp;|&nbsp; Entra em: <strong>'+o.procInicio+'</strong>':'')+(o.motivoDefeito?' &nbsp;|&nbsp; '+o.motivoDefeito:'');
    oc.insertBefore(banner,oc.firstChild);
  }
  if(o.isRetrabalho){
    const banner=document.createElement('div');
    banner.className='order-card-banner';
    banner.innerHTML='üîÅ RETRABALHO &nbsp;|&nbsp; Origem: <strong>#'+o.ordemOrigem+'</strong> &nbsp;|&nbsp; Fase: <strong>'+o.faseQuebra+'</strong> &nbsp;|&nbsp; Motivo: <strong>'+o.motivoRetrabalho+'</strong>';
    oc.insertBefore(banner,oc.firstChild);
  }
  if(o.isFracao){
    const banner=document.createElement('div');
    banner.className='order-card-banner';
    banner.style.cssText='background:rgba(59,130,246,.1);border-bottom:1px solid rgba(59,130,246,.25);padding:8px 14px;margin:-18px -18px 14px;border-radius:10px 10px 0 0;display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#93c5fd;';
    banner.innerHTML='‚úÇÔ∏è SUBLOTE F'+o.fracaoIdx+' &nbsp;|&nbsp; Ordem pai: <strong style="cursor:pointer;text-decoration:underline;" onclick="irOrdem(\''+o.ordemPai+'\')">#'+o.ordemPai+'</strong> &nbsp;|&nbsp; <strong>'+o.qtd+'</strong> pe√ßas deste lote';
    oc.insertBefore(banner,oc.firstChild);
  }
  // Render fracoes panel (s√≥ para ordem pai)
  renderFracoesPanel(o);
  // Fracionar sempre disponivel ‚Äî mesmo em sublotes e em qualquer etapa
  const acoesEl = document.getElementById('ordemAcoes');
  if(acoesEl) acoesEl.style.display = 'flex';
  document.getElementById('formBox').classList.remove('show');
  procAtual=null;
}

const PROCESSOS_METAL=['FUNDI√á√ÉO','CORTE DE √ÅRVORE','LIXA','ACABAMENTO AUTOM√ÅTICO','SOLDA','MONTAGEM','CRAVA√á√ÉO METAL','ENVIADO PARA REVIS√ÉO'];

function procUsaMetal(nome){ return PROCESSOS_METAL.includes(nome); }

function autoMetalPerda(){
  const ent=parseFloat(document.getElementById('fMetalEnt').value)||0;
  const sai=parseFloat(document.getElementById('fMetalSai').value)||0;
  const row=document.getElementById('metalPerdaRow');
  if(ent>0&&sai>=0&&sai<ent){
    const perda=(ent-sai).toFixed(2);
    const pct=(((ent-sai)/ent)*100).toFixed(1);
    document.getElementById('metalPerdaVal').textContent=perda+'g';
    document.getElementById('metalPerdaPct').textContent='('+pct+'% de perda)';
    row.style.display='flex';
  } else {
    row.style.display='none';
  }
}
function calcQtdDisponivel(ordemNr){
  const ordem = DB.ordens.find(o=>o.nr===ordemNr);
  if(!ordem) return 0;
  const lans = DB.lancamentos.filter(l=>l.nr===ordemNr);
  const totalQbr = lans.reduce((s,l)=>s+(l.qbr||0),0);
  // Desconta fra√ß√µes normais
  const fracoes = DB.ordens.filter(f=>f.ordemPai===ordemNr);
  const totalFracionado = fracoes.reduce((s,f)=>s+f.qtd,0);
  // Desconta lotes recuper√°veis vinculados (essas pe√ßas est√£o em recupera√ß√£o)
  const recuperaveis = DB.ordens.filter(o=>o.isRecuperavel&&o.ordemOrigem===ordemNr);
  const totalRecuperavel = recuperaveis.reduce((s,o)=>s+o.qtd,0);
  return Math.max(0, ordem.qtd - totalQbr - totalFracionado - totalRecuperavel);
}

function pularProcesso(){
  if(!ordemAtual||!procAtual){ toast('Selecione um processo','err'); return; }
  const proc = PROCESSOS.find(p=>p.nome===procAtual);
  if(!proc||!proc.skipavel){ toast('Este processo n√£o pode ser pulado','err'); return; }
  // Registra como "n√£o se aplica"
  const lan = {
    id: Date.now(),
    dt: new Date().toLocaleString('pt-BR'),
    nr: ordemAtual.nr, ref: ordemAtual.ref, desc: ordemAtual.desc||'',
    proc: procAtual, sub: 'N√ÉO SE APLICA', colab: 'SISTEMA',
    ent: 0, sai: 0, qbr: 0, saiPreenchida: true,
    motivo: '', hini: '', hfim: '', obs: 'Processo n√£o se aplica a esta pe√ßa',
    turno: getTurno(), pcHora: null, naoSeAplica: true,
    metalTipo: null, metalEnt: null, metalSai: null, metalPerda: null
  };
  DB.lancamentos.push(lan);
  audit('N√ÉO SE APLICA', 'Processo "'+procAtual+'" marcado como n√£o se aplica ‚Äî Ordem #'+ordemAtual.nr, {nr:ordemAtual.nr, proc:procAtual});
  save();
  atualizarBadgeGargalo();
  renderOrderCard(ordemAtual);
  document.getElementById('formBox').classList.remove('show');
  procAtual = null;
  toast('‚è≠ Processo pulado ‚Äî marcado como N√£o se Aplica','info');
}

function adicionarItemQbrDetalhe(){
  const container = document.getElementById('qbrDetalhesList');
  const idx = container.children.length;
  const div = document.createElement('div');
  div.style.cssText='background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;position:relative;';
  div.innerHTML=`
    <button onclick="this.parentElement.remove()" style="position:absolute;top:6px;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;">‚úï</button>
    <div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:8px;">DEFEITO ${idx+1}</div>
    <div class="g3" style="gap:8px;margin-bottom:8px;">
      <div class="fg"><div class="fl">Quantidade</div><input class="fi qbr-det-qtd" type="number" min="1" placeholder="0" oninput="atualizarTotalQbrDetalhe()"></div>
      <div class="fg"><div class="fl">Motivo</div>
        <select class="fi qbr-det-motivo">
          <option value="">Selecione...</option>
          <option>Porosidade</option><option>Mal formados</option><option>N√£o formou</option>
          <option>Falha de impress√£o</option><option>Manchado</option><option>√Åspero</option>
          <option>Risco</option><option>Outro</option>
        </select>
      </div>
      <div class="fg"><div class="fl">Tipo *</div>
        <select class="fi qbr-det-tipo" onchange="toggleRetornoProc(this)">
          <option value="">Selecione...</option>
          <option value="definitivo">‚ùå Defeito Definitivo</option>
          <option value="recuperavel">üîÑ Defeito Recuper√°vel</option>
        </select>
      </div>
    </div>
    <div class="qbr-det-retorno" style="display:none;">
      <div class="fg"><div class="fl">‚Ü© Retornar para qual processo?</div>
        <select class="fi qbr-det-proc-retorno">
          ${PROCESSOS.filter(p=>p.nome!=='REVIS√ÉO BRUTO'&&p.nome!=='ENVIADO PARA REVIS√ÉO').map(p=>`<option value="${p.nome}">${p.id} ${p.nome}</option>`).join('')}
        </select>
      </div>
    </div>`;
  container.appendChild(div);
}

function toggleRetornoProc(sel){
  const retornoDiv = sel.closest('div[style]').querySelector('.qbr-det-retorno');
  retornoDiv.style.display = sel.value==='recuperavel'?'block':'none';
}

function atualizarTotalQbrDetalhe(){
  const total = [...document.querySelectorAll('.qbr-det-qtd')].reduce((s,el)=>s+(parseInt(el.value)||0),0);
  const saiEl = document.getElementById('fSai');
  const entEl = document.getElementById('fEnt');
  const ent = parseInt(entEl.value)||0;
  if(ent>0){ saiEl.value = Math.max(0, ent-total); autoQbr(); }
}

function selecionarProc(proc,btn){
  document.querySelectorAll('.proc-btn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  procAtual=proc.nome;
  document.getElementById('procNome').textContent=proc.nome;
  // Turno atual
  const turno=getTurno();
  const tb=document.getElementById('turnoAtual');
  tb.textContent=turno; tb.className='badge '+turnoBadgeClass(turno);
  // Sub-processos
  const sr=document.getElementById('subRow'),fs=document.getElementById('fSub');
  const btnSubLanc = document.getElementById('btnSubLancamento');
  if(proc.subs&&proc.subs.length){
    fs.innerHTML='<option value="">Nao se aplica</option>';
    proc.subs.forEach(s=>{ const o=document.createElement('option');o.textContent=s;fs.appendChild(o); });
    sr.classList.remove('hidden');
    // Mostra botao de sub-passagem para processos com sublancamentos (ex: LIXA)
    if(btnSubLanc) btnSubLanc.style.display='block';
  } else {
    sr.classList.add('hidden');
    if(btnSubLanc) btnSubLanc.style.display='none';
  }

  // Bot√£o pular processo
  const skipRow = document.getElementById('skipProcRow');
  if(skipRow) skipRow.style.display = proc.skipavel ? 'block' : 'none';

  // Revis√£o Bruto: mostra UI especial
  const revisaoBrutoBox = document.getElementById('revisaoBrutoBox');
  const confirmBtn = document.querySelector('[onclick="lancar()"]');
  if(proc.temQuebraDetalhada){
    if(revisaoBrutoBox) revisaoBrutoBox.style.display='block';
    if(confirmBtn) confirmBtn.style.display='none';
    document.getElementById('qbrDetalhesList').innerHTML='';
  } else {
    if(revisaoBrutoBox) revisaoBrutoBox.style.display='none';
    if(confirmBtn) confirmBtn.style.display='';
  }

  // Sugest√£o de entrada: sa√≠da do processo anterior (descontando quebras)
  const lans=DB.lancamentos.filter(l=>l.nr===ordemAtual.nr);
  const idx=PROCESSOS.findIndex(p=>p.nome===proc.nome);
  const sugEl=document.getElementById('sugEntrada');

  // Auto-propaga√ß√£o: pega sa√≠da do processo anterior e preenche como entrada
  let entradaAutoProc = 0;
  if(idx>0){
    // Encontrar o √∫ltimo processo com sa√≠da real (pulando os "n√£o se aplica")
    for(let i=idx-1;i>=0;i--){
      const procAnterior=PROCESSOS[i].nome;
      const lanAnterior=lans.filter(l=>l.proc===procAnterior&&temSaida(l)&&!l.naoSeAplica);
      if(lanAnterior.length){
        const saiAnterior=lanAnterior.reduce((s,l)=>s+(l.sai||0),0);
        sugEl.textContent='üí° Entrada autom√°tica de "'+procAnterior+'": '+saiAnterior+' pe√ßas';
        sugEl.classList.remove('hidden');
        entradaAutoProc = saiAnterior;
        break;
      }
    }
    if(!entradaAutoProc) sugEl.classList.add('hidden');
  } else { sugEl.classList.add('hidden'); }

  // Hora atual
  const n=new Date();
  document.getElementById('fHini').value=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
  document.getElementById('fHfim').value='';
  document.getElementById('fQbr').value='';
  document.getElementById('fMotivo').selectedIndex=0;
  document.getElementById('motivoRow').classList.add('hidden');
  document.getElementById('qboxQuebra').style.display='none';
  document.getElementById('fSai').style.color='';

  // Verifica se j√° tem entrada lan√ßada sem sa√≠da para este processo
  const lansExist=ordemAtual?DB.lancamentos.filter(l=>l.nr===ordemAtual.nr&&l.proc===proc.nome&&!l.filaAuto&&l.ent>0&&!temSaida(l)):[];
  const subPassagensExist=lansExist.filter(l=>l.ehSubPassagem);
  const entradaPendente=lansExist.filter(l=>!l.ehSubPassagem).reduce((s,l)=>s+(l.ent||0),0);

  // Banner de sub-passagens ja registradas
  const subInfoBanner=document.getElementById('subPassagensBanner');
  if(subPassagensExist.length>0){
    if(subInfoBanner){
      subInfoBanner.style.display='flex';
      subInfoBanner.innerHTML=`<span style="font-size:18px;">üîÑ</span><span>${subPassagensExist.length} sub-passagem(ns) ja registrada(s): <strong>${subPassagensExist.map(l=>l.sub||'‚Äî').join(', ')}</strong>. Lance mais passagens ou confirme o lancamento final.</span>`;
    }
  } else {
    if(subInfoBanner) subInfoBanner.style.display='none';
  }

  if(entradaPendente>0){
    // J√° tem entrada: bloqueia entrada e foca na sa√≠da
    document.getElementById('fEnt').value=entradaPendente;
    document.getElementById('fEnt').readOnly=true;
    document.getElementById('fEnt').style.opacity='0.6';
    document.getElementById('fSai').value='';
    const banner=document.getElementById('entradaBanner');
    if(banner){ banner.style.display='flex'; banner.querySelector('span').textContent='Entrada j√° registrada: '+entradaPendente+' pe√ßas. Informe a sa√≠da para avan√ßar.'; }
    document.getElementById('formBox').classList.add('show');
    setTimeout(()=>document.getElementById('fSai').focus(),100);
  } else {
    document.getElementById('fEnt').readOnly=false;
    document.getElementById('fEnt').style.opacity='';
    const banner=document.getElementById('entradaBanner');
    if(banner) banner.style.display='none';
    // Auto-preenche entrada com sa√≠da do processo anterior
    if(entradaAutoProc>0){
      document.getElementById('fEnt').value=entradaAutoProc;
      autoQbr();
    } else {
      // Preenche com quantidade dispon√≠vel (descontando quebras)
      const qtdDisp = calcQtdDisponivel(ordemAtual.nr);
      if(qtdDisp>0) document.getElementById('fEnt').value=qtdDisp;
      else document.getElementById('fEnt').value='';
    }
    document.getElementById('fSai').value='';
    document.getElementById('formBox').classList.add('show');
    setTimeout(()=>document.getElementById('fSai').focus(),100);
  }

  // Metal: mostra a se√ß√£o somente nos processos que usam metal
  const metalRowEl = document.getElementById('metalRow');
  if(metalRowEl){
    if(procUsaMetal(proc.nome)){
      metalRowEl.classList.remove('hidden');
      const mTipo = document.getElementById('fMetalTipo');
      const mEnt  = document.getElementById('fMetalEnt');
      const mSai  = document.getElementById('fMetalSai');
      if(mTipo) mTipo.value='';
      if(mEnt)  mEnt.value='';
      if(mSai)  mSai.value='';
      const mp = document.getElementById('metalPerdaRow');
      if(mp) mp.style.display='none';
    } else {
      metalRowEl.classList.add('hidden');
    }
  }
  // MELHORIA 15: auto-seleciona sub-processo padr√£o da refer√™ncia
  if(proc.subs&&proc.subs.length) setTimeout(aplicarSubPadrao, 0);
}

function autoQbr(){
  const entEl=document.getElementById('fEnt');
  const saiEl=document.getElementById('fSai');
  const ent=parseInt(entEl.value)||0;
  const sai=parseInt(saiEl.value);
  const saiPreenchida=saiEl.value!==''&&!isNaN(sai);
  const temQuebra=saiPreenchida&&ent>0&&sai<ent;
  const q=temQuebra?ent-sai:0;
  // Caixa de quebra: s√≥ aparece se sa√≠da foi preenchida E √© menor que entrada
  const qboxEl=document.getElementById('qboxQuebra');
  if(temQuebra){
    qboxEl.style.display='';
    document.getElementById('fQbr').value=q;
  } else {
    qboxEl.style.display='none';
    document.getElementById('fQbr').value='';
  }
  // Motivo: s√≥ aparece junto com quebra
  document.getElementById('motivoRow').classList.toggle('hidden',!temQuebra);
  // Feedback visual no campo sa√≠da
  if(saiPreenchida&&ent>0){
    saiEl.style.color=sai<ent?'var(--red)':sai===ent?'var(--green)':'var(--text)';
  } else {
    saiEl.style.color='';
  }
}

function lancar(){
  if(!ordemAtual||!procAtual){ toast('Selecione um processo','err'); return; }
  const procNome = procAtual;
  const ent = parseInt(document.getElementById('fEnt').value)||0;
  const saiRaw = document.getElementById('fSai').value;
  const sai = saiRaw===''?-1:parseInt(saiRaw)||0;
  const qbr = parseInt(document.getElementById('fQbr').value)||0;
  const col = document.getElementById('fColab').value;
  if(ent<1){ toast('Informe a quantidade de entrada','err'); return; }
  if(!col){ toast('Selecione o colaborador','err'); return; }
  const saiPreenchida = saiRaw!=='' && sai>=0;
  if(saiPreenchida && qbr>0){
    if(!document.getElementById('fMotivo').value){ toast('Selecione o tipo de defeito','err'); return; }
    if(!document.getElementById('fTipoDefeito')?.value){ toast('Defina se o defeito √© Recuper√°vel ou Definitivo','err'); return; }
    if(document.getElementById('fTipoDefeito').value==='RECUPERAVEL' && !document.getElementById('fProcRetorno')?.value){
      toast('Selecione o processo de retorno para o defeito recuper√°vel','err'); return;
    }
  }
  const hini = document.getElementById('fHini').value;
  const hfim = document.getElementById('fHfim').value;
  const turno = getTurno(hini||null);
  const pcHora = saiPreenchida ? calcPcHora({hini,hfim,sai}) : null;
  let metalTipo=null, metalEnt=null, metalSai=null, metalPerda=null;
  if(procUsaMetal(procNome)){
    const mTipoEl = document.getElementById('fMetalTipo');
    const mEntEl  = document.getElementById('fMetalEnt');
    const mSaiEl  = document.getElementById('fMetalSai');
    if(mTipoEl) metalTipo = mTipoEl.value||null;
    if(mEntEl)  metalEnt  = parseFloat(mEntEl.value)||null;
    if(mSaiEl)  metalSai  = parseFloat(mSaiEl.value)||null;
    if(metalEnt && metalSai!==null) metalPerda = parseFloat((metalEnt - (metalSai||0)).toFixed(2));
  }
  const tipoDefeito = document.getElementById('fTipoDefeito')?.value||'';
  const procRetorno  = document.getElementById('fProcRetorno')?.value||'';
  const lan = {
    id: Date.now(),
    dt: new Date().toLocaleString('pt-BR'),
    nr: ordemAtual.nr, ref: ordemAtual.ref, desc: ordemAtual.desc||'',
    proc: procNome,
    sub: document.getElementById('fSub').value||'',
    colab: col,
    ent, sai: saiPreenchida?sai:0, qbr,
    saiPreenchida,
    motivo: document.getElementById('fMotivo').value||'',
    tipoDefeito,
    procRetorno: tipoDefeito==='RECUPERAVEL'?procRetorno:'',
    hini, hfim, obs: document.getElementById('fObs').value||'',
    turno, pcHora,
    metalTipo, metalEnt, metalSai, metalPerda
  };
  DB.lancamentos.push(lan);

  // Se lan√ßou IMPRESS√ÉO 3D com entrada, finaliza automaticamente FILA IMPRESS√ÉO
  if(procNome==='IMPRESS√ÉO 3D'){
    DB.lancamentos.filter(l=>l.nr===ordemAtual.nr&&l.filaAuto&&l.proc==='FILA IMPRESS√ÉO').forEach(l=>{ l.filaIniciada=true; l.saiPreenchida=true; l.sai=ent; l.ent=ent; l.obs='Finalizada automaticamente ao iniciar Impress√£o 3D'; });
  }

  // Marca fila impress√£o como iniciada no primeiro lan√ßamento real
  if(procNome!=='FILA IMPRESS√ÉO'){
    DB.lancamentos.filter(l=>l.nr===ordemAtual.nr&&l.filaAuto).forEach(l=>l.filaIniciada=true);
  }
  const statusStr = saiPreenchida?'SA√çDA REGISTRADA':'ENTRADA REGISTRADA';
  audit('LAN√áAMENTO', statusStr+': Ordem #'+ordemAtual.nr+' | '+procNome+' | '+col+' | Ent:'+ent+' Sai:'+(saiPreenchida?sai:'‚Äî')+' Qbr:'+qbr, lan);
  save();
  if(saiPreenchida) atualizarMetaDia(procNome, sai);
  atualizarBadgeGargalo();

  // ‚îÄ‚îÄ Tratar defeito registrado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(saiPreenchida && qbr>0 && tipoDefeito){
    const _nr = ordemAtual.nr;
    const _def = lan.motivo;
    const _proc = procNome;
    const _qtd = qbr;
    if(tipoDefeito==='RECUPERAVEL'){
      // Sublote entra no processo escolhido ‚Äî abre modal de confirma√ß√£o
      const _ret = procRetorno;
      const bg=document.getElementById('modalBg');
      const mc=document.getElementById('modalContent');
      mc.innerHTML=`
        <h3 style="color:var(--accent);">üîÑ Confirmar Lote Recuper√°vel</h3>
        <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:12px;margin-bottom:14px;">
          <div style="font-size:11px;font-weight:700;color:#fbbf24;margin-bottom:4px;">DEFEITO RECUPER√ÅVEL REGISTRADO</div>
          <div style="font-size:12px;line-height:1.6;">
            <b>Ordem:</b> #${_nr} &nbsp;|&nbsp; <b>Defeito:</b> ${_def}<br>
            <b>${_qtd} pe√ßas</b> retornam a partir de: <b style="color:var(--accent)">${_ret}</b>
          </div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">Um novo sublote ser√° criado e entrar√° direto em <b>${_ret}</b>. As pe√ßas ser√£o descontadas do lote original.</div>
        </div>
        <div class="mbtns">
          <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
          <button class="mbtn btn-ac" onclick="gerarLoteRecuperavel('${_nr}',${_qtd},'${_ret}','${_def}')">üîÑ CRIAR SUBLOTE DE RECUPERA√á√ÉO</button>
        </div>`;
      bg.classList.add('open');
    } else if(tipoDefeito==='DEFINITIVO'){
      // Retrabalho autom√°tico ‚Äî abre modal de confirma√ß√£o
      const bg=document.getElementById('modalBg');
      const mc=document.getElementById('modalContent');
      mc.innerHTML=`
        <h3 style="color:var(--red);">‚ö†Ô∏è Confirmar Retrabalho</h3>
        <div style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:12px;margin-bottom:14px;">
          <div style="font-size:11px;font-weight:700;color:#fca5a5;margin-bottom:4px;">QUEBRA DEFINITIVA ‚Äî RETRABALHO DO ZERO</div>
          <div style="font-size:12px;line-height:1.6;">
            <b>Ordem:</b> #${_nr} &nbsp;|&nbsp; <b>Defeito:</b> ${_def}<br>
            <b>${_qtd} pe√ßas</b> ser√£o refeitas do zero na <b style="color:var(--red)">FILA IMPRESS√ÉO</b>
          </div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">O lote original continua normalmente sem essas pe√ßas. Um novo lote independente ser√° gerado.</div>
        </div>
        <div class="mbtns">
          <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
          <button class="mbtn btn-rd" onclick="gerarRetrabalhoAuto('${_nr}',${_qtd},'${_def}','${_proc}')">‚ö†Ô∏è GERAR RETRABALHO</button>
        </div>`;
      bg.classList.add('open');
    }
  }

  if(!saiPreenchida){
    renderOrderCard(ordemAtual);
    document.getElementById('formBox').classList.remove('show');
    procAtual = null;
    toast('üì• Entrada registrada! Lance a sa√≠da para avan√ßar.','info');
    setTimeout(()=>{
      const btn = Array.from(document.querySelectorAll('.proc-btn')).find(b=>b.textContent.includes(procNome));
      if(btn){ btn.click(); btn.scrollIntoView({behavior:'smooth',block:'center'}); }
    },350);
  } else {
    renderOrderCard(ordemAtual);
    document.getElementById('formBox').classList.remove('show');
    procAtual = null;
    const lansNow = DB.lancamentos.filter(l=>l.nr===ordemAtual.nr);
    const doneComSaida = [...new Set(lansNow.filter(l=>l.saiPreenchida||(!l.filaAuto&&l.sai>0)).map(l=>l.proc))];
    const proxProc = PROCESSOS.find(p=>!doneComSaida.includes(p.nome));
    const pcMsg = pcHora?' | '+pcHora+' p√ß/h':'';
    if(proxProc){
      toast('‚úÖ Sa√≠da lan√ßada'+pcMsg+' ‚Üí '+proxProc.nome,'info');
      setTimeout(()=>{
        const btn = Array.from(document.querySelectorAll('.proc-btn')).find(b=>b.textContent.includes(proxProc.nome));
        if(btn){ btn.click(); btn.scrollIntoView({behavior:'smooth',block:'center'}); }
      },350);
    } else {
      toast('üéâ Ordem '+ordemAtual.nr+' CONCLU√çDA! Todos os processos finalizados.','ok');
      audit('CONCLUS√ÉO','Ordem #'+ordemAtual.nr+' conclu√≠da com todos os processos',{nr:ordemAtual.nr});
    }
  }
}

// Sub-passagem: registra uma passagem adicional no mesmo processo (ex: lixa interna + lixa externa)
// NAO conclui o processo ‚Äî permite lancar quantas passagens quiser antes de finalizar
function lancarSubPassagem(){
  if(!ordemAtual||!procAtual){ toast('Selecione um processo','err'); return; }
  const ent = parseInt(document.getElementById('fEnt').value)||0;
  const col = document.getElementById('fColab').value;
  const sub = document.getElementById('fSub').value||'';
  if(ent<1){ toast('Informe a quantidade de entrada','err'); return; }
  if(!col){ toast('Selecione o colaborador','err'); return; }
  if(!sub){ toast('Selecione o sub-processo para registrar a passagem','err'); return; }
  const hini = document.getElementById('fHini').value;
  const hfim = document.getElementById('fHfim').value;
  const pcHora = calcPcHora({hini, hfim, sai: ent}); // usa ent como producao da passagem
  const lan = {
    id: Date.now(),
    dt: new Date().toLocaleString('pt-BR'),
    nr: ordemAtual.nr, ref: ordemAtual.ref, desc: ordemAtual.desc||'',
    proc: procAtual,
    sub,
    colab: col,
    ent, sai: 0, qbr: 0,
    saiPreenchida: false,
    ehSubPassagem: true,
    motivo: '', hini, hfim,
    obs: document.getElementById('fObs').value||'Sub-passagem: '+sub,
    turno: getTurno(hini||null), pcHora,
    metalTipo:null, metalEnt:null, metalSai:null, metalPerda:null
  };
  DB.lancamentos.push(lan);
  audit('SUB-PASSAGEM','Passagem adicional: Ordem #'+ordemAtual.nr+' | '+procAtual+' | Sub: '+sub+' | '+col+' | '+ent+' pcs',lan);
  save();
  // Recarrega o form mantendo o processo selecionado para continuar lancando
  renderOrderCard(ordemAtual);
  // Re-seleciona o processo para permitir proximo lancamento
  setTimeout(()=>{
    const btn = Array.from(document.querySelectorAll('.proc-btn')).find(b=>b.textContent.includes(procAtual));
    if(btn){ btn.click(); }
  },200);
  toast('‚ûï Sub-passagem "'+sub+'" registrada! Lance a proxima passagem ou confirme o lancamento final.','info');
}

// Lan√ßamento especial para REVIS√ÉO BRUTO com classifica√ß√£o de defeitos
function lancarRevisaoBruto(){
  if(!ordemAtual){ toast('Selecione uma ordem','err'); return; }
  const col = document.getElementById('fColab').value;
  const ent = parseInt(document.getElementById('fEnt').value)||0;
  if(!col){ toast('Selecione o colaborador','err'); return; }
  if(ent<1){ toast('Informe a quantidade de entrada','err'); return; }

  const itens = [];
  let totalQbrDef=0, totalQbrRec=0;
  const linhas = document.querySelectorAll('#qbrDetalhesList > div');
  for(const linha of linhas){
    const qtd = parseInt(linha.querySelector('.qbr-det-qtd')?.value)||0;
    const motivo = linha.querySelector('.qbr-det-motivo')?.value||'';
    const tipo = linha.querySelector('.qbr-det-tipo')?.value||'';
    if(qtd<1||!tipo){ toast('Preencha todos os campos de defeito corretamente','err'); return; }
    const procRetorno = tipo==='recuperavel'?(linha.querySelector('.qbr-det-proc-retorno')?.value||'IMPRESS√ÉO 3D'):'';
    if(tipo==='definitivo') totalQbrDef+=qtd;
    else totalQbrRec+=qtd;
    itens.push({qtd,motivo,tipo,procRetorno});
  }
  const totalQbr = totalQbrDef+totalQbrRec;
  const sai = Math.max(0, ent-totalQbr);

  const hini = document.getElementById('fHini').value;
  const hfim = document.getElementById('fHfim').value;
  const turno = getTurno(hini||null);

  const lan = {
    id: Date.now(), dt: new Date().toLocaleString('pt-BR'),
    nr: ordemAtual.nr, ref: ordemAtual.ref, desc: ordemAtual.desc||'',
    proc: 'REVIS√ÉO BRUTO', sub: '', colab: col,
    ent, sai, qbr: totalQbr, saiPreenchida: true,
    motivo: itens.map(i=>i.tipo==='definitivo'?'[DEF] '+i.motivo:'[REC‚Üí'+i.procRetorno+'] '+i.motivo).join(' | '),
    qbrDef: totalQbrDef, qbrRec: totalQbrRec,
    qbrItens: itens,
    hini, hfim, obs: document.getElementById('fObs').value||'',
    turno, pcHora: null, metalTipo:null, metalEnt:null, metalSai:null, metalPerda:null
  };
  DB.lancamentos.push(lan);
  audit('REVIS√ÉO BRUTO','Ordem #'+ordemAtual.nr+' | Ent:'+ent+' Sai:'+sai+' QbrDef:'+totalQbrDef+' QbrRec:'+totalQbrRec, lan);

  // Gerar ordens de retrabalho para quebras recuper√°veis
  for(const item of itens.filter(i=>i.tipo==='recuperavel')){
    const rNum = DB.ordens.filter(o=>o.ordemOrigem===ordemAtual.nr).length+1;
    const newNr = ordemAtual.nr+'-R'+rNum;
    DB.ordens.push({
      nr:newNr, ref:ordemAtual.ref, desc:ordemAtual.desc||'', qtd:item.qtd,
      tam:ordemAtual.tam||'', prazo:ordemAtual.prazo||'', prio:ordemAtual.prio||'NORMAL',
      obs:'Retrabalho recuper√°vel ‚Äî '+item.motivo+' (retorno: '+item.procRetorno+')',
      criado:new Date().toLocaleString('pt-BR'),
      isRetrabalho:true, ordemOrigem:ordemAtual.nr,
      motivoRetrabalho:item.motivo, faseQuebra:'REVIS√ÉO BRUTO',
      qbrOrigem:item.qtd, procRetornoRetrabalho:item.procRetorno
    });
    // Retrabalho retorna ao processo correto (nao sempre FILA IMPRESS√ÉO)
    const procRetorno = item.procRetorno || 'IMPRESS√ÉO 3D';
    const procRetornoObj = PROCESSOS.find(p=>p.nome===procRetorno);
    DB.lancamentos.push({
      id:Date.now()+Math.random(), dt:new Date().toLocaleString('pt-BR'),
      nr:newNr, ref:ordemAtual.ref, desc:ordemAtual.desc||'',
      proc: procRetorno==='IMPRESS√ÉO 3D'?'FILA IMPRESS√ÉO':procRetorno,
      sub:'', colab:'SISTEMA', ent:0, sai:0, qbr:0,
      motivo:'', hini:'', hfim:'',
      obs:'Retrabalho recuper√°vel ‚Äî retorno ao processo: '+procRetorno,
      turno:'', pcHora:null,
      filaAuto: procRetorno==='IMPRESS√ÉO 3D' // s√≥ √© filaAuto se retornar desde o in√≠cio
    });
    toast('üîÑ Retrabalho #'+newNr+' gerado ('+item.qtd+'p√ß ‚Üí '+item.procRetorno+')','info');
  }

  save();
  atualizarBadgeGargalo();
  renderOrderCard(ordemAtual);
  document.getElementById('formBox').classList.remove('show');
  document.getElementById('revisaoBrutoBox').style.display='none';
  procAtual = null;
  toast('‚úÖ Revis√£o Bruto conclu√≠da! '+totalQbrDef+' definitivos, '+totalQbrRec+' recuper√°veis.','ok');
}



function atualizarMetaDia(proc,sai){
  const hoje=new Date().toISOString().slice(0,10);
  if(!DB.metas._realizado) DB.metas._realizado={};
  if(!DB.metas._realizado[hoje]) DB.metas._realizado[hoje]={};
  if(!DB.metas._realizado[hoje][proc]) DB.metas._realizado[hoje][proc]=0;
  DB.metas._realizado[hoje][proc]+=sai;
}

// ‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function prioBadge(p){
  if(!p||p.trim()==='NORMAL') return '<span class="badge b-gy">NORMAL</span>';
  if(p.includes('URG√ä')||p.includes('URGENTE')||p.includes('URGE')) return '<span class="badge b-yw">URGENTE</span>';
  if(p.includes('CR√çT')||p.includes('CRIT√çCO')||p.includes('CR√çTICO')||p.includes('CRITICO')) return '<span class="badge b-rd">CR√çTICO</span>';
  return '<span class="badge b-gy">'+p+'</span>';
}
function statusBadge(done,total){ return done===total?'<span class="badge b-gn">CONCLU√çDA</span>':'<span class="badge b-yw">EM ANDAMENTO</span>'; }

// ‚ïê‚ïê POR ORDEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedOrdens=new Set();
function toggleSelectOrdem(nr,cb){ if(cb.checked) selectedOrdens.add(nr); else selectedOrdens.delete(nr); updatePrintToolbar(); }
function updatePrintToolbar(){
  const tb=document.getElementById('printToolbar'),cnt=document.getElementById('printCount');
  if(!tb) return;
  const n=selectedOrdens.size;
  if(n>0){ tb.style.display='flex'; cnt.textContent=n+' ordem'+(n>1?'s':'')+' selecionada'+(n>1?'s':''); } else { tb.style.display='none'; }
}
function limparSelecao(){ selectedOrdens.clear(); updatePrintToolbar(); renderPorOrdem(); }

function renderPorOrdem(){
  const filt=document.getElementById('filtOrdemPO').value.toLowerCase();
  const fStatus=document.getElementById('filtStatusPO').value;
  const fPrio=document.getElementById('filtPrioPO').value;
  let ords=DB.ordens.slice().reverse();
  if(filt) ords=ords.filter(o=>o.nr.toLowerCase().includes(filt)||o.ref.toLowerCase().includes(filt)||(o.desc||'').toLowerCase().includes(filt));
  if(fPrio) ords=ords.filter(o=>(o.prio||'').includes(fPrio.replace('URG√äNTE','URG√ä').replace('CRIT√çCO','CR√çT')));
  if(fStatus) ords=ords.filter(o=>{ const done=[...new Set(DB.lancamentos.filter(l=>l.nr===o.nr&&temSaida(l)).map(l=>l.proc))].length; const ol2=DB.lancamentos.filter(l=>l.nr===o.nr); return fStatus==='concluida'?isOrdemConcluida(ol2):!isOrdemConcluida(ol2); });
  const el=document.getElementById('ordemLista');
  if(!ords.length){ el.innerHTML='<div class="empty"><div class="empty-ico">üìã</div><p>Nenhuma ordem encontrada.</p></div>'; return; }
  el.innerHTML=ords.map(o=>{
    const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
    const done=[...new Set(lans.map(l=>l.proc))];
    const doneReais=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
    const qbr=lans.reduce((s,l)=>s+(l.qbr||0),0);
    const ent=lans.reduce((s,l)=>s+(l.ent||0),0);
    const pct=ent>0?(qbr/ent*100).toFixed(1):0;
    const prog=Math.round(calcProgresso(lans)/N_PROC*100);
    const diasR=o.prazo?Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)):null;
    const isSel=selectedOrdens.has(o.nr);
    const prev=calcPrevisao(o);
    // Fra√ß√µes
    const fracoes = DB.ordens.filter(f=>f.ordemPai===o.nr);
    const fracBadge = fracoes.length ? `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.3);border-radius:12px;font-size:10px;font-weight:900;padding:1px 7px;">‚úÇÔ∏è ${fracoes.length} sublotes</span>` : '';
    const fracaoInfo = o.isFracao ? `<span style="background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.3);border-radius:4px;font-size:9px;font-weight:900;padding:1px 6px;">F${o.fracaoIdx} de ${o.totalFracoes}</span>` : '';
    const fracSummaryHTML = fracoes.length ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(42,53,72,.4);">
      <div style="font-size:9px;font-weight:800;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:5px;">SUBLOTES</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;">
        ${fracoes.map(f=>{
          const fl=DB.lancamentos.filter(l=>l.nr===f.nr);
          const fd=[...new Set(fl.filter(l=>temSaida(l)).map(l=>l.proc))];
          const fp=Math.round(calcProgresso(fl)/N_PROC*100);
          const fa=PROCESSOS.find(p=>!fd.includes(p.nome));
          return `<div onclick="event.stopPropagation();irOrdem('${f.nr}')" style="cursor:pointer;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--blue)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:900;color:#93c5fd;">${f.nr.split('-F')[1]?'F'+f.nr.split('-F')[1]:f.nr}</div>
            <div style="font-size:9px;color:var(--muted);">${f.qtd}p√ß</div>
            <div style="font-size:9px;color:${fp===100?'var(--green)':'var(--muted)'};">${fa?fa.nome.substring(0,10)+'‚Ä¶':'‚úì'}</div>
            <div style="height:3px;background:var(--border);border-radius:2px;margin-top:2px;width:48px;"><div style="height:100%;border-radius:2px;background:${fp===100?'var(--green)':'var(--blue)'};width:${fp}%"></div></div>
          </div>`;
        }).join('')}
      </div>
    </div>` : '';
    return `<div class="card" style="margin-bottom:8px;border-color:${isSel?'var(--blue)':o.isFracao?'rgba(59,130,246,.3)':'var(--border)'};background:${isSel?'rgba(59,130,246,.06)':o.isFracao?'rgba(59,130,246,.03)':'var(--card)'}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;flex-wrap:wrap;">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <label style="display:flex;align-items:center;cursor:pointer;margin-top:4px;" onclick="event.stopPropagation()">
            <input type="checkbox" ${isSel?'checked':''} onchange="toggleSelectOrdem('${o.nr}',this)" style="width:18px;height:18px;accent-color:var(--blue);cursor:pointer;"></label>
          <div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;cursor:pointer;" onclick="irOrdem('${o.nr}')">
              <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--accent)">#${o.nr}</span>
              ${statusBadge(calcProgresso(lans),N_PROC)} ${prioBadge(o.prio)} ${o.isRetrabalho?'<span class="rt-badge">üîÅ RETRABALHO</span>':o.isRecuperavel?'<span class="rt-badge" style="background:rgba(245,158,11,.2);color:#fbbf24;border-color:rgba(245,158,11,.4);">üîÑ RECUPER√ÅVEL</span>':''} ${fracBadge} ${fracaoInfo}
              ${diasR!==null?`<span class="badge ${diasR<0?'b-rd':diasR<=3?'b-yw':'b-gy'}">${diasR<0?'ATRASADO':diasR+'d'}</span>`:''}
            </div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;cursor:pointer;" onclick="irOrdem('${o.nr}')">${o.ref} ¬∑ ${o.desc||''} ¬∑ Qtde: ${o.qtd} ¬∑ Quebra: ${qbr}p√ß (${pct}%) ${prev&&prev.dias>0?'¬∑ Previs√£o: '+prev.texto:''}${o.isFracao?` ¬∑ Pai: #${o.ordemPai}`:''}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;">
          <div style="text-align:right;"><div style="font-size:13px;font-weight:700;color:var(--accent)">${calcProgresso(lans)}/${N_PROC} etapas</div>
            <div class="prog" style="width:100px;margin-top:4px;"><div class="prog-f ${prog<50?'yw':''}" style="width:${prog}%"></div></div></div>
          <div style="display:flex;gap:4px;">
            <button class="btn" style="background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.3);padding:4px 8px;font-size:10px;" onclick="event.stopPropagation();imprimirOrdem('${o.nr}')">üñ®Ô∏è OP</button>
            ${o.isFracao?`<button class="btn" style="background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.3);padding:4px 8px;font-size:10px;" onclick="event.stopPropagation();imprimirEtiquetaFracao('${o.nr}')">üè∑Ô∏è Fra√ß√£o</button>`:`<button class="btn" style="background:rgba(139,92,246,.1);color:#c4b5fd;border:1px solid rgba(139,92,246,.3);padding:4px 8px;font-size:10px;" onclick="event.stopPropagation();imprimirEtiqueta('${o.nr}')">üè∑Ô∏è Etiq</button>`}
          </div>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;cursor:pointer;" onclick="irOrdem('${o.nr}')">
        ${PROCESSOS.map(p=>{
          const lansProc=lans.filter(l=>l.proc===p.nome);
          const isDoneReal=lansProc.some(l=>temSaida(l));
          const isEmAndamento=lansProc.some(l=>!l.filaAuto&&l.ent>0&&!temSaida(l));
          const isEmFila=lansProc.length>0&&lansProc.every(l=>l.filaAuto);
          const isNaoSeAplica=lansProc.some(l=>l.naoSeAplica);
          const style=isDoneReal?'background:rgba(16,185,129,.1);color:#6ee7b7;border:1px solid rgba(16,185,129,.2)':isNaoSeAplica?'background:rgba(100,116,139,.08);color:var(--muted);border:1px solid var(--border);opacity:.6':isEmAndamento?'background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.3)':isEmFila?'background:rgba(245,158,11,.1);color:#fcd34d;border:1px solid rgba(245,158,11,.3)':'background:var(--bg3);color:var(--muted);border:1px solid var(--border)';
          const ico=isNaoSeAplica?'‚è≠ ':isEmAndamento?'üîÑ ':isEmFila?'‚è≥ ':'';
          return `<span style="padding:2px 7px;border-radius:4px;font-size:9px;font-weight:800;text-transform:uppercase;${style}">${ico}${p.id} ${p.nome}</span>`;
        }).join('')}
      </div>
      ${fracSummaryHTML}
    </div>`;
  }).join('');
}
function irOrdem(nr){ document.getElementById('scanInput').value=nr; document.querySelectorAll('.tab')[0].click(); buscarOrdem(); }

// ‚ïê‚ïê POR PROCESSO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPorProcesso(){
  const filtP=document.getElementById('filtProcPP').value;
  const el=document.getElementById('processoLista');
  const procs=filtP?PROCESSOS.filter(p=>p.nome===filtP):PROCESSOS;
  // Alertas de gargalo
  const alertasEl=document.getElementById('alertasProcesso');
  const gargalos=calcGargalos().filter(g=>g.aguardando>5);
  alertasEl.innerHTML=gargalos.length?`<div class="alerta-gargalo"><span class="alerta-pulse"></span><strong style="color:#fca5a5;">GARGALOS DETECTADOS:</strong> ${gargalos.map(g=>`<span class="badge b-rd">${g.proc}: ${g.aguardando} ordens</span>`).join(' ')}</div>`:'';
  el.innerHTML='';
  procs.forEach(p=>{
    const ords=DB.ordens.filter(o=>{
      const lansO=DB.lancamentos.filter(l=>l.nr===o.nr);
      if(p.nome==='FILA IMPRESS√ÉO'){
        // Em fila: tem filaAuto mas nenhum lan√ßamento real ainda
        const filaLans=lansO.filter(l=>l.proc==='FILA IMPRESS√ÉO');
        const realLans=lansO.filter(l=>!l.filaAuto);
        return filaLans.length>0 && filaLans.every(l=>l.filaAuto) && realLans.length===0;
      }
      // Em processo: lan√ßou entrada (sem sa√≠da) NESTE processo
      const lansProc=lansO.filter(l=>l.proc===p.nome&&!l.filaAuto);
      const temEntradaSemSaida=lansProc.some(l=>l.ent>0&&!temSaida(l));
      if(temEntradaSemSaida) return true;
      // Aguardando: pr√≥ximo processo sem nenhum lan√ßamento
      const doneComSaida=[...new Set(lansO.filter(l=>temSaida(l)).map(l=>l.proc))];
      const prox=PROCESSOS.find(pr=>!doneComSaida.includes(pr.nome)&&pr.nome!=='FILA IMPRESS√ÉO');
      return prox&&prox.nome===p.nome;
    });
    const lans=DB.lancamentos.filter(l=>l.proc===p.nome);
    const ent=lans.reduce((s,l)=>s+(l.ent||0),0);
    const qbr=lans.reduce((s,l)=>s+(l.qbr||0),0);
    const pct=ent>0?(qbr/ent*100).toFixed(1):0;
    const isGargalo=ords.length>5;
    const card=document.createElement('div');
    card.className='proc-view-card';
    const isFilaProc = p.nome==='FILA IMPRESS√ÉO';
    card.style.borderColor=isGargalo?'rgba(239,68,68,.4)':isFilaProc&&ords.length?'rgba(245,158,11,.5)':'var(--border)';
    if(isFilaProc&&ords.length) card.style.background='rgba(245,158,11,.04)';
    card.innerHTML=`<div class="proc-view-title" style="display:flex;align-items:center;gap:8px;">${isGargalo?'<span class="alerta-pulse"></span>':''} ${p.id} ‚Äî ${p.nome}
        ${isFilaProc&&ords.length?`<span style="font-size:10px;background:rgba(245,158,11,.15);color:var(--accent);border:1px solid rgba(245,158,11,.3);border-radius:4px;padding:1px 7px;font-weight:800;">‚è≥ ${ords.length} AGUARDANDO IN√çCIO</span>`:`<span style="font-size:11px;font-weight:600;color:${isGargalo?'var(--red)':'var(--muted)'};margin-left:4px;">${ords.length} ordens aguardando ¬∑ ${lans.filter(l=>!l.filaAuto).length} lan√ßamentos ¬∑ Quebra: ${pct}%</span>`}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        ${ords.length?ords.map(o=>{ const diasR=o.prazo?Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)):null; return `<div class="ref-chip" onclick="irOrdem('${o.nr}')" style="${isFilaProc?'border-color:rgba(245,158,11,.4);':''}"><span style="color:var(--accent)">#${o.nr}</span><span>${o.ref}</span>${isFilaProc?`<span style="font-size:9px;background:rgba(245,158,11,.15);color:var(--accent);padding:1px 5px;border-radius:3px;font-weight:800;">‚è≥ EM FILA</span>`:''}${prioBadge(o.prio)}${diasR!==null?`<span class="badge ${diasR<0?'b-rd':diasR<=3?'b-yw':'b-gy'}">${diasR<0?'ATRAS':diasR+'d'}</span>`:''}</div>`; }).join(''):'<span style="color:var(--muted);font-size:12px;">Nenhuma ordem aguardando</span>'}
      </div>`;
    el.appendChild(card);
  });
}

// ‚ïê‚ïê REFER√äNCIAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReferencias(){
  const filt=document.getElementById('filtRef').value.toLowerCase();
  const el=document.getElementById('refLista');
  let refs=CATALOGO;
  if(filt) refs=refs.filter(r=>r.ref.toLowerCase().includes(filt)||r.produto.toLowerCase().includes(filt)||r.desc.toLowerCase().includes(filt));
  if(!refs.length){ el.innerHTML='<div class="empty"><div class="empty-ico">üîç</div><p>Nenhuma refer√™ncia encontrada.</p></div>'; return; }
  el.innerHTML=refs.map(r=>{
    const ords=DB.ordens.filter(o=>o.ref===r.ref);
    const lans=DB.lancamentos.filter(l=>l.ref===r.ref);
    const procsComLan=[...new Set(lans.map(l=>l.proc))];
    return `<div class="card" style="margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
        <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--accent)">${r.ref} <span style="font-size:13px;color:var(--muted)">${r.refAcabada}</span></div>
          <div style="font-size:13px;font-weight:700;">${r.desc}</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">${r.produto}</div></div>
        <div style="text-align:right;">${prioBadge(r.prioridade)}${r.processoAtual?`<div style="margin-top:5px;"><span class="badge b-yw">üìç ${r.processoAtual}</span></div>`:''}</div>
      </div>
      ${ords.length?`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;">${ords.map(o=>`<div class="ref-chip" onclick="irOrdem('${o.nr}')"><span style="color:var(--accent)">#${o.nr}</span> Qtde:${o.qtd} ${statusBadge(calcProgresso(DB.lancamentos.filter(l=>l.nr===o.nr)),N_PROC)}</div>`).join('')}</div>`:''}
      ${procsComLan.length?`<div class="ref-timeline">${PROCESSOS.map(p=>`<span class="rt-step ${procsComLan.includes(p.nome)?'rt-done':'rt-pending'}">${p.id} ${p.nome}</span>`).join('')}</div>`:'<div style="font-size:11px;color:var(--muted);">Nenhum lan√ßamento registrado.</div>'}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê RETRABALHO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MOTIVOS_RETRABALHO=['Defeito definitivo','N√£o formou'];
function gerarRetrabalho(q){
  const qtd=parseInt(document.getElementById('rQtd').value)||0;
  const nr=document.getElementById('rNr').value;
  const obs=document.getElementById('rObs').value;
  if(qtd<1){ toast('Informe a quantidade','err'); return; }
  const ordemOrig=DB.ordens.find(o=>o.nr===q.ordemNr)||{};
  DB.ordens.push({nr,ref:q.ref,desc:q.desc||'',qtd,tam:ordemOrig.tam||'',prazo:ordemOrig.prazo||'',prio:ordemOrig.prio||'NORMAL',obs:obs||('Retrabalho ‚Äî '+q.motivo+' em '+q.proc),criado:new Date().toLocaleString('pt-BR'),isRetrabalho:true,ordemOrigem:q.ordemNr,motivoRetrabalho:q.motivo,faseQuebra:q.proc,qbrOrigem:q.qbr});
  const novaOrdemRt=DB.ordens[DB.ordens.length-1];
  // Entrada autom√°tica na FILA IMPRESS√ÉO
  DB.lancamentos.push({
    id:Date.now(), dt:new Date().toLocaleString('pt-BR'),
    nr:novaOrdemRt.nr, ref:novaOrdemRt.ref, desc:novaOrdemRt.desc||'',
    proc:'FILA IMPRESS√ÉO', sub:'', colab:'SISTEMA', ent:0, sai:0, qbr:0,
    motivo:'', hini:'', hfim:'', obs:'Retrabalho ‚Äî entrada autom√°tica na fila', turno:'', pcHora:null,
    filaAuto:true
  });
  audit('RETRABALHO','Ordem de retrabalho #'+nr+' gerada a partir de #'+q.ordemNr+' ‚Äî na FILA IMPRESS√ÉO',{nr,ordemOrigem:q.ordemNr,motivo:q.motivo,qtd});
  save(); fecharModal();
  toast('‚úÖ Lote de retrabalho #'+nr+' na FILA IMPRESS√ÉO!','ok');
  atualizarBadgeGargalo();
  renderQuebras();
}

function renderRtHistorico(){
  const rts=DB.ordens.filter(o=>o.isRetrabalho);
  const el=document.getElementById('rtHistorico');
  if(!el) return;
  if(!rts.length){ el.innerHTML='<div class="empty"><div class="empty-ico">‚úÖ</div><p>Nenhum retrabalho gerado ainda.</p></div>'; return; }
  el.innerHTML=rts.map(r=>{
    const lans=DB.lancamentos.filter(l=>l.nr===r.nr);
    const prog=Math.round(calcProgresso(lans)/N_PROC*100);
    const color=prog===100?'var(--green)':'var(--accent)';
    return `<div class="qbr-hist-card"><div class="qbr-hist-header">
      <div><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;"><span class="rt-badge">üîÅ RETRABALHO</span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--red)">#${r.nr}</span>
        <span style="font-size:12px;color:var(--muted)">‚Üê Origem: <strong style="color:var(--accent)">#${r.ordemOrigem}</strong></span></div>
        <div style="font-size:12px;font-weight:700;">${r.ref} ¬∑ ${r.desc||''} ¬∑ Qtde: ${r.qtd}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">Fase: <strong style="color:#fca5a5">${r.faseQuebra}</strong> ¬∑ Motivo: <strong style="color:#fca5a5">${r.motivoRetrabalho}</strong> ¬∑ Qtde quebrada: <strong style="color:var(--red)">${r.qbrOrigem}</strong> ¬∑ Criado: ${r.criado}</div></div>
      <div style="text-align:right;flex-shrink:0;"><div style="font-size:12px;font-weight:700;color:${color}">${calcProgresso(lans)}/${N_PROC}</div>
        <div style="width:90px;height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:5px;margin-left:auto;"><div style="height:100%;border-radius:3px;background:${color};width:${prog}%"></div></div>
        <button class="btn btn-bl" style="margin-top:7px;padding:4px 10px;font-size:10px;" onclick="irOrdem('${r.nr}')">VER ORDEM</button></div>
    </div></div>`;
  }).join('');
}

// ‚ïê‚ïê QUEBRAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderQuebras(){
  const fRef=document.getElementById('filtQbrRef').value.toLowerCase();
  const fProc=document.getElementById('filtQbrProc').value;
  let lans=DB.lancamentos.filter(l=>l.qbr>0);
  if(fRef) lans=lans.filter(l=>l.ref.toLowerCase().includes(fRef));
  if(fProc) lans=lans.filter(l=>l.proc===fProc);
  const map={};
  lans.forEach(l=>{ const k=l.ref+'|'+l.proc; if(!map[k]) map[k]={ref:l.ref,desc:l.desc,proc:l.proc,sub:l.sub,ent:0,sai:0,qbr:0,motivos:[],ordemNr:l.nr}; map[k].ent+=l.ent||0;map[k].sai+=l.sai||0;map[k].qbr+=l.qbr||0; if(l.motivo) map[k].motivos.push(l.motivo); });
  const rows=Object.values(map).sort((a,b)=>b.qbr-a.qbr);
  const totalQbr=DB.lancamentos.reduce((s,l)=>s+(l.qbr||0),0);
  const totalEnt=DB.lancamentos.reduce((s,l)=>s+(l.ent||0),0);
  const pctG=totalEnt>0?(totalQbr/totalEnt*100).toFixed(1):0;
  const topRef=rows.length?rows[0].ref:'‚Äî';
  document.getElementById('qbrKpis').innerHTML=`
    <div class="kpi rd"><div class="kpi-v">${totalQbr}</div><div class="kpi-l">Total Quebras</div></div>
    <div class="kpi ac"><div class="kpi-v">${pctG}%</div><div class="kpi-l">% Quebra Geral</div></div>
    <div class="kpi pu"><div class="kpi-v">${rows.length}</div><div class="kpi-l">Ref√óProc com Quebra</div></div>
    <div class="kpi bl"><div class="kpi-v" style="font-size:18px">${topRef}</div><div class="kpi-l">Maior Quebra</div></div>`;
  const tb=document.getElementById('qbrTbl');
  if(!rows.length) tb.innerHTML='<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:20px">Nenhuma quebra registrada</td></tr>';
  else tb.innerHTML=rows.map(r=>{ const pct=r.ent>0?(r.qbr/r.ent*100).toFixed(1):0; const motivo=r.motivos.length?[...new Set(r.motivos)].join(', '):'‚Äî'; const al=parseFloat(pct)>=10?'b-rd':parseFloat(pct)>=5?'b-yw':'b-gn';
    return `<tr><td style="font-weight:800;color:var(--accent)">${r.ref}</td><td style="font-size:11px">${r.desc}</td><td style="font-size:11px;font-weight:700">${r.proc}</td><td style="font-size:11px;color:var(--muted)">${r.sub||'‚Äî'}</td><td>${r.ent}</td><td style="color:var(--green);font-weight:700">${r.sai}</td><td style="color:var(--red);font-weight:800">${r.qbr}</td><td><span class="badge ${al}">${pct}%</span></td><td style="font-size:11px;color:var(--muted)">${motivo}</td>
    <td>${MOTIVOS_RETRABALHO.some(m=>r.motivos.includes(m))?`<button class="btn btn-rd" style="padding:4px 10px;font-size:10px;" onclick="abrirModal('refazer-modelo',{ref:'${r.ref}',desc:'${r.desc}',proc:'${r.proc}',qbr:${r.qbr},pct:'${pct}',motivo:'${r.motivos.find(m=>MOTIVOS_RETRABALHO.includes(m))||'Defeito definitivo'}',ordemNr:'${r.ordemNr}'})">üîÅ REFAZER</button>`:'<span style="color:var(--muted)">‚Äî</span>'}</td></tr>`;
  }).join('');
  // Ranking
  const procMap={};
  DB.lancamentos.forEach(l=>{ if(!procMap[l.proc]) procMap[l.proc]={proc:l.proc,ent:0,qbr:0}; procMap[l.proc].ent+=l.ent||0;procMap[l.proc].qbr+=l.qbr||0; });
  const ranking=Object.values(procMap).filter(x=>x.qbr>0).sort((a,b)=>b.qbr-a.qbr);
  const el=document.getElementById('qbrRanking');
  if(!ranking.length){ el.innerHTML='<div class="empty"><div class="empty-ico">‚úÖ</div><p>Sem quebras registradas.</p></div>'; }
  else el.innerHTML=ranking.map(r=>{ const pct=r.ent>0?(r.qbr/r.ent*100).toFixed(1):0; const fc=parseFloat(pct)>=10?'rd':parseFloat(pct)>=5?'yw':'';
    return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;"><div style="width:180px;font-size:11px;font-weight:700;flex-shrink:0;">${r.proc}</div><div class="qbr-bar"><div class="qbr-fill ${fc}" style="width:${Math.min(100,parseFloat(pct)*5)}%"></div></div><div style="width:50px;text-align:right;font-size:12px;font-weight:800;color:${parseFloat(pct)>=10?'var(--red)':parseFloat(pct)>=5?'var(--accent)':'var(--green)'}">${pct}%</div><div style="width:50px;text-align:right;font-size:11px;color:var(--muted)">${r.qbr}p√ß</div></div>`;
  }).join('');
  renderRtHistorico();
  renderChartTendencia();
}

function renderChartTendencia(){
  const canvas=document.getElementById('chartTendencia');
  if(!canvas) return;
  // Agrupar por semana
  const semMap={};
  DB.lancamentos.forEach(l=>{
    if(!l.dt) return;
    // Extrair data
    const parts=l.dt.split(' ')[0].split('/');
    if(parts.length<3) return;
    const d=new Date(parts[2],parts[1]-1,parts[0]);
    const sem=getWeekKey(d);
    if(!semMap[sem]) semMap[sem]={ent:0,qbr:0};
    semMap[sem].ent+=l.ent||0; semMap[sem].qbr+=l.qbr||0;
  });
  const semanas=Object.keys(semMap).sort().slice(-10);
  const labels=semanas.map(s=>s);
  const pcts=semanas.map(s=>semMap[s].ent>0?(semMap[s].qbr/semMap[s].ent*100).toFixed(2):0);
  if(chartTendencia) chartTendencia.destroy();
  chartTendencia=new Chart(canvas,{type:'line',data:{labels,datasets:[{label:'% Quebra por Semana',data:pcts,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',tension:.4,pointBackgroundColor:'#ef4444',pointRadius:5,fill:true}]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'rgba(42,53,72,.5)'}},y:{ticks:{color:'#64748b',font:{size:10},callback:v=>v+'%'},grid:{color:'rgba(42,53,72,.5)'}}}}});
}
function getWeekKey(d){
  const jan1=new Date(d.getFullYear(),0,1);
  const w=Math.ceil(((d-jan1)/86400000+jan1.getDay()+1)/7);
  return d.getFullYear()+'-S'+String(w).padStart(2,'0');
}

function exportarQbrCSV(){
  const h=['Refer√™ncia','Descri√ß√£o','Processo','Sub Processo','Entrada','Sa√≠da','Quebra','% Quebra','Motivos'];
  const lans=DB.lancamentos.filter(l=>l.qbr>0);
  const map={};
  lans.forEach(l=>{ const k=l.ref+'|'+l.proc; if(!map[k]) map[k]={ref:l.ref,desc:l.desc,proc:l.proc,sub:l.sub,ent:0,sai:0,qbr:0,motivos:[],ordemNr:l.nr}; map[k].ent+=l.ent||0;map[k].sai+=l.sai||0;map[k].qbr+=l.qbr||0; if(l.motivo) map[k].motivos.push(l.motivo); });
  const rows=Object.values(map).map(r=>[r.ref,r.desc,r.proc,r.sub||'',r.ent,r.sai,r.qbr,r.ent>0?(r.qbr/r.ent*100).toFixed(1)+'%':'',[...new Set(r.motivos)].join('; ')]);
  const csv=[h,...rows].map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'})); a.download='quebras_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  const todosLans=DB.lancamentos, ords=DB.ordens;
  // Filtra lan√ßamentos pelo per√≠odo selecionado
  const lans = filtrarLansPeriodo(todosLans);
  // Label do per√≠odo
  const labelEl=document.getElementById('dashPeriodoLabel');
  if(labelEl){
    const {ini}=getDashDatas();
    const labels={hoje:'Mostrando dados de hoje',semana:'√öltimos 7 dias',mes:'Este m√™s (desde dia 1)',tudo:'Todos os dados hist√≥ricos'};
    labelEl.textContent=labels[_dashPeriodo]||'';
  }
  // KPIs: ordens usam DB inteiro (status √© estrutural), produ√ß√£o usa per√≠odo
  const conc=ords.filter(o=>isOrdemConcluida(todosLans.filter(l=>l.nr===o.nr))).length;
  const tEnt=lans.reduce((s,l)=>s+(l.ent||0),0);
  const tSai=lans.reduce((s,l)=>s+(l.sai||0),0);
  const tQbr=lans.reduce((s,l)=>s+(l.qbr||0),0);
  const pctG=tEnt>0?(tQbr/tEnt*100).toFixed(1):0;
  const atrasadas=ords.filter(o=>o.prazo&&new Date(o.prazo)<new Date()&&!isOrdemConcluida(todosLans.filter(l=>l.nr===o.nr))).length;
  const pcHoraMedia=lans.filter(l=>l.pcHora).map(l=>parseFloat(l.pcHora));
  const avgPcH=pcHoraMedia.length?(pcHoraMedia.reduce((s,v)=>s+v,0)/pcHoraMedia.length).toFixed(1):0;
  document.getElementById('dashKpis').innerHTML=`
    <div class="kpi ac"><div class="kpi-v">${ords.length}</div><div class="kpi-l">Total Ordens</div></div>
    <div class="kpi gn"><div class="kpi-v">${conc}</div><div class="kpi-l">Conclu√≠das</div></div>
    <div class="kpi bl"><div class="kpi-v">${ords.length-conc}</div><div class="kpi-l">Em Andamento</div></div>
    <div class="kpi rd"><div class="kpi-v">${atrasadas}</div><div class="kpi-l">Atrasadas</div></div>
    <div class="kpi gn"><div class="kpi-v">${tSai}</div><div class="kpi-l">P√ß Produzidas ${_dashPeriodo==='tudo'?'(total)':'(per√≠odo)'}</div></div>
    <div class="kpi rd"><div class="kpi-v">${pctG}%</div><div class="kpi-l">% Quebra ${_dashPeriodo==='tudo'?'Geral':'Per√≠odo'}</div></div>
    <div class="kpi ac"><div class="kpi-v">${lans.filter(l=>!l.filaAuto).length}</div><div class="kpi-l">Lan√ßamentos ${_dashPeriodo==='tudo'?'Total':'Per√≠odo'}</div></div>
    <div class="kpi gn"><div class="kpi-v">${avgPcH}</div><div class="kpi-l">P√ß/h M√©dia ${_dashPeriodo==='tudo'?'Geral':'Per√≠odo'}</div></div>`;
  // Prazo + Previs√£o (sempre com dados totais ‚Äî status √© permanente)
  const ordsComPrazo=ords.filter(o=>o.prazo).map(o=>{ const dias=Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)); const done=[...new Set(todosLans.filter(l=>l.nr===o.nr).map(l=>l.proc))]; const prox=PROCESSOS.find(p=>!done.includes(p.nome)); const prev=calcPrevisao(o); return{...o,dias,done,prox,prev}; }).filter(o=>!isOrdemConcluida(todosLans.filter(l=>l.nr===o.nr))).sort((a,b)=>a.dias-b.dias);
  document.getElementById('dashPrazo').innerHTML=!ordsComPrazo.length?'<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">Nenhuma ordem com prazo cadastrado</td></tr>':ordsComPrazo.map(o=>`<tr>
    <td style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent)">#${o.nr}</td>
    <td>${o.ref}</td><td style="font-size:11px">${o.prazo}</td>
    <td class="${o.dias<0?'dl-late':o.dias<=3?'dl-near':'dl-ok'}" style="font-weight:800">${o.dias<0?'ATRASADO '+Math.abs(o.dias)+'d':o.dias+'d'}</td>
    <td style="font-size:10px;color:${o.prev&&o.prev.dias>o.dias?'var(--red)':'var(--green)'}">${o.prev?o.prev.texto:'‚Äî'}</td>
    <td style="font-size:10px">${o.prox?o.prox.nome:'‚Äî'}</td>
    <td>${prioBadge(o.prio)}</td></tr>`).join('');
  // Capacidade ‚Äî usa lans do per√≠odo para contagem de aguardando
  const capEl=document.getElementById('dashCapac');
  capEl.innerHTML=PROCESSOS.map(p=>{ const pl=lans.filter(l=>l.proc===p.nome); const ent=pl.reduce((s,l)=>s+(l.ent||0),0); const qbr=pl.reduce((s,l)=>s+(l.qbr||0),0); const pct=ent>0?(qbr/ent*100).toFixed(1):0; const ordsAguardando=ords.filter(o=>{ const done=[...new Set(todosLans.filter(l=>l.nr===o.nr).map(l=>l.proc))]; const prox=PROCESSOS.find(pr=>!done.includes(pr.nome)); return prox&&prox.nome===p.nome; }).length;
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px;font-size:11px;"><span style="width:10px;height:10px;border-radius:50%;background:${ordsAguardando>5?'var(--red)':ordsAguardando>2?'var(--accent)':'var(--green)'};flex-shrink:0;${ordsAguardando>5?'animation:pulse 1.2s infinite':''}"></span><span style="width:175px;font-weight:700;flex-shrink:0;">${p.nome}</span><span class="badge ${ordsAguardando>5?'b-rd':ordsAguardando>2?'b-yw':'b-gy'}">${ordsAguardando} aguardando</span><span style="color:var(--muted)">${pct}% quebra</span></div>`;
  }).join('');
  // Metas
  renderDashMetas(lans);
  // Turnos ‚Äî usa lans filtrados
  renderDashTurnos(lans);
  // Geral
  document.getElementById('dashGeral').innerHTML=!ords.length?'<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px">Nenhuma ordem</td></tr>':ords.slice().reverse().map(o=>{ const ol=todosLans.filter(l=>l.nr===o.nr); const qbr=ol.reduce((s,l)=>s+(l.qbr||0),0); const ent=ol.reduce((s,l)=>s+(l.ent||0),0); const pct=ent>0?(qbr/ent*100).toFixed(1):0; const prog=Math.round(calcProgresso(ol)/N_PROC*100); const doneNomes=new Set(ol.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc)); const prox=PROCESSOS_REAIS.find(p=>!doneNomes.has(p.nome)&&!p.skipavel)||PROCESSOS_REAIS.find(p=>!doneNomes.has(p.nome)); const dias=o.prazo?Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)):null; const prev=calcPrevisao(o);
    return `<tr><td style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent)">#${o.nr}</td><td>${o.ref}</td><td style="font-size:11px">${o.desc||''}</td><td>${o.qtd}</td><td>${prioBadge(o.prio)}</td><td class="${dias===null?'':dias<0?'dl-late':dias<=3?'dl-near':'dl-ok'}" style="font-size:11px">${dias===null?'‚Äî':dias<0?'ATRASADO':dias+'d'}</td><td style="font-size:10px;color:${prev&&prev.dias>0&&dias!==null&&prev.dias>dias?'var(--red)':'var(--green)'}">${prev&&prev.dias>0?prev.texto:'‚Äî'}</td><td style="font-size:10px">${prox?prox.id+' '+prox.nome:'CONCLU√çDA'}</td><td><div style="font-size:11px;font-weight:700">${calcProgresso(ol)}/${N_PROC}</div><div class="prog"><div class="prog-f ${prog<50?'yw':''}" style="width:${prog}%"></div></div></td><td><span class="badge ${parseFloat(pct)>=8?'b-rd':parseFloat(pct)>=5?'b-yw':'b-gy'}">${ent>0?pct+'%':'‚Äî'}</span></td><td>${statusBadge(calcProgresso(ol),N_PROC)}</td></tr>`;
  }).join('');
}

function renderDashMetas(lansParam){
  // Se receber lans filtradas por per√≠odo, calcula realizado a partir delas
  // Caso contr√°rio, usa o _realizado do dia (legado)
  const el=document.getElementById('dashMetas');
  const hoje=new Date().toISOString().slice(0,10);
  el.innerHTML=PROCESSOS_REAIS.map(p=>{
    const meta=DB.metas[p.nome]||0;
    let realiz;
    if(lansParam){
      // Conta sa√≠das reais do per√≠odo filtrado para esse processo
      realiz=lansParam.filter(l=>l.proc===p.nome&&(l.sai||0)>0).reduce((s,l)=>s+(l.sai||0),0);
    } else {
      const real=(DB.metas._realizado&&DB.metas._realizado[hoje])||{};
      realiz=real[p.nome]||0;
    }
    const pct=meta>0?Math.min(100,Math.round(realiz/meta*100)):0;
    const cor=meta===0?'#64748b':pct>=100?'var(--green)':pct>=60?'var(--accent)':'var(--red)';
    return `<div class="meta-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><span style="font-size:11px;font-weight:700;">${p.nome}</span><span style="font-size:13px;font-weight:900;color:${cor}">${realiz}${meta>0?'/'+meta+' p√ß':'p√ß'}</span></div>
      ${meta>0?`<div class="meta-gauge"><div class="meta-fill" style="width:${pct}%;background:${cor};"></div></div><div style="font-size:10px;color:${cor};text-align:right;">${pct}%</div>`:'<div style="font-size:10px;color:var(--muted);">Meta n√£o definida</div>'}</div>`;
  }).join('');
}

function renderDashTurnos(lansParam){
  const src = lansParam || DB.lancamentos;
  const turnoMap={MANH√É:{ent:0,sai:0,qbr:0,lans:0},TARDE:{ent:0,sai:0,qbr:0,lans:0},NOITE:{ent:0,sai:0,qbr:0,lans:0}};
  src.forEach(l=>{ const t=l.turno||getTurno(l.hini||null); if(turnoMap[t]){turnoMap[t].ent+=l.ent||0;turnoMap[t].sai+=l.sai||0;turnoMap[t].qbr+=l.qbr||0;turnoMap[t].lans++;} });
  const el=document.getElementById('dashTurnos');
  el.innerHTML=Object.entries(turnoMap).map(([turno,d])=>{
    const pct=d.ent>0?(d.qbr/d.ent*100).toFixed(1):0;
    return `<div style="background:var(--bg3);border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
      <div><span class="badge ${turnoBadgeClass(turno)}" style="margin-bottom:4px;display:inline-block;">${turno}</span>
        <div style="font-size:11px;color:var(--muted);">${d.lans} lan√ßamentos ¬∑ ${d.sai} p√ß produzidas</div></div>
      <div style="text-align:right;"><div style="font-size:18px;font-weight:900;font-family:'Barlow Condensed',sans-serif;color:${parseFloat(pct)>8?'var(--red)':parseFloat(pct)>4?'var(--accent)':'var(--green)'}">${pct}%</div>
        <div style="font-size:10px;color:var(--muted);">quebra</div></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê HIST√ìRICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistorico(){
  const fo=document.getElementById('hFiltOrdem').value.toLowerCase();
  const fp=document.getElementById('hFiltProc').value;
  const fc=document.getElementById('hFiltColab').value.toLowerCase();
  const ft=document.getElementById('hFiltTurno').value;
  const fdIni=document.getElementById('hFiltDtIni')?.value; // yyyy-mm-dd
  const fdFim=document.getElementById('hFiltDtFim')?.value;
  let data=DB.lancamentos.filter(l=>!l.filaAuto).slice().reverse();
  if(fo) data=data.filter(l=>l.nr.toLowerCase().includes(fo)||l.ref.toLowerCase().includes(fo));
  if(fp) data=data.filter(l=>l.proc===fp);
  if(fc) data=data.filter(l=>l.colab.toLowerCase().includes(fc));
  if(ft) data=data.filter(l=>(l.turno||getTurno(l.hini||null))===ft);
  // Filtro de data ‚Äî usa o campo dt que √© "dd/mm/yyyy hh:mm:ss"
  if(fdIni||fdFim){
    data=data.filter(l=>{
      // parseia "23/02/2026, 14:30:00" ‚Üí Date
      const partes=l.dt?l.dt.split(/[/,\s:]+/):null;
      if(!partes||partes.length<3) return true;
      const d=new Date(+partes[2],+partes[1]-1,+partes[0]);
      const iso=d.toISOString().slice(0,10);
      if(fdIni&&iso<fdIni) return false;
      if(fdFim&&iso>fdFim) return false;
      return true;
    });
  }
  // Resumo do per√≠odo filtrado
  const resumoEl=document.getElementById('histResumo');
  if(resumoEl){
    if(data.length>0){
      const totalEnt=data.reduce((s,l)=>s+(l.ent||0),0);
      const totalSai=data.reduce((s,l)=>s+(l.sai||0),0);
      const totalQbr=data.reduce((s,l)=>s+(l.qbr||0),0);
      resumoEl.style.display='block';
      resumoEl.innerHTML=`üìä <strong>${data.length}</strong> lan√ßamentos &nbsp;|&nbsp; Entrada: <strong>${totalEnt}</strong> p√ß &nbsp;|&nbsp; Sa√≠da: <strong style="color:var(--green)">${totalSai}</strong> p√ß &nbsp;|&nbsp; Quebra: <strong style="color:${totalQbr>0?'var(--red)':'var(--muted)'}">${totalQbr}</strong> p√ß`;
    } else { resumoEl.style.display='none'; }
  }
  const tb=document.getElementById('histTbl');
  if(!data.length){ tb.innerHTML='<tr><td colspan="15" style="text-align:center;color:var(--muted);padding:20px">Nenhum lan√ßamento</td></tr>'; }
  else tb.innerHTML=data.map(l=>{ const t=l.turno||getTurno(l.hini||null); const pc=l.pcHora||calcPcHora(l)||'‚Äî'; const isSubPass=l.ehSubPassagem?'background:rgba(245,158,11,.04)':''; return `<tr style="${isSubPass}">
    <td style="font-size:10px;white-space:nowrap">${l.dt}</td>
    <td style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent)">#${l.nr}</td>
    <td>${l.ref}</td><td style="font-size:10px;font-weight:700">${l.proc}${l.ehSubPassagem?'<span style="font-size:8px;color:var(--accent);margin-left:3px;">sub</span>':''}</td>
    <td style="font-size:10px;color:var(--muted)">${l.sub||'‚Äî'}</td>
    <td style="font-size:10px">${l.colab}</td>
    <td><span class="badge ${turnoBadgeClass(t)}" style="font-size:9px;">${t}</span></td>
    <td style="font-weight:700">${l.ent}</td><td style="font-weight:700;color:var(--green)">${l.sai||'‚Äî'}</td>
    <td style="font-weight:800;color:${l.qbr>0?'var(--red)':'var(--muted)'}">${l.qbr||0}</td>
    <td style="font-size:10px;color:var(--accent);font-weight:700">${pc}</td>
    <td style="font-size:10px;color:var(--muted)">${l.motivo||'‚Äî'}</td>
    <td style="font-size:10px">${l.hini||'‚Äî'}</td><td style="font-size:10px">${l.hfim||'‚Äî'}</td>
    <td style="font-size:10px;color:var(--muted)">${l.obs||'‚Äî'}</td></tr>`; }).join('');
  // Auditoria
  const auditEl=document.getElementById('auditLog');
  if(auditEl){
    if(!DB.auditoria.length) auditEl.innerHTML='<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px;">Nenhum evento registrado ainda.</div>';
    else auditEl.innerHTML=DB.auditoria.slice(0,100).map(a=>`<div class="audit-row"><div style="color:var(--muted);white-space:nowrap;flex-shrink:0;">${a.ts}</div><div><span class="badge b-bl" style="font-size:9px;margin-right:6px;">${a.tipo}</span>${a.descricao}</div></div>`).join('');
  }
}
function filtrarHistoricoHoje(){
  const hoje=new Date().toISOString().slice(0,10);
  document.getElementById('hFiltDtIni').value=hoje;
  document.getElementById('hFiltDtFim').value=hoje;
  renderHistorico();
}
function filtrarHistoricoSemana(){
  const fim=new Date(); const ini=new Date(); ini.setDate(ini.getDate()-6);
  document.getElementById('hFiltDtIni').value=ini.toISOString().slice(0,10);
  document.getElementById('hFiltDtFim').value=fim.toISOString().slice(0,10);
  renderHistorico();
}

function exportarCSV(){
  const h=['Data/Hora','N¬∫ Ordem','Refer√™ncia','Processo','Sub Processo','Colaborador','Turno','Entrada','Sa√≠da','Quebra','P√ß/h','Motivo','H.In√≠cio','H.Fim','Observa√ß√£o'];
  const rows=DB.lancamentos.map(l=>{ const t=l.turno||getTurno(l.hini||null); const pc=l.pcHora||calcPcHora(l)||''; return [l.dt,l.nr,l.ref,l.proc,l.sub||'',l.colab,t,l.ent,l.sai,l.qbr||0,pc,l.motivo||'',l.hini||'',l.hfim||'',l.obs||'']; });
  const csv=[h,...rows].map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'})); a.download='historico_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
}

// ‚ïê‚ïê METAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEDIDOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function gerarNrPedido(){
  const d=new Date();
  const pre='P'+String(d.getFullYear()).slice(2)+String(d.getMonth()+1).padStart(2,'0');
  const nums=DB.pedidos.filter(p=>p.nr&&p.nr.startsWith(pre)).map(p=>parseInt(p.nr.slice(5))||0);
  return pre+String(nums.length?Math.max(...nums)+1:1).padStart(4,'0');
}

function autoFillPedido(){
  const ref=(document.getElementById('pRef')||{value:''}).value.trim().toUpperCase();
  const cat=CATALOGO.find(x=>x.ref===ref)||{};
  const cad=DB.refs.find(x=>x.ref===ref)||{};
  const v=f=>cad[f]||cat[f]||'';
  const ra=document.getElementById('pRefAcab'); if(ra) ra.value=v('refAcabada');
  const de=document.getElementById('pDesc');    if(de) de.value=v('desc');
}

function salvarPedido(){
  const nr   =document.getElementById('pNr')?.value?.trim()||gerarNrPedido();
  const ref  =document.getElementById('pRef')?.value?.trim().toUpperCase()||'';
  const qtd  =parseInt(document.getElementById('pQtdTotal')?.value)||0;
  if(!ref||qtd<1){ toast('Preencha refer√™ncia e quantidade total','err'); return; }
  const p={
    nr, ref,
    refAcabada: document.getElementById('pRefAcab')?.value||'',
    desc:       document.getElementById('pDesc')?.value||'',
    qtdTotal:   qtd,
    tam:        document.getElementById('pTam')?.value||'',
    prazo:      document.getElementById('pPrazo')?.value||'',
    prio:       document.getElementById('pPrio')?.value||'NORMAL',
    obs:        document.getElementById('pObs')?.value||'',
    criado:     new Date().toLocaleString('pt-BR'),
  };
  DB.pedidos.push(p);
  audit('PEDIDO','Pedido #'+nr+' criado ‚Äî '+ref+' √ó '+qtd+'p√ß',p);
  save(); atualizarBadgePedidos(); renderPedidos(); fecharModal();
  toast('üõí Pedido #'+nr+' criado!','ok');
}

function calcSaldoPedido(nrPed){
  const p=DB.pedidos.find(x=>x.nr===nrPed);
  if(!p) return 0;
  const emitido=DB.ordens.filter(o=>o.pedidoNr===nrPed).reduce((s,o)=>s+o.qtd,0);
  return Math.max(0, p.qtdTotal-emitido);
}

function emitirOrdemDoPedido(pNr){
  const p=DB.pedidos.find(x=>x.nr===pNr);
  if(!p){ toast('Pedido n√£o encontrado','err'); return; }
  const saldo=calcSaldoPedido(pNr);
  const qtd=parseInt(document.getElementById('eoQtd')?.value)||0;
  if(qtd<1){ toast('Informe a quantidade','err'); return; }
  if(qtd>saldo){ toast('Excede o saldo dispon√≠vel ('+saldo+'p√ß)','err'); return; }
  const nr=document.getElementById('eoNr')?.value||gerarNrOrdem();
  const novaOrdem={
    nr, ref:p.ref, qtd,
    tipoLote:'PADR√ÉO', isRetrabalho:false, isRecuperavel:false,
    refAcabada:p.refAcabada||'',
    desc:p.desc||'', produto:'',
    tam:document.getElementById('eoTam')?.value||p.tam||'',
    prazo:p.prazo||'',
    prio:document.getElementById('eoPrio')?.value||p.prio||'NORMAL',
    obs:document.getElementById('eoObs')?.value||('Ordem do pedido #'+pNr),
    pedidoNr:pNr,
    acessoriosInternos:[], acessoriosExternos:[],
    criado:new Date().toLocaleString('pt-BR'),
  };
  DB.ordens.push(novaOrdem);
  DB.lancamentos.push({
    id:Date.now(), dt:new Date().toLocaleString('pt-BR'),
    nr, ref:p.ref, desc:p.desc||'',
    proc:'FILA IMPRESS√ÉO', sub:'', colab:'SISTEMA',
    ent:0, sai:0, qbr:0, motivo:'', hini:'', hfim:'',
    obs:'Emitida do pedido #'+pNr, turno:'', pcHora:null, filaAuto:true,
  });
  // Atualiza status pedido
  const novoSaldo=calcSaldoPedido(pNr);
  p.status = novoSaldo<=0 ? 'concluido' : 'parcial';
  audit('EMITIR-ORDEM','Ordem #'+nr+' ('+qtd+'p√ß) do pedido #'+pNr,{nr,pNr,qtd});
  save(); atualizarBadgePedidos(); fecharModal();
  toast('‚úÖ Ordem #'+nr+' emitida! Imprimindo...','ok');
  setTimeout(()=>_executarImpressaoOP([novaOrdem]), 400);
}

function atualizarBadgePedidos(){
  const el=document.getElementById('badgePedidos');
  if(!el) return;
  const n=DB.pedidos.filter(p=>calcSaldoPedido(p.nr)>0).length;
  el.textContent=n||''; el.style.display=n?'':'none';
}

function renderPedidos(){
  atualizarBadgePedidos();
  const filt=(document.getElementById('filtPedido')||{value:''}).value.toLowerCase();
  const fSt =(document.getElementById('filtStatusPedido')||{value:''}).value;
  // KPIs
  const kEl=document.getElementById('pedidosKpis');
  if(kEl){
    const total=DB.pedidos.length;
    const abertos=DB.pedidos.filter(p=>calcSaldoPedido(p.nr)>0&&DB.ordens.filter(o=>o.pedidoNr===p.nr).length===0).length;
    const parciais=DB.pedidos.filter(p=>calcSaldoPedido(p.nr)>0&&DB.ordens.filter(o=>o.pedidoNr===p.nr).length>0).length;
    const concluidos=DB.pedidos.filter(p=>calcSaldoPedido(p.nr)<=0).length;
    const totalPcs=DB.pedidos.reduce((s,p)=>s+p.qtdTotal,0);
    const emitPcs=DB.pedidos.reduce((s,p)=>s+DB.ordens.filter(o=>o.pedidoNr===p.nr).reduce((t,o)=>t+o.qtd,0),0);
    kEl.innerHTML=`
      <div class="kpi ac"><div class="kpi-v">${total}</div><div class="kpi-l">Total Pedidos</div></div>
      <div class="kpi yw"><div class="kpi-v">${abertos+parciais}</div><div class="kpi-l">Com Saldo Pendente</div></div>
      <div class="kpi gn"><div class="kpi-v">${concluidos}</div><div class="kpi-l">Completamente Emitidos</div></div>
      <div class="kpi bl"><div class="kpi-v">${emitPcs}/${totalPcs}</div><div class="kpi-l">P√ß Emitidas / Total</div></div>`;
  }
  let peds=DB.pedidos.slice().reverse();
  if(filt) peds=peds.filter(p=>p.nr.toLowerCase().includes(filt)||p.ref.toLowerCase().includes(filt)||(p.desc||'').toLowerCase().includes(filt));
  if(fSt==='aberto')    peds=peds.filter(p=>calcSaldoPedido(p.nr)>0&&DB.ordens.filter(o=>o.pedidoNr===p.nr).length===0);
  if(fSt==='parcial')   peds=peds.filter(p=>calcSaldoPedido(p.nr)>0&&DB.ordens.filter(o=>o.pedidoNr===p.nr).length>0);
  if(fSt==='concluido') peds=peds.filter(p=>calcSaldoPedido(p.nr)<=0);
  const el=document.getElementById('pedidosLista');
  if(!el) return;
  if(!peds.length){
    el.innerHTML='<div class="empty"><div class="empty-ico">üõí</div><p>Nenhum pedido encontrado.<br><small style="color:var(--muted)">Crie um pedido e emita ordens fracionadas a partir dele.</small></p></div>';
    return;
  }
  el.innerHTML=peds.map(p=>{
    const ords=DB.ordens.filter(o=>o.pedidoNr===p.nr);
    const emitido=ords.reduce((s,o)=>s+o.qtd,0);
    const saldo=Math.max(0,p.qtdTotal-emitido);
    const pct=p.qtdTotal>0?Math.round(emitido/p.qtdTotal*100):0;
    const conc=saldo<=0;
    const diasR=p.prazo?Math.ceil((new Date(p.prazo)-new Date())/(1000*60*60*24)):null;
    const prazoCor=diasR===null?'var(--muted)':diasR<0?'var(--red)':diasR<=3?'var(--accent)':'var(--green)';
    return `<div style="background:var(--card);border:1.5px solid ${conc?'rgba(16,185,129,.35)':'var(--border)'};border-radius:12px;padding:16px;margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
        <div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--accent)">#${p.nr}</span>
            ${prioBadge(p.prio)}
            <span class="badge ${conc?'b-gn':saldo<p.qtdTotal?'b-yw':'b-ac'}">${conc?'‚úÖ EMITIDO':saldo<p.qtdTotal?'‚è≥ PARCIAL':'üìã ABERTO'}</span>
          </div>
          <div style="font-size:13px;font-weight:700;margin-top:3px;">${p.ref}${p.refAcabada?' ¬∑ '+p.refAcabada:''}</div>
          <div style="font-size:11px;color:var(--muted);">${p.desc||''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:24px;font-weight:900;">${emitido}<span style="font-size:13px;color:var(--muted);font-weight:400;"> / ${p.qtdTotal} p√ß</span></div>
          ${diasR!==null?`<div style="font-size:11px;font-weight:700;color:${prazoCor};">${diasR<0?'‚ö†Ô∏è ATRASADO '+Math.abs(diasR)+'d':diasR+'d para o prazo'}</div>`:''}
        </div>
      </div>
      <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:10px;">
        <div style="height:100%;border-radius:4px;background:${conc?'var(--green)':'var(--accent)'};width:${pct}%;transition:width .4s;"></div>
      </div>
      ${ords.length?`<div style="margin-bottom:10px;">
        <div style="font-size:9px;font-weight:900;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px;">ORDENS EMITIDAS (${ords.length})</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;">
          ${ords.map(o=>{
            const ol=DB.lancamentos.filter(l=>l.nr===o.nr);
            const prog=Math.round(calcProgresso(ol)/N_PROC*100);
            const oc=isOrdemConcluida(ol);
            return `<div onclick="irOrdem('${o.nr}')" style="cursor:pointer;background:var(--bg3);border:1px solid ${oc?'rgba(16,185,129,.4)':'var(--border)'};border-radius:6px;padding:4px 9px;font-size:11px;font-weight:700;color:${oc?'var(--green)':'var(--text)'};">#${o.nr} ¬∑ ${o.qtd}p√ß ¬∑ ${oc?'‚úÖ':'‚è≥ '+prog+'%'}</div>`;
          }).join('')}
        </div>
      </div>`:''}
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
        ${!conc?`<button class="btn btn-gn" style="font-size:12px;padding:7px 14px;" onclick="window._emitirPedidoNr='${p.nr}';abrirModal('emitir-ordem-pedido')">üñ®Ô∏è Emitir Ordem (saldo: ${saldo} p√ß)</button>`:'<div></div>'}
        <div style="font-size:10px;color:var(--muted);">${p.criado||''}${p.obs?' ¬∑ '+p.obs:''}</div>
      </div>
    </div>`;
  }).join('');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUCATA E RETORNO RECUPERADORA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function salvarSucata(){
  const dt  =document.getElementById('sSucDt')?.value||'';
  const tipo=document.getElementById('sSucTipo')?.value||'';
  const peso=parseFloat(document.getElementById('sSucPeso')?.value)||0;
  if(!dt||!tipo||peso<=0){ toast('Preencha data, tipo e peso','err'); return; }
  const s={ id:Date.now(), dt, tipo, peso,
    ordem: document.getElementById('sSucOrdem')?.value||'',
    obs:   document.getElementById('sSucObs')?.value||'',
    criado:new Date().toLocaleString('pt-BR') };
  DB.sucatas.push(s);
  audit('SUCATA','Sucata: '+tipo+' '+peso+'g'+(s.ordem?' Ord#'+s.ordem:''),s);
  save(); renderMetal(); fecharModal();
  toast('üóë Sucata registrada: '+peso+'g de '+tipo,'ok');
}

function salvarRetornoMetal(){
  const dt  =document.getElementById('sRetDt')?.value||'';
  const tipo=document.getElementById('sRetTipo')?.value||'';
  const peso=parseFloat(document.getElementById('sRetPeso')?.value)||0;
  if(!dt||!tipo||peso<=0){ toast('Preencha data, tipo e peso','err'); return; }
  const r={ id:Date.now(), dt, tipo, peso,
    sucataId:parseInt(document.getElementById('sRetSucRef')?.value)||null,
    nf:  document.getElementById('sRetNF')?.value||'',
    obs: document.getElementById('sRetObs')?.value||'',
    criado:new Date().toLocaleString('pt-BR') };
  DB.retornosMetal.push(r);
  audit('RETORNO METAL','Retorno: '+tipo+' '+peso+'g'+(r.nf?' NF:'+r.nf:''),r);
  save(); renderMetal(); fecharModal();
  toast('‚ôªÔ∏è Retorno registrado: '+peso+'g de '+tipo,'ok');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FECHAMENTO DE METAL ‚Äî C√ÅLCULO
// Quebra Real = Entrada ‚àí Sa√≠da em Produ√ß√£o ‚àí Retorno Recuperadora
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcMetalFechamento(filtroTipo){
  const lans=DB.lancamentos.filter(l=>(l.metalEnt||l.metalSai)&&(!filtroTipo||l.metalTipo===filtroTipo));
  const totalEnt     = lans.reduce((s,l)=>s+(l.metalEnt||0),0);
  const totalSaiProd = lans.reduce((s,l)=>s+(l.metalSai||0),0);
  const suc =(DB.sucatas||[]).filter(s=>!filtroTipo||s.tipo===filtroTipo);
  const ret =(DB.retornosMetal||[]).filter(r=>!filtroTipo||r.tipo===filtroTipo);
  const totalSucata  = suc.reduce((s,x)=>s+x.peso,0);
  const totalRetorno = ret.reduce((s,r)=>s+r.peso,0);
  const quebraReal   = Math.max(0, totalEnt - totalSaiProd - totalRetorno);
  const pctReal      = totalEnt>0?(quebraReal/totalEnt*100).toFixed(1):'0';
  const saldoSucata  = Math.max(0, totalSucata - totalRetorno);
  // Pe√ßas finalizadas = ordens conclu√≠das
  const pecasOK = DB.ordens.filter(o=>isOrdemConcluida(DB.lancamentos.filter(l=>l.nr===o.nr))).reduce((s,o)=>s+o.qtd,0);
  const consumoPorPeca = (pecasOK>0&&totalSaiProd>0)?(totalSaiProd/pecasOK).toFixed(3):null;
  return {totalEnt,totalSaiProd,totalSucata,totalRetorno,quebraReal,pctReal,saldoSucata,pecasOK,consumoPorPeca};
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üå≥ √ÅRVORES DE FUNDI√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ARVORE_FAIXAS = { prata:{min:1,max:100}, latao:{min:101,max:200} };
const ARVORE_FATORES = { prata:10.0, latao:9.0 };
let _arvOrdens = [];   // ordens bipadas na √°rvore atual (modal)

// ‚îÄ‚îÄ N√∫mero autom√°tico por metal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function proximoNrArvore(metal){
  const faixa = ARVORE_FAIXAS[metal];
  const atual = DB.cicloFund[metal] || faixa.min;
  return atual;
}

function avancarNrArvore(metal){
  const faixa = ARVORE_FAIXAS[metal];
  const proximo = (DB.cicloFund[metal]||faixa.min) + 1;
  DB.cicloFund[metal] = proximo > faixa.max ? faixa.min : proximo;
}

// ‚îÄ‚îÄ Reiniciar ciclo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function novoCicloFund(){
  if(!confirm('Reiniciar numera√ß√£o das √°rvores?\nPrata voltar√° a 001, Lat√£o a 101.\nAs √°rvores j√° salvas n√£o s√£o apagadas.')) return;
  DB.cicloFund = {prata:1, latao:101};
  save();
  toast('üîÑ Numera√ß√£o reiniciada ‚Äî Prata: 001 | Lat√£o: 101','ok');
  renderArvores();
}

// ‚îÄ‚îÄ Quando muda o metal no modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onArvMetalChange(){
  const metal = document.getElementById('arvMetal')?.value || 'prata';
  const nr = proximoNrArvore(metal);
  const fator = ARVORE_FATORES[metal];
  const nrEl = document.getElementById('arvNr');
  const fatEl = document.getElementById('arvFator');
  if(nrEl) nrEl.value = String(nr).padStart(metal==='prata'?3:3,'0');
  if(fatEl) fatEl.value = fator;
  // Limpa ordens se mudou metal (podem ser de metais diferentes)
  _arvOrdens = [];
  renderArvOrdensList();
  calcArvore();
}

// ‚îÄ‚îÄ Adicionar ordem por bipe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function adicionarOrdemArvore(){
  const input = document.getElementById('arvBipeInput');
  if(!input) return;
  const nr = input.value.trim().toUpperCase().replace(/^#/,'');
  if(!nr){ toast('Digite ou bipe o n√∫mero da ordem','err'); return; }

  // J√° foi adicionada?
  if(_arvOrdens.find(o=>o.nr===nr)){ toast('Ordem #'+nr+' j√° est√° na √°rvore','err'); input.value=''; return; }

  // Busca no DB
  const ordem = DB.ordens.find(o=>o.nr===nr);
  if(!ordem){ toast('Ordem #'+nr+' n√£o encontrada','err'); input.value=''; input.select(); return; }

  // Busca na refer√™ncia o peso de pedras
  const ref = DB.refs.find(r=>r.ref===ordem.ref) || {};
  const pesoPedrasPorPeca = ref.pesoPedrasFund || 0;
  const pesoPedrasTotal = pesoPedrasPorPeca * (ordem.qtd||1);

  _arvOrdens.push({
    nr: ordem.nr,
    ref: ordem.ref,
    desc: ordem.desc||ref.desc||'',
    qtd: ordem.qtd||1,
    pesoPedrasPorPeca,
    pesoPedrasTotal,
    temPedra: pesoPedrasPorPeca > 0,
  });

  input.value='';
  input.focus();
  renderArvOrdensList();
  calcArvore();
  toast('‚úÖ Ordem #'+nr+' adicionada','ok');
}

// ‚îÄ‚îÄ Render lista de ordens no modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderArvOrdensList(){
  const list = document.getElementById('arvOrdensList');
  const empty = document.getElementById('arvOrdensEmpty');
  if(!list) return;
  if(!_arvOrdens.length){
    list.innerHTML='';
    if(empty) empty.style.display='block';
    document.getElementById('arvTotais')?.style && (document.getElementById('arvTotais').style.display='none');
    return;
  }
  if(empty) empty.style.display='none';
  list.innerHTML = _arvOrdens.map((o,i)=>`
    <div style="display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:7px;padding:8px 10px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent);font-size:14px;min-width:60px;">#${o.nr}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${o.ref} ‚Äî ${o.desc}</div>
        <div style="font-size:10px;color:var(--muted);">${o.qtd} p√ß${o.qtd>1?'s':''} ${o.temPedra?`¬∑ üíé ${o.pesoPedrasTotal.toFixed(3)}g pedras (${o.pesoPedrasPorPeca.toFixed(3)}g/p√ß)`:'¬∑ sem pedra na cera'}</div>
      </div>
      <button onclick="_arvOrdens.splice(${i},1);renderArvOrdensList();calcArvore();" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 4px;">√ó</button>
    </div>`).join('');
  // Totais
  const totEl = document.getElementById('arvTotais');
  if(totEl) totEl.style.display='';
  const totPedras = _arvOrdens.reduce((s,o)=>s+o.pesoPedrasTotal,0);
  const totPecas  = _arvOrdens.reduce((s,o)=>s+o.qtd,0);
  if(document.getElementById('arvTotOrdens'))  document.getElementById('arvTotOrdens').textContent  = _arvOrdens.length;
  if(document.getElementById('arvTotPecas'))   document.getElementById('arvTotPecas').textContent   = totPecas;
  if(document.getElementById('arvTotPedras'))  document.getElementById('arvTotPedras').textContent  = totPedras.toFixed(2)+'g';
}

// ‚îÄ‚îÄ Calcular peso esperado ao vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcArvore(){
  const cera  = parseFloat(document.getElementById('arvPesoCera')?.value)||0;
  const fator = parseFloat(document.getElementById('arvFator')?.value)||0;
  const totPedras = _arvOrdens.reduce((s,o)=>s+o.pesoPedrasTotal,0);
  const disp = document.getElementById('arvPesoEspDisplay');
  if(!disp) return;
  if(!cera||!fator){ disp.textContent=''; return; }
  const ceraLiq   = Math.max(0, cera - totPedras);
  const metalEsp  = ceraLiq * fator;
  const pesoEsp   = metalEsp + totPedras;
  disp.innerHTML = `<span style="color:var(--muted);font-size:10px;">Pedras: ${totPedras.toFixed(2)}g<br>Cera l√≠q: ${ceraLiq.toFixed(2)}g<br></span><span style="color:var(--accent);font-weight:700;">Esp: ${pesoEsp.toFixed(2)}g</span>`;
}

// ‚îÄ‚îÄ Salvar √°rvore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function salvarArvore(){
  const metal  = document.getElementById('arvMetal')?.value||'prata';
  const nrRaw  = parseInt(document.getElementById('arvNr')?.value||'0');
  const fator  = parseFloat(document.getElementById('arvFator')?.value)||ARVORE_FATORES[metal];
  const cera   = parseFloat(document.getElementById('arvPesoCera')?.value)||0;

  if(!_arvOrdens.length){ toast('Adicione pelo menos uma ordem na √°rvore','err'); return; }
  if(!cera){ toast('Informe o peso da √°rvore em cera','err'); return; }

  const totPedras = _arvOrdens.reduce((s,o)=>s+o.pesoPedrasTotal,0);
  const ceraLiq   = Math.max(0, cera - totPedras);
  const metalEsp  = ceraLiq * fator;
  const pesoEsp   = metalEsp + totPedras;

  const arvore = {
    id:       Date.now(),
    nr:       nrRaw,
    nrDisplay:String(nrRaw).padStart(3,'0'),
    metal,
    fator,
    ordens:   [..._arvOrdens],
    totPedras,
    ceraLiq,
    pesoCera: cera,
    metalEsp,
    pesoEsp,
    status:   'aberta',   // aberta ‚Üí fundida ‚Üí cortada
    pesoReal: null,
    quebraPct: null,
    pesoCanal: null,
    pesoSucata: null,
    criado:   new Date().toLocaleString('pt-BR'),
    ciclo:    new Date().toLocaleDateString('pt-BR','month year'),
  };

  DB.arvores.push(arvore);
  avancarNrArvore(metal);
  save();
  fecharModal();
  toast(`‚úÖ √Årvore ${arvore.nrDisplay} (${metal==='prata'?'Prata':'Lat√£o'}) criada!`,'ok');
  renderArvores();
  atualizarBadgeArvores();
  // Imprimir etiqueta automaticamente
  setTimeout(()=>imprimirEtiquetaNr(arvore),300);
}

// ‚îÄ‚îÄ Fechar fundi√ß√£o (√°rvore fundida) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fecharFundicaoArvore(id){
  const arv = DB.arvores.find(a=>a.id===id);
  if(!arv) return;
  const realStr = prompt(`√Årvore ${arv.nrDisplay} ‚Äî ${arv.metal==='prata'?'Prata 925':'Lat√£o'}\n\nInforme o peso real da √°rvore FUNDIDA (gramas):`);
  if(!realStr) return;
  const real = parseFloat(realStr.replace(',','.'));
  if(!real||real<=0){ toast('Peso inv√°lido','err'); return; }

  const canalStr = prompt(`Peso do caule + tronco + jitos (gramas):\n(deixe em branco se n√£o sabe ainda)`);
  const canal    = canalStr ? parseFloat(canalStr.replace(',','.'))||0 : 0;

  const sucataStr = prompt(`Peso das pe√ßas sucatadas desta √°rvore (gramas):\n(deixe em branco se n√£o houver)`);
  const sucata    = sucataStr ? parseFloat(sucataStr.replace(',','.'))||0 : 0;

  const retorno    = canal + sucata;
  const quebraBruta = arv.pesoEsp - real;
  const quebraLiq   = Math.max(0, quebraBruta - retorno);
  const quebraPct   = arv.metalEsp > 0 ? (quebraLiq/arv.metalEsp*100) : 0;

  arv.pesoReal   = real;
  arv.pesoCanal  = canal;
  arv.pesoSucata = sucata;
  arv.quebraLiq  = quebraLiq;
  arv.quebraPct  = quebraPct;
  arv.status     = 'fundida';
  arv.fundidoEm  = new Date().toLocaleString('pt-BR');

  // Registra lan√ßamento de FUNDI√á√ÉO automaticamente para cada ordem da √°rvore
  // Metal total distribu√≠do proporcionalmente por pe√ßa
  const metalPorPeca = arv.ordens.length>0 ? arv.metalEsp/arv.ordens.reduce((s,o)=>s+o.qtd,0) : 0;
  arv.ordens.forEach(o=>{
    const entOrdem = metalPorPeca * o.qtd;
    // Apenas registra se n√£o existe lan√ßamento de FUNDI√á√ÉO para esta ordem j√°
    const jaExiste = DB.lancamentos.find(l=>l.nr===o.nr&&l.proc==='FUNDI√á√ÉO'&&l.arvoreId===arv.id);
    if(!jaExiste){
      DB.lancamentos.push({
        id: Date.now()+Math.random(),
        nr: o.nr,
        ref: o.ref,
        proc: 'FUNDI√á√ÉO',
        metalTipo: arv.metal==='prata'?'PRATA':'LAT√ÉO',
        metalEnt: parseFloat(entOrdem.toFixed(3)),
        metalSai: 0,
        metalPerda: 0,
        naoSeAplica: false,
        arvoreId: arv.id,
        arvoreNr: arv.nrDisplay,
        dt: new Date().toLocaleDateString('pt-BR'),
        criado: new Date().toLocaleString('pt-BR'),
      });
    }
  });

  save();
  toast(`‚úÖ √Årvore ${arv.nrDisplay} fechada ‚Äî quebra ${quebraPct.toFixed(2)}%`,'ok');
  renderArvores();
}

// ‚îÄ‚îÄ Etiqueta para impress√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function imprimirEtiquetaArvore(){
  // Pega dados do modal
  const metal  = document.getElementById('arvMetal')?.value||'prata';
  const nr     = document.getElementById('arvNr')?.value||'---';
  const nrDisp = String(nr).padStart(3,'0');
  _imprimirEtiquetaHtml(nrDisp, metal);
}

function imprimirEtiquetaNr(arv){
  _imprimirEtiquetaHtml(arv.nrDisplay, arv.metal);
}

function _imprimirEtiquetaHtml(nrDisp, metal){
  const metaNome = metal==='prata'?'PRATA 925':'LAT√ÉO';
  const cor      = metal==='prata'?'#c8d8e8':'#d4a853';
  const w = window.open('','_blank','width=320,height=220');
  if(!w) return;
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'DM Mono',monospace;}
    .etiq{width:280px;border:3px solid #111;border-radius:8px;padding:16px 20px;text-align:center;background:#fff;}
    .metal{font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:#555;margin-bottom:4px;}
    .nr{font-family:'Bebas Neue',sans-serif;font-size:120px;line-height:1;color:${cor};text-shadow:2px 2px 0 #111;}
    .data{font-size:10px;color:#999;margin-top:8px;}
    @media print{body{background:#fff;}.etiq{border:3px solid #111;}}
  </style></head><body>
  <div class="etiq">
    <div class="metal">${metaNome}</div>
    <div class="nr">${nrDisp}</div>
    <div class="data">${new Date().toLocaleDateString('pt-BR')}</div>
  </div>
  <scr'+'ipt>window.onload=()=>{window.print();setTimeout(()=>window.close(),800);}</scr'+'ipt>
  </body></html>`);
  w.document.close();
}

// ‚îÄ‚îÄ Render p√°gina √Årvores ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderArvores(){
  // KPIs
  const kpiEl = document.getElementById('arvoreKpis');
  if(kpiEl){
    const abertas  = DB.arvores.filter(a=>a.status==='aberta').length;
    const fundidas = DB.arvores.filter(a=>a.status==='fundida').length;
    const total    = DB.arvores.length;
    const nrPrata  = DB.cicloFund.prata||1;
    const nrLatao  = DB.cicloFund.latao||101;
    kpiEl.innerHTML=`
      <div class="kpi-card"><div class="kpi-val">${String(nrPrata).padStart(3,'0')}</div><div class="kpi-lbl">Pr√≥xima Prata</div></div>
      <div class="kpi-card"><div class="kpi-val">${String(nrLatao).padStart(3,'0')}</div><div class="kpi-lbl">Pr√≥xima Lat√£o</div></div>
      <div class="kpi-card"><div class="kpi-val" style="color:var(--accent);">${abertas}</div><div class="kpi-lbl">Em aberto</div></div>
      <div class="kpi-card"><div class="kpi-val" style="color:var(--green);">${fundidas}</div><div class="kpi-lbl">Fundidas</div></div>`;
  }

  // Lista
  const listaEl = document.getElementById('arvoreLista');
  if(!listaEl) return;
  if(!DB.arvores.length){
    listaEl.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);font-size:14px;">Nenhuma √°rvore criada neste ciclo.</div>';
    return;
  }

  // Ordena: abertas primeiro, depois por n√∫mero
  const sorted = [...DB.arvores].sort((a,b)=>{
    if(a.status==='aberta'&&b.status!=='aberta') return -1;
    if(b.status==='aberta'&&a.status!=='aberta') return 1;
    return b.id-a.id;
  });

  listaEl.innerHTML = sorted.map(arv=>{
    const metaNome = arv.metal==='prata'?'Prata 925':'Lat√£o';
    const metaCor  = arv.metal==='prata'?'var(--silver)':'var(--brass)' ;
    const statusBadge = arv.status==='aberta'
      ? '<span class="badge b-bl">ABERTA</span>'
      : arv.status==='fundida'
        ? `<span class="badge b-gn">FUNDIDA</span>`
        : '<span class="badge b-gy">CORTADA</span>';
    const quebraInfo = arv.quebraPct!=null
      ? `<span class="badge ${arv.quebraPct<=3?'b-gn':arv.quebraPct<=4.5?'b-yw':'b-rd'}">${arv.quebraPct.toFixed(2)}% quebra</span>`
      : '';
    const ordens = arv.ordens||[];
    const totPecas = ordens.reduce((s,o)=>s+o.qtd,0);

    return `<div class="card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <!-- N√∫mero grande -->
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:900;line-height:1;color:${metaCor};min-width:70px;text-align:center;background:var(--bg3);border-radius:8px;padding:6px 10px;">${arv.nrDisplay}</div>
        <!-- Info -->
        <div style="flex:1;min-width:160px;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
            <span style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:${metaCor};">${metaNome}</span>
            ${statusBadge} ${quebraInfo}
          </div>
          <div style="font-size:11px;color:var(--muted);line-height:1.8;">
            ${ordens.length} ordem${ordens.length>1?'s':''} ¬∑ ${totPecas} pe√ßa${totPecas>1?'s':''}<br>
            Cera: <strong>${arv.pesoCera.toFixed(1)}g</strong> ¬∑ 
            Pedras: <strong>${(arv.totPedras||0).toFixed(2)}g</strong> ¬∑ 
            Esp: <strong>${arv.pesoEsp.toFixed(1)}g</strong>
            ${arv.pesoReal?`<br>Real: <strong>${arv.pesoReal.toFixed(1)}g</strong> ¬∑ Canal+sucata: <strong>${((arv.pesoCanal||0)+(arv.pesoSucata||0)).toFixed(1)}g</strong>`:''}
            <br>Criada: ${arv.criado}
          </div>
          <!-- Ordens resumo -->
          <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px;">
            ${ordens.map(o=>`<span class="badge b-ac" style="font-size:9px;">#${o.nr} ${o.ref} √ó${o.qtd}${o.temPedra?'üíé':''}</span>`).join('')}
          </div>
        </div>
        <!-- A√ß√µes -->
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn btn-gy" style="font-size:11px;padding:6px 12px;" onclick="imprimirEtiquetaNr(DB.arvores.find(a=>a.id===${arv.id}))">üñ® Etiqueta</button>
          ${arv.status==='aberta'?`<button class="btn btn-gn" style="font-size:11px;padding:6px 12px;" onclick="fecharFundicaoArvore(${arv.id})">‚öñÔ∏è Fechar</button>`:''}
          <button class="btn btn-rd" style="font-size:11px;padding:6px 12px;" onclick="if(confirm('Remover esta √°rvore?')){DB.arvores=DB.arvores.filter(a=>a.id!==${arv.id});save();renderArvores();}">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function atualizarBadgeArvores(){
  const n = (DB.arvores||[]).filter(a=>a.status==='aberta').length;
  const el = document.getElementById('badgeArvores');
  if(!el) return;
  el.textContent = n||'';
  el.classList.toggle('show', n>0);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOLER√ÇNCIAS DE QUEBRA ‚Äî CONFIG + ALERTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Valores padr√£o de toler√¢ncia por processo (%)
const TOLERANCIA_DEFAULTS = {
  'FUNDI√á√ÉO':               3.0,
  'CORTE DE √ÅRVORE':        1.0,
  'LIXA':                   1.0,
  'ACABAMENTO AUTOM√ÅTICO':  0.5,
  'SOLDA':                  0.5,
  'MONTAGEM':               0.3,
  'CRAVA√á√ÉO METAL':         0.5,
  'ENVIADO PARA REVIS√ÉO':   0.2,
};

function getTolerancia(proc){
  const qt = DB.quebrasTolerancia||{};
  return qt[proc] !== undefined ? qt[proc] : (TOLERANCIA_DEFAULTS[proc] ?? 2.0);
}

function renderConfigTolerancia(){
  const el = document.getElementById('configToleranciaGrid');
  if(!el) return;
  el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;">
    ${PROCESSOS_METAL.map(proc=>{
      const tol = getTolerancia(proc);
      const id  = 'tol_' + proc.replace(/[^a-zA-Z0-9]/g,'_');
      return `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;">
        <div style="font-size:11px;font-weight:700;margin-bottom:6px;color:var(--text);">${proc}</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input class="fi" id="${id}" type="number" min="0" max="100" step="0.1" value="${tol}"
            style="width:80px;text-align:center;font-weight:800;font-size:14px;">
          <span style="font-size:12px;color:var(--muted);">% m√°x</span>
          <span class="badge ${tol<=1?'b-gn':tol<=3?'b-yw':'b-rd'}" style="font-size:9px;">${tol<=1?'BAIXO':tol<=3?'M√âDIO':'ALTO'}</span>
        </div>
      </div>`;
    }).join('')}
  </div>`;
}

function salvarTolerancia(){
  if(!DB.quebrasTolerancia) DB.quebrasTolerancia = {};
  let ok = true;
  PROCESSOS_METAL.forEach(proc => {
    const id  = 'tol_' + proc.replace(/[^a-zA-Z0-9]/g,'_');
    const el  = document.getElementById(id);
    if(!el) return;
    const val = parseFloat(el.value);
    if(isNaN(val)||val<0||val>100){ toast('Valor inv√°lido em: '+proc,'err'); ok=false; return; }
    DB.quebrasTolerancia[proc] = val;
  });
  if(!ok) return;
  audit('CONFIG','Toler√¢ncias de quebra salvas',DB.quebrasTolerancia);
  save();
  toast('‚úÖ Toler√¢ncias salvas ‚Äî alertas ativos na aba Metal','ok');
  renderConfigTolerancia(); // re-render para atualizar as badges de n√≠vel
}

// Calcula alertas de quebra para a aba Metal
function calcAlertasQuebra(filtroTipo){
  const alertas = [];
  const lans = DB.lancamentos.filter(l=>(l.metalEnt>0) && (!filtroTipo||l.metalTipo===filtroTipo));
  lans.forEach(l=>{
    if(!l.proc || !l.metalEnt) return;
    const tol = getTolerancia(l.proc);
    const perda = l.metalPerda || (l.metalEnt - (l.metalSai||0));
    const pct   = l.metalEnt > 0 ? (perda/l.metalEnt*100) : 0;
    if(pct > tol){
      alertas.push({
        nr:     l.nr,
        ref:    l.ref||'',
        proc:   l.proc,
        tipo:   l.metalTipo||'‚Äî',
        ent:    l.metalEnt,
        perda,
        pct:    pct.toFixed(1),
        tol,
        dt:     l.dt,
        excesso:(pct - tol).toFixed(1),
      });
    }
  });
  // Ordenar por excesso desc
  return alertas.sort((a,b)=>parseFloat(b.excesso)-parseFloat(a.excesso));
}

function renderAlertasQuebra(){
  const el = document.getElementById('metalAlertas');
  if(!el) return;
  const alertas = calcAlertasQuebra(null);
  if(!alertas.length){
    el.innerHTML='<div style="background:rgba(16,185,129,.06);border:1.5px solid rgba(16,185,129,.25);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;"><span style="font-size:20px;">‚úÖ</span><div><div style="font-weight:700;color:var(--green);font-size:13px;">Todas as quebras dentro da toler√¢ncia</div><div style="font-size:11px;color:var(--muted);">Nenhum lan√ßamento ultrapassou os limites configurados em ‚öôÔ∏è Configura√ß√µes.</div></div></div>';
    return;
  }
  const criticos = alertas.filter(a=>parseFloat(a.excesso)>=2);
  const avisos   = alertas.filter(a=>parseFloat(a.excesso)<2);
  el.innerHTML = `
    <div style="background:rgba(239,68,68,.07);border:1.5px solid rgba(239,68,68,.35);border-radius:10px;padding:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:20px;">‚ö†Ô∏è</span>
          <div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;color:#fca5a5;">
              ${alertas.length} LAN√áAMENTO${alertas.length>1?'S':''} COM QUEBRA ACIMA DA TOLER√ÇNCIA
            </div>
            <div style="font-size:11px;color:var(--muted);">
              ${criticos.length>0?`<span style="color:var(--red)">${criticos.length} cr√≠tico${criticos.length>1?'s':''}</span> ¬∑ `:''}
              ${avisos.length>0?`<span style="color:var(--accent)">${avisos.length} aviso${avisos.length>1?'s':''}</span> ¬∑ `:''}
              Ajuste as toler√¢ncias em ‚öôÔ∏è Configura√ß√µes
            </div>
          </div>
        </div>
        <button onclick="this.closest('div[style]').querySelector('.alerta-detalhe').classList.toggle('hidden')"
          class="btn btn-gy" style="font-size:11px;padding:5px 12px;">Ver detalhes</button>
      </div>
      <div class="alerta-detalhe hidden">
        <div class="tbl-wrap">
          <table><thead><tr>
            <th>Data</th><th>N¬∫ Ordem</th><th>Refer√™ncia</th><th>Processo</th>
            <th>Tipo</th><th>Entrada</th><th>Perda</th><th>% Real</th><th>Toler√¢ncia</th><th>Excesso</th>
          </tr></thead>
          <tbody>${alertas.map(a=>`<tr>
            <td style="font-size:10px;">${a.dt||''}</td>
            <td style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent);" onclick="irOrdem('${a.nr}')" style="cursor:pointer;">#${a.nr}</td>
            <td style="font-size:11px;">${a.ref}</td>
            <td style="font-size:10px;font-weight:700;">${a.proc}</td>
            <td><span class="badge b-ac" style="background:rgba(245,158,11,.13);color:#fcd34d;border:1px solid rgba(245,158,11,.3);font-size:9px;">${a.tipo}</span></td>
            <td style="font-weight:700;">${a.ent.toFixed(2)}g</td>
            <td style="color:var(--red);font-weight:700;">${a.perda.toFixed(2)}g</td>
            <td><span class="badge ${parseFloat(a.pct)>=5?'b-rd':'b-yw'}" style="font-weight:900;">${a.pct}%</span></td>
            <td style="color:var(--muted);">${a.tol}%</td>
            <td style="color:var(--red);font-weight:900;">+${a.excesso}%</td>
          </tr>`).join('')}</tbody>
          </table>
        </div>
      </div>
    </div>`;
}


function renderMetal(){
  const filtOrdem=(document.getElementById('filtMetalOrdem')||{value:''}).value.toLowerCase();
  const filtTipo =(document.getElementById('filtMetalTipo')||{value:''}).value;
  const lans=DB.lancamentos.filter(l=>l.metalEnt>0||l.metalSai>0||l.metalTipo);

  // ‚îÄ‚îÄ KPIs principais ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const totalEnt  =lans.reduce((s,l)=>s+(l.metalEnt||0),0);
  const totalSai  =lans.reduce((s,l)=>s+(l.metalSai||0),0);
  const totalPerda=lans.reduce((s,l)=>s+(l.metalPerda||0),0);
  const pctPerda  =totalEnt>0?(totalPerda/totalEnt*100).toFixed(1):0;
  renderAlertasQuebra();
  const kpisEl=document.getElementById('metalKpis');
  if(kpisEl) kpisEl.innerHTML=`
    <div class="kpi ac"><div class="kpi-v">${totalEnt.toFixed(1)}g</div><div class="kpi-l">Total Entrada</div></div>
    <div class="kpi gn"><div class="kpi-v">${totalSai.toFixed(1)}g</div><div class="kpi-l">Sa√≠da em Produ√ß√£o</div></div>
    <div class="kpi rd"><div class="kpi-v">${totalPerda.toFixed(1)}g</div><div class="kpi-l">Perda em Processo</div></div>
    <div class="kpi pu"><div class="kpi-v">${pctPerda}%</div><div class="kpi-l">% Perda Processo</div></div>`;

  // ‚îÄ‚îÄ Fechamento Real ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const fch=calcMetalFechamento(null);
  const pctQR=parseFloat(fch.pctReal);
  const pendente=fch.saldoSucata>0;
  const fechEl=document.getElementById('metalFechamento');
  if(fechEl) fechEl.innerHTML=`
    <div style="background:${pctQR>5?'rgba(239,68,68,.07)':'rgba(16,185,129,.06)'};border:1.5px solid ${pctQR>5?'rgba(239,68,68,.3)':'rgba(16,185,129,.25)'};border-radius:12px;padding:16px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:900;letter-spacing:.08em;color:${pctQR>5?'#fca5a5':'var(--green)'};margin-bottom:12px;">
        üìä FECHAMENTO DE QUEBRA REAL DA F√ÅBRICA
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:12px;">
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">Entrada Total</div>
          <div style="font-size:19px;font-weight:900;color:var(--accent);">${fch.totalEnt.toFixed(2)}g</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">Sa√≠da Produ√ß√£o</div>
          <div style="font-size:19px;font-weight:900;color:var(--green);">${fch.totalSaiProd.toFixed(2)}g</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">Sucata Enviada</div>
          <div style="font-size:19px;font-weight:900;color:var(--accent);">${fch.totalSucata.toFixed(2)}g</div>
          ${fch.saldoSucata>0?`<div style="font-size:9px;color:var(--accent);margin-top:2px;">‚è≥ ${fch.saldoSucata.toFixed(2)}g p/ retornar</div>`:''}
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">Retorno Recup.</div>
          <div style="font-size:19px;font-weight:900;color:#93c5fd;">${fch.totalRetorno.toFixed(2)}g</div>
        </div>
        <div style="background:${pctQR>=5?'rgba(239,68,68,.15)':'rgba(16,185,129,.1)'};border:1px solid ${pctQR>=5?'rgba(239,68,68,.4)':'rgba(16,185,129,.3)'};border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">‚ö†Ô∏è Quebra Real</div>
          <div style="font-size:19px;font-weight:900;color:${pctQR>=5?'var(--red)':'var(--green)'};">${fch.quebraReal.toFixed(2)}g</div>
          <div style="font-size:11px;font-weight:800;color:${pctQR>=5?'var(--red)':'var(--green)'};">${fch.pctReal}%</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:3px;text-transform:uppercase;">Pe√ßas Finalizadas</div>
          <div style="font-size:19px;font-weight:900;">${fch.pecasOK}</div>
          ${fch.consumoPorPeca?`<div style="font-size:11px;color:var(--green);font-weight:700;margin-top:2px;">${fch.consumoPorPeca} g/p√ß</div>`:''}
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);line-height:1.7;">
        <strong>F√≥rmula:</strong> Quebra Real = Entrada (${fch.totalEnt.toFixed(2)}g) ‚àí Sa√≠da Prod. (${fch.totalSaiProd.toFixed(2)}g) ‚àí Retorno Recup. (${fch.totalRetorno.toFixed(2)}g) = <strong style="color:${pctQR>=5?'var(--red)':'var(--green)'}">${fch.quebraReal.toFixed(2)}g (${fch.pctReal}%)</strong>
        ${pendente?`<br><span style="color:var(--accent);">‚ö†Ô∏è ${fch.saldoSucata.toFixed(2)}g de sucata ainda aguardam retorno ‚Äî fechamento provis√≥rio.</span>`:'<br><span style="color:var(--green);">‚úÖ Nenhuma sucata pendente de retorno ‚Äî fechamento definitivo.</span>'}
      </div>
    </div>`;

  // ‚îÄ‚îÄ Consumo por pe√ßa por tipo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const consumoEl=document.getElementById('metalConsumoPanel');
  if(consumoEl){
    const tipos=[...new Set(lans.map(l=>l.metalTipo).filter(Boolean))];
    consumoEl.innerHTML=tipos.length?`
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:900;margin-bottom:10px;">üî¨ CONSUMO DE METAL POR PE√áA FINALIZADA</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;">
          ${tipos.map(t=>{
            const f=calcMetalFechamento(t);
            return `<div style="background:var(--bg3);border:1px solid rgba(245,158,11,.25);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:14px;font-weight:900;color:var(--accent);margin-bottom:6px;">${t}</div>
              <div style="font-size:24px;font-weight:900;">${f.consumoPorPeca||'‚Äî'}<span style="font-size:12px;font-weight:400;color:var(--muted);"> g/p√ß</span></div>
              <div style="font-size:10px;color:var(--muted);margin-top:4px;">${f.pecasOK} p√ß conclu√≠das</div>
            </div>`;
          }).join('')}
        </div>
      </div>`:'';
  }

  // ‚îÄ‚îÄ Por tipo de metal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tipoMap={};
  lans.forEach(l=>{const t=l.metalTipo||'N√ÉO INFORMADO';if(!tipoMap[t])tipoMap[t]={tipo:t,ent:0,sai:0,perda:0,lans:0};tipoMap[t].ent+=l.metalEnt||0;tipoMap[t].sai+=l.metalSai||0;tipoMap[t].perda+=l.metalPerda||0;tipoMap[t].lans++;});
  const tipoEl=document.getElementById('metalPorTipo');
  if(tipoEl){if(!Object.keys(tipoMap).length){tipoEl.innerHTML='<div class="empty"><div class="empty-ico">‚öóÔ∏è</div><p>Nenhum registro de metal.</p></div>';}
  else tipoEl.innerHTML=Object.values(tipoMap).map(t=>{const pct=t.ent>0?(t.perda/t.ent*100).toFixed(1):0;const barW=Math.min(100,parseFloat(pct)*3);
    return `<div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--accent)">${t.tipo}</div>
        <span class="badge ${parseFloat(pct)>=10?'b-rd':parseFloat(pct)>=5?'b-yw':'b-gn'}">${pct}% perda proc.</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px;margin-bottom:8px;">
        <div><div style="color:var(--muted);font-size:10px;">Entrada</div><div style="font-weight:800;color:var(--accent)">${t.ent.toFixed(1)}g</div></div>
        <div><div style="color:var(--muted);font-size:10px;">Sa√≠da</div><div style="font-weight:800;color:var(--green)">${t.sai.toFixed(1)}g</div></div>
        <div><div style="color:var(--muted);font-size:10px;">Perda</div><div style="font-weight:800;color:var(--red)">${t.perda.toFixed(1)}g</div></div>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div style="height:100%;border-radius:3px;background:${parseFloat(pct)>=10?'var(--red)':parseFloat(pct)>=5?'var(--accent)':'var(--green)'};width:${barW}%"></div></div>
    </div>`;}).join('');}

  // ‚îÄ‚îÄ Por processo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const procMap={};
  lans.forEach(l=>{const k=l.proc;if(!procMap[k])procMap[k]={proc:k,ent:0,sai:0,perda:0};procMap[k].ent+=l.metalEnt||0;procMap[k].sai+=l.metalSai||0;procMap[k].perda+=l.metalPerda||0;});
  const procEl=document.getElementById('metalPorProcesso');
  if(procEl){if(!Object.keys(procMap).length){procEl.innerHTML='<div class="empty"><div class="empty-ico">üè≠</div><p>Nenhum dado por processo.</p></div>';}
  else procEl.innerHTML=PROCESSOS_METAL.filter(p=>procMap[p]).map(p=>{const d=procMap[p];const pct=d.ent>0?(d.perda/d.ent*100).toFixed(1):0;const barW=Math.min(100,parseFloat(pct)*5);
    return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:9px;font-size:11px;">
      <div style="width:165px;font-weight:700;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;">${p}</div>
      <div style="flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;"><div style="height:100%;border-radius:4px;background:${parseFloat(pct)>=10?'var(--red)':parseFloat(pct)>=5?'var(--accent)':'var(--green)'};width:${barW}%"></div></div>
      <div style="width:42px;text-align:right;font-weight:800;color:${parseFloat(pct)>=10?'var(--red)':parseFloat(pct)>=5?'var(--accent)':'var(--green)'}">${pct}%</div>
      <div style="width:55px;text-align:right;color:var(--red);font-weight:700;">${d.perda.toFixed(1)}g</div>
    </div>`;}).join('');}

  // ‚îÄ‚îÄ Sucatas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sucEl=document.getElementById('metalSucatasList');
  if(sucEl){
    if(!(DB.sucatas||[]).length){sucEl.innerHTML='<div style="text-align:center;padding:14px;color:var(--muted);font-size:12px;">Nenhuma sucata registrada ‚Äî use o bot√£o üóë Lan√ßar Sucata</div>';}
    else sucEl.innerHTML=`<div class="tbl-wrap"><table><thead><tr>
        <th>Data</th><th>Tipo</th><th>Enviado (g)</th><th>Retornado (g)</th><th>Saldo Pendente</th><th>Ordem</th><th>Obs</th>
      </tr></thead><tbody>${DB.sucatas.slice().reverse().map(s=>{
        const ret=(DB.retornosMetal||[]).filter(r=>r.sucataId===s.id).reduce((t,r)=>t+r.peso,0);
        const saldo=Math.max(0,s.peso-ret);
        return `<tr>
          <td style="font-size:11px;">${s.dt||s.data||''}</td>
          <td><span class="badge b-ac" style="background:rgba(245,158,11,.13);color:#fcd34d;border:1px solid rgba(245,158,11,.3);">${s.tipo}</span></td>
          <td style="font-weight:800;color:var(--accent);">${s.peso.toFixed(2)}g</td>
          <td style="font-weight:800;color:var(--green);">${ret.toFixed(2)}g</td>
          <td><span class="badge ${saldo>0?'b-yw':'b-gn'}">${saldo>0?saldo.toFixed(2)+'g ‚è≥':'‚úÖ Fechado'}</span></td>
          <td style="font-size:11px;">${s.ordem||'‚Äî'}</td>
          <td style="font-size:10px;color:var(--muted);">${s.obs||''}</td>
        </tr>`; }).join('')}</tbody></table></div>`;
  }

  // ‚îÄ‚îÄ Retornos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const retEl=document.getElementById('metalRetornosList');
  if(retEl){
    if(!(DB.retornosMetal||[]).length){retEl.innerHTML='<div style="text-align:center;padding:14px;color:var(--muted);font-size:12px;">Nenhum retorno registrado ‚Äî use o bot√£o ‚ôªÔ∏è Retorno Recuperadora</div>';}
    else retEl.innerHTML=`<div class="tbl-wrap"><table><thead><tr>
        <th>Data</th><th>Tipo</th><th>Retornado (g)</th><th>NF</th><th>Sucata Ref.</th><th>Obs</th>
      </tr></thead><tbody>${DB.retornosMetal.slice().reverse().map(r=>{
        const suc=(DB.sucatas||[]).find(s=>s.id===r.sucataId);
        return `<tr>
          <td style="font-size:11px;">${r.dt||r.data||''}</td>
          <td><span class="badge b-bl" style="background:rgba(59,130,246,.13);color:#93c5fd;border:1px solid rgba(59,130,246,.3);">${r.tipo}</span></td>
          <td style="font-weight:800;color:#93c5fd;">${r.peso.toFixed(2)}g</td>
          <td style="font-size:11px;">${r.nf||'‚Äî'}</td>
          <td style="font-size:10px;color:var(--muted);">${suc?(suc.dt||suc.data)+' ¬∑ '+suc.peso.toFixed(2)+'g':'‚Äî'}</td>
          <td style="font-size:10px;color:var(--muted);">${r.obs||''}</td>
        </tr>`; }).join('')}</tbody></table></div>`;
  }

  // ‚îÄ‚îÄ Tabela lan√ßamentos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let rows=lans.filter(l=>l.metalEnt||l.metalSai);
  if(filtOrdem) rows=rows.filter(l=>l.nr.toLowerCase().includes(filtOrdem)||(l.ref||'').toLowerCase().includes(filtOrdem));
  if(filtTipo)  rows=rows.filter(l=>l.metalTipo===filtTipo);
  rows=rows.slice().reverse();
  const tb=document.getElementById('metalTbl');
  if(!tb) return;
  if(!rows.length){tb.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">Nenhum registro encontrado</td></tr>';return;}
  tb.innerHTML=rows.map(l=>{const pct=l.metalEnt>0?((l.metalPerda||0)/l.metalEnt*100).toFixed(1):'‚Äî';
    return `<tr>
      <td style="font-size:10px;white-space:nowrap">${l.dt}</td>
      <td style="font-family:'Barlow Condensed',sans-serif;font-weight:900;color:var(--accent)">#${l.nr}</td>
      <td>${l.ref||''}</td>
      <td style="font-size:10px;font-weight:700">${l.proc}</td>
      <td><span class="badge b-ac" style="background:rgba(245,158,11,.13);color:#fcd34d;border:1px solid rgba(245,158,11,.3);">${l.metalTipo||'‚Äî'}</span></td>
      <td style="font-weight:700;color:var(--accent)">${l.metalEnt?l.metalEnt.toFixed(2)+'g':'‚Äî'}</td>
      <td style="font-weight:700;color:var(--green)">${l.metalSai?l.metalSai.toFixed(2)+'g':'‚Äî'}</td>
      <td style="font-weight:800;color:${l.metalPerda>0?'var(--red)':'var(--muted)'};">${l.metalPerda?l.metalPerda.toFixed(2)+'g':'‚Äî'}</td>
      <td><span class="badge ${parseFloat(pct)>=10?'b-rd':parseFloat(pct)>=5?'b-yw':'b-gn'}">${pct}%</span></td>
    </tr>`;}).join('');
}


function exportarMetalCSV(){
  const toRow=r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',');
  const h=['Data','N¬∫ Ordem','Refer√™ncia','Processo','Colaborador','Tipo Metal','Entrada (g)','Sa√≠da (g)','Perda (g)','% Perda'];
  const rows=DB.lancamentos.filter(l=>l.metalEnt||l.metalSai||l.metalTipo).map(l=>{
    const pct=l.metalEnt>0?((l.metalPerda||0)/l.metalEnt*100).toFixed(1):'';
    return [l.dt,l.nr,l.ref,l.proc,l.colab,l.metalTipo||'',l.metalEnt||'',l.metalSai||'',l.metalPerda||'',pct];
  });
  const hSuc=['Data','Tipo','Peso Enviado (g)','Retornado (g)','Saldo (g)','Ordem','Obs'];
  const rowsSuc=(DB.sucatas||[]).map(s=>{
    const ret=(DB.retornosMetal||[]).filter(r=>r.sucataId===s.id).reduce((t,r)=>t+r.peso,0);
    return [s.dt||s.data,s.tipo,s.peso.toFixed(2),ret.toFixed(2),(s.peso-ret).toFixed(2),s.ordem||'',s.obs||''];
  });
  const hRet=['Data','Tipo','Peso Retornado (g)','NF','Obs'];
  const rowsRet=(DB.retornosMetal||[]).map(r=>[r.dt||r.data,r.tipo,r.peso.toFixed(2),r.nf||'',r.obs||'']);
  const fch=calcMetalFechamento(null);
  const rowsFch=[
    ['Entrada Total (g)',fch.totalEnt.toFixed(2)],['Sa√≠da Produ√ß√£o (g)',fch.totalSaiProd.toFixed(2)],
    ['Sucata Enviada (g)',fch.totalSucata.toFixed(2)],['Retorno Recuperadora (g)',fch.totalRetorno.toFixed(2)],
    ['QUEBRA REAL (g)',fch.quebraReal.toFixed(2)],['% QUEBRA REAL',fch.pctReal+'%'],
    ['Pe√ßas Finalizadas',fch.pecasOK],['Consumo / Pe√ßa (g)',fch.consumoPorPeca||'‚Äî'],
  ];
  const csv=[
    '--- LANCAMENTOS DE METAL ---',toRow(h),...rows.map(toRow),
    '','--- SUCATAS ---',toRow(hSuc),...rowsSuc.map(toRow),
    '','--- RETORNOS ---',toRow(hRet),...rowsRet.map(toRow),
    '','--- FECHAMENTO REAL ---',...rowsFch.map(toRow),
  ].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}));
  a.download='metal_fechamento_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
}

// ‚ïê‚ïê COLABORADORES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderColaboradores(){
  // Separa ativos e inativos para o KPI correto
  const ativos=DB.colaboradores.filter(c=>c.ativo!==false&&c.cadastrado);
  const inativos=DB.colaboradores.filter(c=>c.ativo===false);
  const comLan=new Set(DB.lancamentos.map(l=>l.colab));
  document.getElementById('colabKpis').innerHTML=`
    <div class="kpi ac"><div class="kpi-v">${getColabs().length}</div><div class="kpi-l">Colaboradores Ativos</div></div>
    <div class="kpi gn"><div class="kpi-v">${comLan.size}</div><div class="kpi-l">Com Lan√ßamentos</div></div>
    <div class="kpi bl"><div class="kpi-v">${ativos.length}</div><div class="kpi-l">Cadastrados</div></div>
    ${inativos.length?`<div class="kpi rd" style="cursor:pointer;" onclick="toggleColabInativos()" title="Clique para ver inativos"><div class="kpi-v">${inativos.length}</div><div class="kpi-l">Inativos</div></div>`:''}`;

  // Ranking ‚Äî inclui todos para hist√≥rico, mas marca inativos
  const rankMap={};
  DB.lancamentos.forEach(l=>{
    if(!rankMap[l.colab]) rankMap[l.colab]={nome:l.colab,sai:0,lans:0,qbr:0,pcs:[]};
    rankMap[l.colab].sai+=l.sai||0; rankMap[l.colab].lans++; rankMap[l.colab].qbr+=l.qbr||0;
    const pc=l.pcHora||calcPcHora(l); if(pc) rankMap[l.colab].pcs.push(parseFloat(pc));
  });
  const rank=Object.values(rankMap).sort((a,b)=>b.sai-a.sai);
  const el=document.getElementById('colabRanking');
  if(!rank.length){ el.innerHTML='<div class="empty"><div class="empty-ico">üë•</div><p>Nenhum lan√ßamento registrado ainda.</p></div>'; return; }

  // Bot√£o para exibir/ocultar inativos
  const mostrarInativos=window._mostrarColabInativos||false;

  el.innerHTML=rank.map((c,i)=>{
    const avgPc=c.pcs.length?(c.pcs.reduce((s,v)=>s+v,0)/c.pcs.length).toFixed(1):'‚Äî';
    const pctQbr=c.sai+c.qbr>0?(c.qbr/(c.sai+c.qbr)*100).toFixed(1):0;
    const info=DB.colaboradores.find(x=>x.nome===c.nome)||{};
    const inativo=info.ativo===false;
    if(inativo&&!mostrarInativos) return '';
    const editBtn=info.cadastrado?`<button class="btn btn-gy" style="padding:4px 10px;font-size:10px;margin-left:10px;" onclick="abrirEdicaoColab('${c.nome}')">‚úèÔ∏è Editar</button>`:'';
    return `<div class="colab-card${inativo?' inativo':''}">
      <div style="display:flex;align-items:center;gap:14px;">
        <div class="colab-rank" style="color:${inativo?'var(--red)':'var(--border)'}">${inativo?'‚õî':i+1}</div>
        <div>
          <div style="font-size:14px;font-weight:800;">${c.nome}
            ${info.turno?`<span class="badge ${turnoBadgeClass(info.turno)}" style="font-size:9px;">${info.turno}</span>`:''}
            ${inativo?'<span class="badge b-rd" style="font-size:9px;">INATIVO</span>':''}
            ${info.matricula?`<span style="font-size:10px;color:var(--muted);margin-left:6px;">Mat. ${info.matricula}</span>`:''}
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">${info.setor||'Geral'} ¬∑ ${c.lans} lan√ßamentos ${editBtn}</div>
        </div>
      </div>
      <div style="display:flex;gap:20px;text-align:right;flex-wrap:wrap;">
        <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;color:var(--green)">${c.sai}</div><div style="font-size:10px;color:var(--muted);">p√ß produzidas</div></div>
        <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;color:var(--accent)">${avgPc}</div><div style="font-size:10px;color:var(--muted);">p√ß/hora</div></div>
        <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;color:${parseFloat(pctQbr)>5?'var(--red)':'var(--muted)'}">${pctQbr}%</div><div style="font-size:10px;color:var(--muted);">quebra</div></div>
      </div>
    </div>`;
  }).join('');

  // Adiciona toggle de inativos se houver
  if(inativos.length){
    el.innerHTML+=`<div style="text-align:center;margin-top:10px;">
      <button class="btn btn-gy" style="font-size:11px;" onclick="toggleColabInativos()">${mostrarInativos?'üôà Ocultar inativos':'üëÅÔ∏è Ver '+inativos.length+' inativo(s)'}</button>
    </div>`;
  }
}

function toggleColabInativos(){
  window._mostrarColabInativos=!window._mostrarColabInativos;
  renderColaboradores();
}

// ‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderConfig(){
  const el=document.getElementById('configMetas');
  el.innerHTML=PROCESSOS.map(p=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
    <span style="flex:1;font-size:12px;font-weight:700;">${p.nome}</span>
    <input type="number" min="0" placeholder="0" value="${DB.metas[p.nome]||''}" style="width:90px;" class="fi" onchange="salvarMeta('${p.nome}',this.value)">
    <span style="font-size:10px;color:var(--muted);">p√ß/dia</span>
  </div>`).join('');
  checarBackupAuto();
  const el2=document.getElementById('backupInfo');
  if(el2&&DB.backupTs) el2.innerHTML='<span style="color:var(--green);">‚úÖ √öltimo backup: '+new Date(DB.backupTs).toLocaleDateString('pt-BR')+'</span>';
}
function salvarMeta(proc,val){ DB.metas[proc]=parseInt(val)||0; save(); toast('Meta salva!'); }

// ‚ïê‚ïê ROTEIRO T√âCNICO DE REFER√äNCIA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Retorna o roteiro completo de uma refer√™ncia: lista de {proc, sub} para cada
// processo que tem sub-processo definido (no cadastro ou no cat√°logo legado)
function getRoteiroRef(ref){
  const r   = DB.refs.find(x=>x.ref===ref);
  const cat = CATALOGO.find(x=>x.ref===ref)||{};
  const campoMap={
    'IMPRESS√ÉO 3D':         'impressora',
    'CRAVA√á√ÉO CERA':        'cravacaoCera',
    'LIXA':                 'lixa',
    'ACABAMENTO AUTOM√ÅTICO':'acabamento',
    'SOLDA':                'solda',
    'MONTAGEM':             'montagem',
    'CRAVA√á√ÉO METAL':       'cravacaoMetal',
  };
  const roteiro=[];
  PROCESSOS_REAIS.forEach(p=>{
    const subPadrao = (r&&r.subPadrao&&r.subPadrao[p.nome]) || (campoMap[p.nome]?cat[campoMap[p.nome]]:'') || '';
    roteiro.push({ proc: p, sub: subPadrao, temSub: p.subs&&p.subs.length>0 });
  });
  return roteiro;
}

// Gera HTML do roteiro para exibir no card da refer√™ncia (formato compacto)
function buildRoteiroHTMLCompact(ref){
  const roteiro = getRoteiroRef(ref);
  const linhas = roteiro.filter(r=>r.temSub); // s√≥ mostra processos com sub-op√ß√µes
  if(!linhas.length) return '<span style="font-size:10px;color:var(--muted);">Nenhum sub-processo definido ainda</span>';
  return linhas.map(r=>{
    const definido = r.sub && r.sub.trim();
    return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
      <span style="width:6px;height:6px;border-radius:50%;background:${definido?'var(--green)':'var(--border)'};flex-shrink:0;"></span>
      <span style="font-size:10px;font-weight:700;color:var(--muted);width:155px;flex-shrink:0;">${r.proc.nome}</span>
      <span style="font-size:11px;font-weight:${definido?'800':'400'};color:${definido?'var(--text)':'var(--muted)'};">${definido?r.sub:'‚Äî'}</span>
    </div>`;
  }).join('');
}

// Gera HTML do roteiro para o card da ordem em lan√ßamento (linha + sub)
function buildRoteiroHTMLOrdem(ref, lans){
  const roteiro = getRoteiroRef(ref);
  const doneProcs = new Set(lans.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc));
  return roteiro.map((r,i)=>{
    const done=doneProcs.has(r.proc.nome);
    const definido=r.sub&&r.sub.trim();
    return `<div style="display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);">
      <span style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;color:var(--muted);width:22px;text-align:right;flex-shrink:0;">${r.proc.id}</span>
      <span style="width:6px;height:6px;border-radius:50%;background:${done?'var(--green)':r.proc.skipavel?'var(--border)':'var(--accent)'};flex-shrink:0;"></span>
      <span style="font-size:10px;font-weight:700;color:${done?'var(--green)':'var(--text)'};flex:1;text-decoration:${done?'line-through':''};opacity:${done?.6:1};">${r.proc.nome}</span>
      ${definido?`<span style="font-size:10px;background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.2);border-radius:3px;padding:0 5px;font-weight:700;flex-shrink:0;">${r.sub}</span>`:''}
    </div>`;
  }).join('');
}

// Gera linhas da tabela para OP impressa com coluna de sub-processo do roteiro
function buildRoteiroOPRows(o, lans){
  const roteiro = getRoteiroRef(o.ref);
  const done = new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc));
  return roteiro.map(r=>{
    const pl=lans.filter(l=>l.proc===r.proc.nome);
    const pe=pl.reduce((s,l)=>s+(l.ent||0),0);
    const ps=pl.reduce((s,l)=>s+(l.sai||0),0);
    const pq=pl.reduce((s,l)=>s+(l.qbr||0),0);
    const isDone=done.has(r.proc.nome);
    const isNA=pl.some(l=>l.naoSeAplica);
    const subLabel=r.sub?`<span style="font-size:6.5px;color:#1d4ed8;font-weight:700;">${r.sub}</span>`:'';
    return `<tr class="${isDone?'done-row':''}" ${isNA?'style="opacity:.5"':''}>
      <td>${r.proc.id} ${r.proc.nome}${isNA?' <em style="color:#888;font-size:6px;">N/A</em>':''}<br>${subLabel}</td>
      <td>${pe||''}</td><td>${ps||''}</td>
      <td style="color:${pq>0?'#ef4444':'inherit'};font-weight:${pq>0?'900':'400'}">${pq||''}</td>
      <td>${isNA?'N/A':isDone?'‚úì':''}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê IMPRESS√ÉO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildOrderHTML(o){
  const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
  const done=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
  const prioClass=(o.prio||'').includes('CR√çT')?'critico':(o.prio||'').includes('URG√ä')?'urgente':'normal';
  const prazoFmt=o.prazo?new Date(o.prazo+'T12:00:00').toLocaleDateString('pt-BR'):'‚Äî';
  const diasR=o.prazo?Math.ceil((new Date(o.prazo)-new Date())/(1000*60*60*24)):null;
  const prazoColor=diasR===null?'':diasR<0?'late':diasR<=3?'near':'';
  const prazoStr=diasR===null?'‚Äî':diasR<0?'ATRASADO '+Math.abs(diasR)+'d':diasR+'d';
  const accHtml=((o.acessoriosInternos||[]).length||(o.acessoriosExternos||[]).length)?
    `<div style="margin-top:1mm;font-size:7px;"><strong style="color:#555;">Acess√≥rios:</strong> `+
    [...(o.acessoriosInternos||[]).map(a=>`[INT] ${a.ref} ${a.cor||''} ${a.tam||''} √ó${a.qtd}`),...(o.acessoriosExternos||[]).map(a=>`[EXT] ${a.ref} ${a.cor||''} ${a.tam||''} √ó${a.qtd}`)].join(' | ')+
    `</div>`:'';
  const fracPaiInfo = o.isFracao ? `<div style="font-size:7px;color:#1d4ed8;margin-bottom:1mm;font-weight:700;">Sublote da ordem #${o.ordemPai}</div>` : '';
  const rtBadge=o.isRetrabalho?`<span class="po-rt-flag">üîÅ RETRABALHO</span>`:'';
  const rtInfo=o.isRetrabalho?`<div style="font-size:7px;color:#c00;margin-bottom:1mm;">Origem: #${o.ordemOrigem} ¬∑ Fase: ${o.faseQuebra} ¬∑ Motivo: ${o.motivoRetrabalho}</div>`:'';
  const bcId='bc_'+o.nr.replace(/[^a-zA-Z0-9]/g,'_');
  // Usa roteiro t√©cnico da refer√™ncia (inclui sub-processo padr√£o por linha)
  const procRows = buildRoteiroOPRows(o, lans);
  const fracBadgePrint = o.isFracao ? `<span class="po-rt-flag" style="background:#1d4ed8;">‚úÇÔ∏è F${o.fracaoIdx}/${o.totalFracoes||'?'}</span>` : '';
  const refAcabadaHtml = o.refAcabada?`<div style="font-size:7px;color:#555;margin-bottom:.5mm;">Ref. Acabada: <strong>${o.refAcabada}</strong></div>`:'';
  const cadRefPrint = DB.refs.find(x=>x.ref===o.ref);
  const fotoPrintHtml = cadRefPrint?.foto ? `<img src="${cadRefPrint.foto}" style="width:22mm;height:22mm;object-fit:cover;border-radius:3mm;border:0.5px solid #ccc;flex-shrink:0;">` : '';
  return `<div class="po-card"><div class="po-top"><div><div class="po-logo-txt">FUNDI√á√ÉO <span>ROMMANEL</span></div><div style="font-size:7px;color:#888;margin-top:.5mm;">ORDEM DE PRODU√á√ÉO</div></div><div><div class="po-order-num">#${o.nr}</div><div style="text-align:right;margin-top:1mm;"><span class="po-prio ${prioClass}">${o.prio||'NORMAL'}</span>${rtBadge}${fracBadgePrint}</div></div></div>
  <div class="po-barcode-row">${fotoPrintHtml}<svg id="${bcId}"></svg><div style="flex:1;min-width:0;"><div class="po-ref">${o.ref}</div>${refAcabadaHtml}<div class="po-desc">${o.desc||''}</div><div class="po-produto">${o.produto||''}</div>${rtInfo}${fracPaiInfo}${accHtml}
  <div class="po-meta"><div class="po-meta-cell"><div class="po-meta-lbl">Quantidade</div><div class="po-meta-val" style="color:#b8860b">${o.qtd}</div></div><div class="po-meta-cell"><div class="po-meta-lbl">Tamanho</div><div class="po-meta-val">${o.tam||'‚Äî'}</div></div><div class="po-meta-cell"><div class="po-meta-lbl">Prazo</div><div class="po-meta-val ${prazoColor}">${prazoFmt}</div></div><div class="po-meta-cell"><div class="po-meta-lbl">Restam</div><div class="po-meta-val ${prazoColor}">${prazoStr}</div></div></div></div></div>
  <table class="po-table"><thead><tr><th style="text-align:left;width:42%;">Processo</th><th>Entrada</th><th>Sa√≠da</th><th>Quebra</th><th>OK</th></tr></thead><tbody>${procRows}</tbody></table>
  <div class="po-footer"><span>Criado: ${o.criado||'‚Äî'} ¬∑ Obs: ${o.obs||'‚Äî'}</span><span>Impresso: ${new Date().toLocaleString('pt-BR')}</span></div></div>`;
}
function renderBarcodes(container,ordens){ ordens.forEach(o=>{ const bcId='bc_'+o.nr.replace(/[^a-zA-Z0-9]/g,'_'); const el=container.getElementById?container.getElementById(bcId):container.querySelector('#'+bcId); if(el&&typeof JsBarcode!=='undefined'){ try{ JsBarcode(el,o.nr,{format:'CODE128',width:1.6,height:36,displayValue:true,fontSize:10,margin:2,textMargin:2}); }catch(e){} } }); }
function imprimirSelecionadas(){ const ordens=[...selectedOrdens].map(nr=>DB.ordens.find(o=>o.nr===nr)).filter(Boolean); if(!ordens.length){ toast('Selecione ao menos uma ordem','err'); return; } _executarImpressaoOP(ordens); }

// ‚îÄ‚îÄ Impress√£o via iframe ‚Äî imune a modais e z-index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _getEstilosImpressao(){
  // Coleta todos os estilos da p√°gina para injetar no iframe
  let css='';
  for(const sheet of document.styleSheets){
    try{
      for(const rule of sheet.cssRules){ css+=rule.cssText+'\n'; }
    }catch(e){}
  }
  return css;
}

function _imprimirNoIframe(htmlConteudo){
  // Remove iframe anterior se existir
  const velho=document.getElementById('printFrame');
  if(velho) velho.remove();

  const estilos=`
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#fff;color:#000;font-family:Arial,sans-serif;}
    @page{size:A4 portrait;margin:8mm 8mm;}
    .po-card{border:2px solid #222;padding:5mm 6mm;height:128mm;box-sizing:border-box;overflow:hidden;position:relative;font-family:Arial,sans-serif;color:#000;background:#fff;page-break-inside:avoid;break-inside:avoid;}
    .po-divider{border:none;border-top:2px dashed #bbb;margin:0;}
    .po-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2mm;}
    .po-logo-txt{font-size:17px;font-weight:900;letter-spacing:.04em;}
    .po-logo-txt span{color:#b8860b;}
    .po-order-num{font-size:22px;font-weight:900;line-height:1;text-align:right;}
    .po-prio{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;}
    .po-prio.critico{background:#ef4444;color:#fff;}
    .po-prio.urgente{background:#f59e0b;color:#000;}
    .po-prio.normal{background:#e5e7eb;color:#333;}
    .po-rt-flag{display:inline-block;background:#ef4444;color:#fff;font-size:9px;font-weight:900;padding:1px 6px;border-radius:3px;margin-left:4px;}
    .po-barcode-row{display:flex;gap:4mm;align-items:flex-start;margin-bottom:2mm;}
    .po-barcode-row svg{flex-shrink:0;}
    .po-ref{font-size:13px;font-weight:900;margin-bottom:1mm;}
    .po-desc{font-size:9px;color:#333;font-weight:700;margin-bottom:1mm;}
    .po-produto{font-size:8px;color:#555;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110mm;}
    .po-meta{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5mm;margin-bottom:2mm;}
    .po-meta-cell{border:1px solid #bbb;border-radius:2px;padding:1px 3px;}
    .po-meta-lbl{font-size:7px;font-weight:700;color:#888;text-transform:uppercase;}
    .po-meta-val{font-size:10px;font-weight:800;}
    .po-meta-val.late{color:#ef4444;} .po-meta-val.near{color:#b8860b;}
    .po-table{width:100%;border-collapse:collapse;font-size:8px;}
    .po-table th{background:#1c2537;color:#fff;padding:2px 3px;font-size:7px;text-transform:uppercase;letter-spacing:.04em;}
    .po-table th:first-child{text-align:left;}
    .po-table td{border:1px solid #ccc;padding:2px 3px;text-align:center;line-height:1.3;}
    .po-table td:first-child{text-align:left;font-weight:700;font-size:7px;}
    .po-table tr.done-row td{background:#f0fdf4;}
    .po-footer{position:absolute;bottom:2mm;left:6mm;right:6mm;font-size:7px;color:#aaa;display:flex;justify-content:space-between;}
    .etq-print{border:1.5px solid #222;padding:3mm 4mm;width:72mm;min-height:38mm;box-sizing:border-box;font-family:Arial,sans-serif;color:#000;background:#fff;page-break-inside:avoid;}
    .etq-fracao-flag{background:#1d4ed8;color:#fff;font-size:9px;font-weight:900;padding:1px 5px;border-radius:3px;}
  `;

  // Usa srcdoc para m√°xima compatibilidade (sem doc.write)
  const iframe=document.createElement('iframe');
  iframe.id='printFrame';
  iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:210mm;height:297mm;border:none;';

  // Monta HTML completo do iframe
  const fullHtml=`<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <style>${estilos}</style>
  </head><body>${htmlConteudo}</body></html>`;

  iframe.srcdoc=fullHtml;
  document.body.appendChild(iframe);

  // Aguarda iframe carregar, depois carrega JsBarcode e imprime
  const executar=()=>{
    const iframeWin=iframe.contentWindow;
    const iframeDoc=iframe.contentDocument||iframeWin.document;

    // Injeta JsBarcode dinamicamente no iframe
    const script=iframeDoc.createElement('script');
    script.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
    script.onload=()=>{
      // Gera todos os barcodes pelo data-nr do elemento pai
      iframeDoc.querySelectorAll('svg[id^="bc_"],svg[id^="etq_"],svg[id^="etqf_"]').forEach(svg=>{
        const pai=svg.closest('[data-nr]');
        const nr=pai?pai.dataset.nr:svg.id.replace(/^(bc_|etq_|etqf_)/,'').replace(/_/g,'-');
        if(nr){ try{ iframeWin.JsBarcode(svg,nr,{format:'CODE128',width:1.6,height:36,displayValue:true,fontSize:10,margin:2,textMargin:2}); }catch(e){ console.warn('barcode error',nr,e); } }
      });
      setTimeout(()=>{ iframeWin.focus(); iframeWin.print(); },250);
    };
    script.onerror=()=>{
      // Fallback: imprime sem barcode se CDN falhar
      toast('‚ö†Ô∏è C√≥digo de barras indispon√≠vel ‚Äî imprimindo sem barcode','yw');
      setTimeout(()=>{ iframeWin.focus(); iframeWin.print(); },200);
    };
    iframeDoc.head.appendChild(script);
  };

  iframe.onload=executar;
  // Fallback: se onload n√£o disparar em 1.5s, tenta mesmo assim
  // Guard: executar s√≥ roda uma vez
  let _executado=false;
  const executarUmaVez=()=>{ if(_executado) return; _executado=true; executar(); };
  iframe.onload=executarUmaVez;
  setTimeout(()=>{ if(iframe.contentDocument&&iframe.contentDocument.body) executarUmaVez(); },1500);
}

function _executarImpressaoOP(ordens){
  fecharModal();
  let html='<div style="width:100%;">';
  for(let i=0;i<ordens.length;i++){
    const o=ordens[i];
    // Adiciona data-nr no po-card para o barcode resolver o nr
    const cardHtml=buildOrderHTML(o).replace('<div class="po-card">',`<div class="po-card" data-nr="${o.nr}">`);
    html+=cardHtml;
    if(i<ordens.length-1){
      if(i%2===1) html+='<div style="page-break-after:always;"></div>';
      else html+='<hr class="po-divider">';
    }
  }
  html+='</div>';
  _imprimirNoIframe(html);
}

function _executarImpressaoEtiqueta(ordens){
  fecharModal();
  const html='<div style="display:flex;flex-wrap:wrap;gap:2mm;padding:4mm;">'+
    ordens.map(o=>{
      const h=buildEtiquetaHTML(o);
      return h.replace('<div class="etq-print">',`<div class="etq-print" data-nr="${o.nr}">`);
    }).join('')+'</div>';
  _imprimirNoIframe(html);
}

function imprimirOrdem(nr){
  const o=DB.ordens.find(x=>x.nr===nr);
  if(!o){ toast('Ordem n√£o encontrada','err'); return; }
  _executarImpressaoOP([o]);
}
function imprimirOrdens(ordens){ _executarImpressaoOP(ordens); }
function imprimirEtiqueta(nr){
  const o=DB.ordens.find(x=>x.nr===nr);
  if(!o){ toast('Etiqueta: ordem n√£o encontrada','err'); return; }
  _executarImpressaoEtiqueta([o]);
}
function imprimirAmbos(nr){
  const o=DB.ordens.find(x=>x.nr===nr);
  if(!o){ toast('Ordem n√£o encontrada','err'); return; }
  fecharModal();
  // Monta OP + etiqueta na mesma impress√£o, separados por page-break
  const cardHtml=buildOrderHTML(o).replace('<div class="po-card">',`<div class="po-card" data-nr="${o.nr}">`);
  const etqHtml=buildEtiquetaHTML(o).replace('<div class="etq-print">',`<div class="etq-print" data-nr="${o.nr}">`);
  const html=`<div style="width:100%;">${cardHtml}</div>
    <div style="page-break-before:always;display:flex;flex-wrap:wrap;gap:2mm;padding:4mm;">${etqHtml}</div>`;
  _imprimirNoIframe(html);
}

// ‚ïê‚ïê ETIQUETAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildEtiquetaHTML(o){
  const bcId='etq_'+o.nr.replace(/[^a-zA-Z0-9]/g,'_');
  const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
  const done=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
  const prox=PROCESSOS.find(p=>!done.includes(p.nome));
  let tipoBadge='';
  if(o.isRetrabalho){
    tipoBadge=`<div style="margin-bottom:2mm;background:#ef4444;color:#fff;font-size:9px;font-weight:900;text-align:center;padding:2px 6px;border-radius:3px;letter-spacing:.08em;">‚ö†Ô∏è RETRABALHO${o.ordemOrigem?' ‚Äî OP#'+o.ordemOrigem:''}${o.motivoRetrabalho?' ¬∑ '+o.motivoRetrabalho:''}${o.faseQuebra?' / '+o.faseQuebra:''}</div>`;
  } else if(o.isRecuperavel){
    tipoBadge=`<div style="margin-bottom:2mm;background:#f59e0b;color:#000;font-size:9px;font-weight:900;text-align:center;padding:2px 6px;border-radius:3px;letter-spacing:.08em;">üîÑ RECUPER√ÅVEL${o.ordemOrigem?' ‚Äî OP#'+o.ordemOrigem:''}${o.procInicio?' ¬∑ Entra em: '+o.procInicio:''}${o.motivoDefeito?' ¬∑ '+o.motivoDefeito:''}</div>`;
  }
  return `<div class="etq-print">${tipoBadge}<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2mm;"><div><div style="font-size:14px;font-weight:900;">${o.ref}</div><div style="font-size:8px;font-weight:700;color:#555;">${o.desc||''}</div></div><div style="text-align:right;"><div style="font-size:11px;font-weight:900;">#${o.nr}</div><div style="font-size:8px;color:#888;">${o.qtd} p√ß</div></div></div><svg id="${bcId}" style="width:100%;"></svg><div style="margin-top:2mm;display:flex;justify-content:space-between;align-items:center;"><div style="font-size:8px;background:${prox?'#f59e0b':'#10b981'};color:${prox?'#000':'#fff'};padding:1px 5px;border-radius:3px;font-weight:700;">${prox?prox.nome:'‚úì CONCLU√çDA'}</div><div style="font-size:7px;color:#888;">${new Date().toLocaleDateString('pt-BR')}</div></div></div>`;
}
function imprimirEtiquetasSelecionadas(){ const ordens=[...selectedOrdens].map(nr=>DB.ordens.find(o=>o.nr===nr)).filter(Boolean); if(!ordens.length){ toast('Selecione ao menos uma ordem','err'); return; } _executarImpressaoEtiqueta(ordens); }
function imprimirEtiquetas(ordens){ _executarImpressaoEtiqueta(ordens); }

// ‚ïê‚ïê CADASTRO DE REFER√äNCIAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _editingRef = null; // ref sendo editada
let _crFotoBase64 = null; // foto em base64

function carregarFotoCadRef(input){
  const file = input.files[0];
  if(!file) return;
  // Redimensiona para max 600px para n√£o explodir o localStorage
  const reader = new FileReader();
  reader.onload = e=>{
    const img = new Image();
    img.onload = ()=>{
      const MAX = 600;
      let w=img.width, h=img.height;
      if(w>MAX||h>MAX){ if(w>h){ h=Math.round(h*MAX/w); w=MAX; } else { w=Math.round(w*MAX/h); h=MAX; } }
      const canvas = document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      _crFotoBase64 = canvas.toDataURL('image/jpeg',0.82);
      mostrarPreviewFoto(_crFotoBase64);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function mostrarPreviewFoto(src){
  const imgEl = document.getElementById('crFotoImg');
  const icoEl = document.getElementById('crFotoThumbIco');
  const removeBtn = document.getElementById('crFotoRemoveBtn');
  if(imgEl){ imgEl.src=src; imgEl.style.display='block'; }
  if(icoEl) icoEl.style.display='none';
  if(removeBtn) removeBtn.style.display='inline-flex';
}

function removerFotoCadRef(){
  _crFotoBase64=null;
  const imgEl=document.getElementById('crFotoImg');
  const icoEl=document.getElementById('crFotoThumbIco');
  const removeBtn=document.getElementById('crFotoRemoveBtn');
  if(imgEl){ imgEl.src=''; imgEl.style.display='none'; }
  if(icoEl) icoEl.style.display='block';
  if(removeBtn) removeBtn.style.display='none';
  const inp=document.getElementById('crFotoInput');
  if(inp) inp.value='';
}

function abrirFormCadRef(refParaEditar){
  const formEl = document.getElementById('formCadRef');
  formEl.style.display = 'block';
  formEl.scrollIntoView({behavior:'smooth',block:'start'});
  _editingRef = refParaEditar || null;
  _crFotoBase64 = null;
  document.getElementById('formCadRefTitulo').textContent = _editingRef ? '‚úèÔ∏è Editar Refer√™ncia' : '‚ûï Nova Refer√™ncia';

  if(_editingRef){
    const r = DB.refs.find(x=>x.ref===_editingRef);
    if(!r) return;
    document.getElementById('crRef').value = r.ref;
    document.getElementById('crRef').readOnly = true;
    document.getElementById('crRefAcab').value = r.refAcabada||'';
    document.getElementById('crDesc').value = r.desc||'';
    document.getElementById('crTam').value = r.tam||'';
    document.getElementById('crTipo').value = r.tipo||'';
    document.getElementById('crPrio').value = r.prio||'NORMAL';
  document.getElementById('crPesoPedrasFund').value = r.pesoPedrasFund||0;
  document.getElementById('crMetalFund').value = r.metalFund||'';
    // Foto
    if(r.foto){ _crFotoBase64=r.foto; mostrarPreviewFoto(r.foto); }
    else removerFotoCadRef();
    // Limpa e repopula acess√≥rios
    document.getElementById('acessoriosInternosList').innerHTML='';
    document.getElementById('acessoriosExternosList').innerHTML='';
    (r.acessoriosInternos||[]).forEach(a=>addAcessorio('interno',a));
    (r.acessoriosExternos||[]).forEach(a=>addAcessorio('externo',a));
    // Sub-processo padr√£o
    renderSubPadraoGrid(r.subPadrao||{});
  } else {
    // Limpa o formul√°rio
    ['crRef','crRefAcab','crDesc','crTam'].forEach(id=>{ const el=document.getElementById(id); if(el){el.value='';el.readOnly=false;} });
    document.getElementById('crTipo').value='';
    document.getElementById('crPrio').value='NORMAL';
    removerFotoCadRef();
    document.getElementById('acessoriosInternosList').innerHTML='';
    document.getElementById('acessoriosExternosList').innerHTML='';
    // Sub-processo padr√£o (limpa)
    renderSubPadraoGrid({});
  }
}

function fecharFormCadRef(){
  document.getElementById('formCadRef').style.display='none';
  _editingRef=null;
}

function addAcessorio(tipo, dados){
  const listId = tipo==='interno'?'acessoriosInternosList':'acessoriosExternosList';
  const list = document.getElementById(listId);
  const corLabel = tipo==='interno'?'Cor do Acess√≥rio':'Cor';
  const div = document.createElement('div');
  div.style.cssText='background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;';
  div.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 80px auto;gap:8px;align-items:end;">
      <div class="fg"><div class="fl">Refer√™ncia ${tipo==='interno'?'Acess√≥rio Interno':'Acess√≥rio Externo'}</div>
        <input class="fi" type="text" placeholder="Ex: 10234" value="${dados?.ref||''}" data-campo="ref" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="fg"><div class="fl">${corLabel}</div>
        <input class="fi" type="text" placeholder="Ex: Zirc√¥nia branca" value="${dados?.cor||''}" data-campo="cor"></div>
      <div class="fg"><div class="fl">Tamanho</div>
        <input class="fi" type="text" placeholder="Ex: 3mm" value="${dados?.tam||''}" data-campo="tam"></div>
      <div class="fg"><div class="fl">Qtde</div>
        <input class="fi" type="number" min="1" placeholder="1" value="${dados?.qtd||1}" data-campo="qtd" style="text-align:center;font-weight:800;"></div>
      <button onclick="this.closest('div[style]').remove()" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;border-radius:7px;padding:8px 10px;cursor:pointer;font-size:14px;margin-top:16px;white-space:nowrap;">‚úï</button>
    </div>`;
  list.appendChild(div);
}

function coletarAcessorios(tipo){
  const listId = tipo==='interno'?'acessoriosInternosList':'acessoriosExternosList';
  const list = document.getElementById(listId);
  const rows = list.querySelectorAll('div[style]');
  const result=[];
  rows.forEach(row=>{
    const campos={};
    row.querySelectorAll('[data-campo]').forEach(el=>{ campos[el.dataset.campo]=el.value||''; });
    if(campos.ref) result.push({ref:campos.ref, cor:campos.cor||'', tam:campos.tam||'', qtd:parseInt(campos.qtd)||1});
  });
  return result;
}

function renderSubPadraoGrid(subPadrao){
  const grid = document.getElementById('subPadraoGrid');
  if(!grid) return;
  // Apenas processos com sub-op√ß√µes
  const procsComSub = PROCESSOS.filter(p=>p.subs&&p.subs.length);
  grid.innerHTML = procsComSub.map(p=>{
    const val = subPadrao[p.nome]||'';
    return `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
      <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;">${p.nome}</div>
      <select class="fi" style="font-size:12px;" data-proc="${p.nome}">
        <option value="">‚Äî N√£o definido ‚Äî</option>
        ${p.subs.map(s=>`<option ${s===val?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>`;
  }).join('');
}

function coletarSubPadrao(){
  const grid = document.getElementById('subPadraoGrid');
  if(!grid) return {};
  const result = {};
  grid.querySelectorAll('select[data-proc]').forEach(sel=>{
    if(sel.value) result[sel.dataset.proc] = sel.value;
  });
  return result;
}

function salvarCadRef(){
  const ref = document.getElementById('crRef').value.trim().toUpperCase();
  const desc = document.getElementById('crDesc').value.trim();
  if(!ref||!desc){ toast('Refer√™ncia Bruta e Descri√ß√£o s√£o obrigat√≥rios','err'); return; }

  const novaRef = {
    ref,
    refAcabada: document.getElementById('crRefAcab').value.trim(),
    desc,
    tipo: document.getElementById('crTipo').value,
    tam: document.getElementById('crTam').value.trim(),
    prio: document.getElementById('crPrio').value,
    foto: _crFotoBase64 || (_editingRef ? (DB.refs.find(x=>x.ref===_editingRef)||{}).foto||null : null),
    acessoriosInternos: coletarAcessorios('interno'),
    acessoriosExternos: coletarAcessorios('externo'),
    subPadrao: coletarSubPadrao(),
    pesoPedrasFund: parseFloat(document.getElementById('crPesoPedrasFund').value)||0,
    metalFund: document.getElementById('crMetalFund').value,
    produto: desc,
    atualizado: new Date().toLocaleString('pt-BR')
  };

  if(_editingRef){
    const idx = DB.refs.findIndex(x=>x.ref===_editingRef);
    if(idx>=0) DB.refs[idx]=novaRef; else DB.refs.push(novaRef);
    toast('‚úÖ Refer√™ncia atualizada!','ok');
  } else {
    if(DB.refs.find(x=>x.ref===ref)){ toast('Refer√™ncia '+ref+' j√° est√° cadastrada!','err'); return; }
    DB.refs.push(novaRef);
    toast('‚úÖ Refer√™ncia '+ref+' cadastrada!','ok');
  }
  audit('CADASTRO REF',(_editingRef?'Editada':'Nova')+' refer√™ncia: '+ref, novaRef);
  save();
  fecharFormCadRef();
  renderCadastroRefs();
}

function renderCadastroRefs(){
  const filt=(document.getElementById('filtCadRef')?.value||'').toLowerCase();
  const el = document.getElementById('cadRefLista');
  if(!el) return;
  let refs=[...DB.refs].reverse();
  if(filt) refs=refs.filter(r=>r.ref.toLowerCase().includes(filt)||r.desc.toLowerCase().includes(filt)||(r.refAcabada||'').toLowerCase().includes(filt));
  if(!refs.length){
    el.innerHTML=`<div class="empty"><div class="empty-ico">üì¶</div><p>Nenhuma refer√™ncia cadastrada ainda.<br><small>Clique em "+ Nova Refer√™ncia" para come√ßar.</small></p></div>`;
    return;
  }
  el.innerHTML=refs.map(r=>{
    const intHtml=(r.acessoriosInternos||[]).map(a=>`<span style="background:rgba(139,92,246,.1);color:#c4b5fd;border:1px solid rgba(139,92,246,.2);border-radius:3px;font-size:9px;font-weight:800;padding:1px 6px;">üî© ${a.ref} ${a.cor?'¬∑ '+a.cor:''} ${a.tam?'¬∑ '+a.tam:''} ¬∑ ${a.qtd}un</span>`).join(' ');
    const extHtml=(r.acessoriosExternos||[]).map(a=>`<span style="background:rgba(59,130,246,.1);color:#93c5fd;border:1px solid rgba(59,130,246,.2);border-radius:3px;font-size:9px;font-weight:800;padding:1px 6px;">üì¶ ${a.ref} ${a.cor?'¬∑ '+a.cor:''} ${a.tam?'¬∑ '+a.tam:''} ¬∑ ${a.qtd}un</span>`).join(' ');
    const temAcc = intHtml||extHtml;
    const fotoHtml = r.foto
      ? `<img src="${r.foto}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border);flex-shrink:0;cursor:pointer;" onclick="verFotoAmpliada('${r.ref}')" title="Ver foto ampliada">`
      : `<div style="width:72px;height:72px;border-radius:8px;border:1px dashed var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px;color:var(--muted);">üì∑</div>`;
    // Roteiro t√©cnico compacto
    const roteiroHasConf = Object.keys(r.subPadrao||{}).length > 0;
    const roteiroHtml = buildRoteiroHTMLCompact(r.ref);
    return `<div class="card" style="margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:12px;flex:1;align-items:flex-start;">
          ${fotoHtml}
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:4px;">
              <span style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;color:var(--accent)">${r.ref}</span>
              ${r.refAcabada?`<span class="badge b-gy" style="font-size:10px;">Acab: ${r.refAcabada}</span>`:''}
              ${r.tipo?`<span class="badge b-pu">${r.tipo}</span>`:''}
              ${r.tam?`<span class="badge b-gy">Tam: ${r.tam}</span>`:''}
              <span class="badge ${r.prio==='CRIT√çCO'?'b-rd':r.prio==='URG√äNTE'?'b-yw':'b-gy'}">${r.prio||'NORMAL'}</span>
              ${roteiroHasConf?'<span class="badge b-gn" style="font-size:9px;">üó∫Ô∏è Roteiro definido</span>':'<span class="badge b-gy" style="font-size:9px;opacity:.6;">üó∫Ô∏è Sem roteiro</span>'}
            </div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">${r.desc}</div>
            ${temAcc?`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">${intHtml}${extHtml}</div>`:''}
            <!-- Roteiro t√©cnico -->
            <details ${roteiroHasConf?'open':''}>
              <summary style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;cursor:pointer;user-select:none;margin-bottom:6px;">
                üó∫Ô∏è Roteiro T√©cnico ‚Äî Sub-processos definidos
              </summary>
              <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-top:4px;">
                ${roteiroHtml}
              </div>
            </details>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0;flex-direction:column;align-items:flex-end;">
          <button class="btn btn-gn" style="padding:5px 12px;font-size:11px;" onclick="usarRefNaOrdem('${r.ref}')">+ Ordem</button>
          <div style="display:flex;gap:4px;">
            <button class="btn btn-bl" style="padding:5px 10px;font-size:11px;" onclick="abrirFormCadRef('${r.ref}')">‚úèÔ∏è</button>
            <button class="btn btn-rd" style="padding:5px 10px;font-size:11px;" onclick="excluirCadRef('${r.ref}')">üóë</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function verFotoAmpliada(ref){
  const r = DB.refs.find(x=>x.ref===ref);
  if(!r||!r.foto) return;
  // Cria overlay para ver foto ampliada
  const overlay = document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
  overlay.onclick=()=>overlay.remove();
  overlay.innerHTML=`<div style="max-width:90vw;max-height:90vh;position:relative;">
    <img src="${r.foto}" style="max-width:90vw;max-height:85vh;object-fit:contain;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.6);">
    <div style="text-align:center;margin-top:10px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:#fff;">${r.ref} ‚Äî ${r.desc}</div>
    <div style="text-align:center;font-size:11px;color:rgba(255,255,255,.5);margin-top:4px;">Clique para fechar</div>
  </div>`;
  document.body.appendChild(overlay);
}

function excluirCadRef(ref){
  if(!confirm('Excluir refer√™ncia '+ref+'? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  DB.refs=DB.refs.filter(r=>r.ref!==ref);
  save(); renderCadastroRefs(); toast('Refer√™ncia removida');
}

function usarRefNaOrdem(ref){
  // Vai para aba lan√ßamento e abre modal de nova ordem com ref preenchida
  document.querySelectorAll('.tab')[0].click();
  setTimeout(()=>{
    abrirModal('nova-ordem');
    setTimeout(()=>{
      const el=document.getElementById('mRef');
      if(el){ el.value=ref; autoFillRef(); }
    },80);
  },50);
}

// ‚ïê‚ïê FRACIONAMENTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function adicionarLinhaFrac(){
  const list = document.getElementById('fracInputList');
  if(!list) return;
  const idx = list.children.length + 1 + (window._fracExistCount||0);
  const div = document.createElement('div');
  div.className = 'frac-input-row';
  div.innerHTML=`
    <div class="fg"><div class="fl">Fra√ß√£o F${idx}</div>
      <input class="fi" type="number" min="1" placeholder="Qtde" oninput="atualizarTotalFrac()" style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;text-align:center;">
    </div>
    <div class="fg"><div class="fl">Observa√ß√£o (opcional)</div><input class="fi" type="text" placeholder="Ex: crava√ß√£o especial"></div>
    <button onclick="this.parentElement.remove();atualizarTotalFrac()" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;border-radius:7px;padding:8px 10px;cursor:pointer;font-size:14px;flex-shrink:0;margin-top:16px;">‚úï</button>`;
  list.appendChild(div);
  div.querySelector('input[type=number]').focus();
}

function distribuirFracoesIgual(){
  const list = document.getElementById('fracInputList');
  const linhas = list.querySelectorAll('.frac-input-row');
  const n = linhas.length;
  if(!n) return;
  const total = window._fracQtdDisp||0;
  const base = Math.floor(total/n);
  const resto = total - base*n;
  linhas.forEach((l,i)=>{ l.querySelector('input[type=number]').value = base+(i===n-1?resto:0); });
  atualizarTotalFrac();
}

function atualizarTotalFrac(){
  const list = document.getElementById('fracInputList');
  const infoEl = document.getElementById('fracTotalInfo');
  if(!list||!infoEl) return;
  const qtds = [...list.querySelectorAll('input[type=number]')].map(i=>parseInt(i.value)||0);
  const soma = qtds.reduce((s,v)=>s+v,0);
  const max = window._fracQtdDisp||0;
  const ok = soma>0 && soma<=max;
  infoEl.innerHTML = `Total das fra√ß√µes: <strong style="color:${ok?'var(--green)':soma>max?'var(--red)':'var(--accent)'};">${soma}</strong> / ${max} p√ß dispon√≠veis ${ok?'‚úÖ':soma>max?'‚ùå Excede o dispon√≠vel':'‚ö†Ô∏è Defina as quantidades'}`;
  infoEl.style.borderLeft = `3px solid ${ok?'var(--green)':soma>max?'var(--red)':'var(--accent)'}`;
}

function confirmarFracionamento(){
  const o = window._fracOrdem;
  if(!o){ toast('Erro: ordem n√£o definida','err'); return; }
  const list = document.getElementById('fracInputList');
  const linhas = [...list.querySelectorAll('.frac-input-row')];
  const fracoes = linhas.map((l,i)=>({
    qtd: parseInt(l.querySelector('input[type=number]').value)||0,
    obs: l.querySelectorAll('input[type=text]')[0]?.value||''
  })).filter(f=>f.qtd>0);
  if(!fracoes.length){ toast('Adicione ao menos uma fra√ß√£o com quantidade','err'); return; }
  const soma = fracoes.reduce((s,f)=>s+f.qtd,0);
  const max = window._fracQtdDisp||0;
  if(soma>max){ toast('Total das fra√ß√µes excede a quantidade dispon√≠vel ('+max+'p√ß)','err'); return; }
  const existCount = window._fracExistCount||0;
  const novasFracoes = [];
  fracoes.forEach((f,i)=>{
    const fIdx = existCount+i+1;
    const fNr = o.nr+'-F'+fIdx;
    DB.ordens.push({
      nr:fNr, ref:o.ref, desc:o.desc||'', produto:o.produto||'',
      qtd:f.qtd, tam:o.tam||'', prazo:o.prazo||'', prio:o.prio||'NORMAL',
      obs:f.obs||('Fra√ß√£o '+fIdx+' de '+(existCount+fracoes.length)+' ‚Äî Origem: #'+o.nr),
      criado:new Date().toLocaleString('pt-BR'),
      isFracao:true, ordemPai:o.nr, fracaoIdx:fIdx,
      totalFracoes:existCount+fracoes.length
    });
    // Determina em qual processo a ordem pai est√° atualmente
    // para que os sublotes comecem do mesmo ponto (nao da FILA IMPRESS√ÉO)
    const lansOrdemPai = DB.lancamentos.filter(l=>l.nr===o.nr);
    const doneNomesPai = new Set(lansOrdemPai.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc));
    const proximoProcPai = PROCESSOS_REAIS.find(p=>!doneNomesPai.has(p.nome));
    // Se a ordem pai ainda est√° na FILA/IMPRESS√ÉO 3D, sublote come√ßa na FILA
    // Se j√° passou da impress√£o, sublote come√ßa no pr√≥ximo processo da pai
    const iniciarNaFila = !proximoProcPai || proximoProcPai.nome==='IMPRESS√ÉO 3D';
    const procInicialFracao = iniciarNaFila ? 'FILA IMPRESS√ÉO' : proximoProcPai.nome;

    // Cria lan√ßamento inicial do sublote no processo correto
    DB.lancamentos.push({
      id:Date.now()+fIdx, dt:new Date().toLocaleString('pt-BR'),
      nr:fNr, ref:o.ref, desc:o.desc||'',
      proc: procInicialFracao,
      sub:'', colab:'SISTEMA', ent:0, sai:0, qbr:0,
      motivo:'', hini:'', hfim:'',
      obs: iniciarNaFila
        ? 'Sublote F'+fIdx+' da ordem #'+o.nr+' ‚Äî na fila de impress√£o'
        : 'Sublote F'+fIdx+' da ordem #'+o.nr+' ‚Äî iniciando em '+procInicialFracao,
      turno:'', pcHora:null,
      filaAuto: iniciarNaFila
    });
    novasFracoes.push(DB.ordens[DB.ordens.length-1]);
  });
  audit('FRACIONAMENTO','Ordem #'+o.nr+' fracionada em '+fracoes.length+' sublotes',{nr:o.nr,fracoes:fracoes.length,soma});
  save(); fecharModal();
  atualizarBadgeGargalo();
  renderOrderCard(o);
  // Imprimir etiquetas das novas fra√ß√µes automaticamente
  toast('‚úÖ '+fracoes.length+' sublotes criados! Imprimindo etiquetas...','ok');
  setTimeout(()=>imprimirEtiquetasFracoesOrdem(o.nr),600);
}

function imprimirEtiquetasFracoes(){
  if(!ordemAtual) return;
  imprimirEtiquetasFracoesOrdem(ordemAtual.nr);
}

function imprimirEtiquetasFracoesOrdem(nrPai){
  const fracoes = DB.ordens.filter(o=>o.ordemPai===nrPai);
  if(!fracoes.length){ toast('Nenhuma fra√ß√£o encontrada','err'); return; }
  const html='<div style="display:flex;flex-wrap:wrap;gap:2mm;padding:4mm;">'+
    fracoes.map(f=>buildEtiquetaFracaoHTML(f).replace('<div class="etq-print">',`<div class="etq-print" data-nr="${f.nr}">`)).join('')+'</div>';
  _imprimirNoIframe(html);
}

function buildEtiquetaFracaoHTML(f){
  const bcId='etqf_'+f.nr.replace(/[^a-zA-Z0-9]/g,'_');
  const lans=DB.lancamentos.filter(l=>l.nr===f.nr);
  const done=[...new Set(lans.filter(l=>temSaida(l)).map(l=>l.proc))];
  const prox=PROCESSOS.find(p=>!done.includes(p.nome));
  const pct=Math.round(calcProgresso(lans)/N_PROC*100);
  return `<div class="etq-print"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1mm;">
    <div><div style="font-size:13px;font-weight:900;">${f.ref}</div><div style="font-size:7px;font-weight:700;color:#555;">${f.desc||''}</div></div>
    <div style="text-align:right;"><span class="etq-fracao-flag">F${f.fracaoIdx}/${f.totalFracoes||'?'}</span><div style="font-size:8px;font-weight:900;margin-top:1mm;">${f.qtd} p√ß</div></div>
  </div>
  <div style="font-size:8px;color:#666;margin-bottom:1mm;">Ordem pai: <strong>#${f.ordemPai}</strong> ¬∑ Sublote: <strong>#${f.nr}</strong></div>
  <svg id="${bcId}" style="width:100%;"></svg>
  <div style="margin-top:1mm;display:flex;justify-content:space-between;align-items:center;">
    <div style="font-size:7px;background:${prox?'#f59e0b':'#10b981'};color:${prox?'#000':'#fff'};padding:1px 5px;border-radius:3px;font-weight:700;">${prox?prox.nome:'‚úì CONCLU√çDA'}</div>
    <div style="font-size:7px;color:#888;">${pct}% ¬∑ ${new Date().toLocaleDateString('pt-BR')}</div>
  </div>
  ${f.obs?`<div style="font-size:7px;color:#777;margin-top:1mm;font-style:italic;">${f.obs}</div>`:''}</div>`;
}

function renderFracoesPanel(o){
  const fracoes = DB.ordens.filter(x=>x.ordemPai===o.nr);
  const panel = document.getElementById('fracoesPanel');
  const lista = document.getElementById('fracoesLista');
  if(!fracoes.length){ if(panel) panel.style.display='none'; return; }
  if(panel) panel.style.display='block';
  lista.innerHTML = fracoes.map(f=>{
    const lans_f = DB.lancamentos.filter(l=>l.nr===f.nr);
    const pct = Math.round(calcProgresso(lans_f)/N_PROC*100);
    const doneNomesF = new Set(lans_f.filter(l=>temSaida(l)&&l.proc!=='FILA IMPRESS√ÉO').map(l=>l.proc));
    const etapaAtual = PROCESSOS_REAIS.find(p=>!doneNomesF.has(p.nome));
    const qbrF = lans_f.reduce((s,l)=>s+(l.qbr||0),0);
    const concluida = isOrdemConcluida(lans_f);
    return `<div class="fracao-row">
      <div class="fracao-num">#${f.nr.split('-').pop()}</div>
      <div class="fracao-qtd">${f.qtd}<span style="font-size:9px;color:var(--muted);"> p√ß</span></div>
      <div class="fracao-status" style="flex:1;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;flex-wrap:wrap;">
          <span style="font-size:11px;font-weight:700;color:${concluida?'var(--green)':'#93c5fd'}">${etapaAtual?etapaAtual.nome:'‚úì CONCLU√çDA'}</span>
          ${qbrF>0?`<span class="badge b-rd">${qbrF} qbr</span>`:''}
          <span style="font-size:10px;color:var(--muted);">${calcProgresso(lans)}/${N_PROC} etapas</span>
        </div>
        <div class="fracao-bar"><div class="fracao-bar-fill" style="width:${pct}%;background:${concluida?'var(--green)':'var(--blue)'}"></div></div>
      </div>
      <div class="fracao-actions">
        <button class="btn btn-bl" style="padding:4px 10px;font-size:10px;" onclick="irOrdem('${f.nr}')">‚Üí ABRIR</button>
        <button class="btn btn-gy" style="padding:4px 8px;font-size:10px;" onclick="imprimirEtiquetaFracao('${f.nr}')">üè∑Ô∏è</button>
      </div>
    </div>`;
  }).join('');
}

function imprimirEtiquetaFracao(nr){
  const f = DB.ordens.find(x=>x.nr===nr);
  if(!f) return;
  const html='<div style="padding:4mm;">'+buildEtiquetaFracaoHTML(f).replace('<div class="etq-print">',`<div class="etq-print" data-nr="${f.nr}">`)+'</div>';
  _imprimirNoIframe(html);
}


// ‚ïê‚ïê DASHBOARD ‚Äî PER√çODO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _dashPeriodo = 'hoje';

function setDashPeriodo(p){
  _dashPeriodo = p;
  document.querySelectorAll('.dash-periodo-btn').forEach(b=>b.classList.remove('active'));
  const ids={hoje:'dashBtnHoje',semana:'dashBtnSemana',mes:'dashBtnMes',tudo:'dashBtnTudo'};
  const el=document.getElementById(ids[p]); if(el) el.classList.add('active');
  renderDashboard();
}

function getDashDatas(){
  const hoje=new Date(); hoje.setHours(0,0,0,0);
  if(_dashPeriodo==='hoje')   return {ini:hoje, fim:new Date()};
  if(_dashPeriodo==='semana'){ const i=new Date(hoje); i.setDate(i.getDate()-6); return {ini:i,fim:new Date()}; }
  if(_dashPeriodo==='mes'){    const i=new Date(hoje); i.setDate(1); return {ini:i,fim:new Date()}; }
  return {ini:null,fim:null}; // tudo
}

function filtrarLansPeriodo(lans){
  const {ini,fim}=getDashDatas();
  if(!ini) return lans;
  return lans.filter(l=>{
    if(!l.dt) return false;
    const p=l.dt.split(/[/,\s:]+/);
    if(p.length<3) return true;
    const d=new Date(+p[2],+p[1]-1,+p[0]);
    return d>=ini && d<=fim;
  });
}

// ‚ïê‚ïê COLABORADORES ‚Äî ATIVO/INATIVO + MATR√çCULA + EDI√á√ÉO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirEdicaoColab(nome){
  const c=DB.colaboradores.find(x=>x.nome===nome);
  if(!c){ toast('Colaborador n√£o encontrado','err'); return; }
  const bg=document.getElementById('modalBg');
  const mc=document.getElementById('modalContent');
  mc.innerHTML=`
    <h3>‚úèÔ∏è Editar Colaborador</h3>
    <div class="g2" style="gap:10px;margin-bottom:10px;">
      <div class="fg gfull"><div class="fl">Nome</div><input class="fi" id="ecNome" type="text" value="${c.nome}" readonly style="opacity:.6" title="Nome n√£o pode ser alterado ap√≥s cadastro"></div>
      <div class="fg"><div class="fl">Matr√≠cula</div><input class="fi" id="ecMatricula" type="text" placeholder="Ex: 00123" value="${c.matricula||''}"></div>
      <div class="fg"><div class="fl">Turno</div>
        <select class="fi" id="ecTurno">
          <option value="" ${!c.turno?'selected':''}>N√£o definido</option>
          <option ${c.turno==='MANH√É'?'selected':''}>MANH√É</option>
          <option ${c.turno==='TARDE'?'selected':''}>TARDE</option>
          <option ${c.turno==='NOITE'?'selected':''}>NOITE</option>
        </select>
      </div>
      <div class="fg"><div class="fl">Setor / Processo Principal</div>
        <select class="fi" id="ecSetor">
          <option value="" ${!c.setor?'selected':''}>Geral</option>
          ${PROCESSOS.map(p=>`<option ${c.setor===p.nome?'selected':''}>${p.nome}</option>`).join('')}
        </select>
      </div>
      <div class="fg"><div class="fl">Status</div>
        <select class="fi" id="ecAtivo">
          <option value="true"  ${c.ativo!==false?'selected':''}>‚úÖ Ativo</option>
          <option value="false" ${c.ativo===false?'selected':''}>‚õî Inativo</option>
        </select>
      </div>
    </div>
    <div class="mbtns">
      <button class="mbtn btn-gy" onclick="fecharModal()">Cancelar</button>
      <button class="mbtn btn-gn" onclick="salvarEdicaoColab('${nome}')">‚úÖ SALVAR</button>
    </div>`;
  bg.classList.add('open');
}

function salvarEdicaoColab(nome){
  const c=DB.colaboradores.find(x=>x.nome===nome);
  if(!c) return;
  c.turno     = document.getElementById('ecTurno').value;
  c.setor     = document.getElementById('ecSetor').value;
  c.ativo     = document.getElementById('ecAtivo').value === 'true';
  c.matricula = document.getElementById('ecMatricula').value.trim();
  save(); fecharModal(); toast('‚úÖ Colaborador atualizado!');
  preencherSelectColab(); renderColaboradores();
}

// ‚ïê‚ïê MODO ESC√ÇNER FULLSCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _scannerOrdem=null, _scannerProc=null;

function abrirScanner(){
  const pg=document.getElementById('page-scanner');
  if(pg){ pg.classList.add('open'); }
  // Preenche turno atual
  const turnoEl=document.getElementById('scannerTurnoInfo');
  if(turnoEl){ const t=getTurno(null); turnoEl.textContent='Turno: '+t; }
  // Preenche colaboradores
  const sel=document.getElementById('scannerColab');
  if(sel){
    sel.innerHTML='<option value="">Selecione o colaborador...</option>';
    getColabs().sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(c=>{
      const o=document.createElement('option');
      o.textContent=c.turno?c.nome+' ('+c.turno+')':c.nome;
      o.value=c.nome;
      sel.appendChild(o);
    });
  }
  // Foca no input
  setTimeout(()=>{ const el=document.getElementById('scannerInput'); if(el) el.focus(); },100);
}

function fecharScanner(){
  const pg=document.getElementById('page-scanner');
  if(pg) pg.classList.remove('open');
  _scannerOrdem=null; _scannerProc=null;
  const inp=document.getElementById('scannerInput'); if(inp) inp.value='';
  const card=document.getElementById('scannerCard'); if(card) card.style.display='none';
  const fb=document.getElementById('scannerFeedback'); if(fb) fb.style.display='none';
}

function scannerBuscar(){
  const v=(document.getElementById('scannerInput').value||'').trim();
  if(!v) return;
  const o=DB.ordens.find(x=>x.nr===v||x.nr===v.replace(/\D/g,''));
  const card=document.getElementById('scannerCard');
  const fb=document.getElementById('scannerFeedback');
  if(!o){
    fb.style.display='block'; fb.style.background='rgba(239,68,68,.15)'; fb.style.color='#fca5a5';
    fb.style.border='1px solid rgba(239,68,68,.3)'; fb.textContent='‚ùå Ordem "'+v+'" n√£o encontrada';
    card.style.display='none';
    setTimeout(()=>{ fb.style.display='none'; document.getElementById('scannerInput').select(); },2000);
    return;
  }
  fb.style.display='none';
  _scannerOrdem=o; _scannerProc=null;
  document.getElementById('scannerInput').value='';
  card.style.display='block'; card.classList.add('loaded');
  // Info da ordem
  const lans=DB.lancamentos.filter(l=>l.nr===o.nr);
  const qbr=lans.reduce((s,l)=>s+(l.qbr||0),0);
  const prog=calcProgresso(lans);
  const info=document.getElementById('scannerOrdemInfo');
  info.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--accent)">#${o.nr}</div>
        <div style="font-size:13px;font-weight:700;">${o.ref} ¬∑ ${o.desc||''}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Qtde: ${o.qtd} p√ß ¬∑ Quebra: ${qbr} p√ß ¬∑ ${prioBadge(o.prio)}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--green)">${prog}/${N_PROC}</div>
        <div style="font-size:10px;color:var(--muted);">etapas</div>
        <div style="width:80px;height:5px;background:var(--border);border-radius:3px;margin-top:4px;margin-left:auto;"><div style="height:100%;border-radius:3px;background:var(--green);width:${Math.round(prog/N_PROC*100)}%"></div></div>
      </div>
    </div>`;
  // Processos
  scannerRenderProcs(lans);
  // Esconde form
  document.getElementById('scannerFormBox').style.display='none';
}

function scannerRenderProcs(lans){
  const grid=document.getElementById('scannerProcGrid');
  if(!grid) return;
  grid.innerHTML=PROCESSOS_REAIS.map(p=>{
    const lansP=lans.filter(l=>l.proc===p.nome);
    const feito=lansP.some(l=>temSaida(l));
    const ativo=lansP.some(l=>!l.filaAuto&&l.ent>0&&!temSaida(l));
    const cls=feito?'done':ativo?'ativo':'';
    const ico=feito?'‚úÖ ':ativo?'üîÑ ':'';
    return `<button class="scanner-proc-btn ${cls}" onclick="scannerSelecionarProc('${p.nome}')">${ico}${p.id} ${p.nome}</button>`;
  }).join('');
}

function scannerSelecionarProc(nome){
  if(!_scannerOrdem) return;
  _scannerProc=nome;
  const proc=PROCESSOS.find(p=>p.nome===nome);
  const formBox=document.getElementById('scannerFormBox');
  formBox.style.display='block';
  document.getElementById('scannerProcLabel').textContent='‚Üí '+nome;
  // Sub-processo
  const subRow=document.getElementById('scannerSubRow');
  const subSel=document.getElementById('scannerSub');
  if(proc&&proc.subs&&proc.subs.length){
    subRow.style.display='block';
    // Auto-sugest√£o pelo cadastro da refer√™ncia (MELHORIA 15 ‚Äî sub padr√£o)
    const cadRef=DB.refs.find(r=>r.ref===_scannerOrdem.ref)||CATALOGO.find(r=>r.ref===_scannerOrdem.ref)||{};
    const subPadrao=getSugSubProcesso(_scannerOrdem.ref, nome);
    subSel.innerHTML='<option value="">Selecione...</option>'+proc.subs.map(s=>`<option ${s===subPadrao?'selected':''}>${s}</option>`).join('');
  } else {
    subRow.style.display='none';
    subSel.innerHTML='';
  }
  // Reset qtds
  document.getElementById('scannerEnt').value='';
  document.getElementById('scannerSai').value='';
  document.getElementById('scannerQbrInfo').style.display='none';
  // Foca entrada
  setTimeout(()=>document.getElementById('scannerEnt').focus(),100);
}

function scannerAutoQbr(){
  const ent=parseInt(document.getElementById('scannerEnt').value)||0;
  const sai=parseInt(document.getElementById('scannerSai').value)||0;
  const qbr=Math.max(0,ent-sai);
  const info=document.getElementById('scannerQbrInfo');
  if(ent>0&&sai>=0&&qbr>0){
    info.style.display='block';
    info.textContent='Quebra: '+qbr+' p√ß';
  } else {
    info.style.display='none';
  }
}

function scannerCancelarProc(){
  _scannerProc=null;
  document.getElementById('scannerFormBox').style.display='none';
}

function scannerLancar(){
  if(!_scannerOrdem||!_scannerProc){ toast('Selecione processo','err'); return; }
  const ent=parseInt(document.getElementById('scannerEnt').value)||0;
  const sai=parseInt(document.getElementById('scannerSai').value)||0;
  const col=document.getElementById('scannerColab').value;
  const sub=document.getElementById('scannerSub').value||'';
  if(ent<1){ scannerFeedback('‚ùå Informe a quantidade de entrada','err'); return; }
  if(!col){  scannerFeedback('‚ùå Selecione o colaborador','err'); return; }
  const qbr=Math.max(0,ent-sai);
  const saiPreenchida=sai>0;
  const hh=new Date().toTimeString().slice(0,5);
  const pcHora=calcPcHora({hini:hh,hfim:hh,sai});
  const lan={
    id:Date.now(), dt:new Date().toLocaleString('pt-BR'),
    nr:_scannerOrdem.nr, ref:_scannerOrdem.ref, desc:_scannerOrdem.desc||'',
    proc:_scannerProc, sub, colab:col, ent, sai, qbr,
    saiPreenchida, motivo:qbr>0?'Quebra operacional':'',
    hini:hh, hfim:hh, obs:'Via Modo Esc√¢ner',
    turno:getTurno(hh), pcHora,
    metalTipo:null,metalEnt:null,metalSai:null,metalPerda:null
  };
  DB.lancamentos.push(lan);
  if(saiPreenchida) atualizarMetaDia(_scannerProc, sai);
  audit('SCANNER','Lan√ßamento via esc√¢ner: Ordem #'+_scannerOrdem.nr+' | '+_scannerProc+' | '+col+' | Ent:'+ent+' Sai:'+sai,lan);
  save(); atualizarBadgeGargalo();
  // Feedback visual
  const msg=saiPreenchida
    ?'‚úÖ '+sai+' p√ß lan√ßadas'+( qbr>0?' ¬∑ ‚ùå '+qbr+' qbr':'')+' ‚Äî '+_scannerProc
    :'üì• Entrada de '+ent+' p√ß registrada ‚Äî '+_scannerProc;
  scannerFeedback(msg, saiPreenchida?'ok':'info');
  // Reset para pr√≥xima ordem
  _scannerOrdem=null; _scannerProc=null;
  document.getElementById('scannerCard').style.display='none';
  document.getElementById('scannerFormBox').style.display='none';
  document.getElementById('scannerInput').value='';
  setTimeout(()=>{ document.getElementById('scannerInput').focus(); },300);
}

function scannerFeedback(msg, tipo){
  const fb=document.getElementById('scannerFeedback');
  if(!fb) return;
  const cores={ok:['rgba(16,185,129,.15)','#6ee7b7','rgba(16,185,129,.3)'],
               err:['rgba(239,68,68,.15)','#fca5a5','rgba(239,68,68,.3)'],
               info:['rgba(59,130,246,.15)','#93c5fd','rgba(59,130,246,.3)']};
  const [bg,col,border]=cores[tipo]||cores.info;
  fb.style.display='block';
  fb.style.background=bg; fb.style.color=col; fb.style.border='1px solid '+border;
  fb.textContent=msg;
  setTimeout(()=>{ fb.style.display='none'; },3000);
}

// Atalho teclado: Esc fecha scanner
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const pg=document.getElementById('page-scanner');
    if(pg&&pg.classList.contains('open')){ fecharScanner(); }
  }
});

// ‚ïê‚ïê MELHORIA 15 ‚Äî SUB-PROCESSO PADR√ÉO POR REFER√äNCIA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Retorna o sub-processo padr√£o de uma refer√™ncia para um dado processo,
// consultando DB.refs primeiro, depois o CATALOGO legado
function getSugSubProcesso(ref, procNome){
  const r = DB.refs.find(x=>x.ref===ref);
  const cat = CATALOGO.find(x=>x.ref===ref);
  // Mapeamento de campo por processo (CATALOGO legado)
  const campoMap = {
    'IMPRESS√ÉO 3D':        'impressora',
    'CRAVA√á√ÉO CERA':       'cravacaoCera',
    'LIXA':                'lixa',
    'ACABAMENTO AUTOM√ÅTICO':'acabamento',
    'SOLDA':               'solda',
    'MONTAGEM':            'montagem',
    'CRAVA√á√ÉO METAL':      'cravacaoMetal',
  };
  // DB.refs tem campo subPadrao por processo
  if(r && r.subPadrao && r.subPadrao[procNome]) return r.subPadrao[procNome];
  // Fallback: CATALOGO legado
  const campo = campoMap[procNome];
  if(cat && campo && cat[campo]) return cat[campo];
  return '';
}

// Injetar sugest√£o de sub no lan√ßamento normal (selecionarProc j√° existe, estender)
const _origSelecionarProc = typeof selecionarProc === 'function' ? selecionarProc : null;

// Hook: ap√≥s renderizar o select de sub, auto-seleciona com base na refer√™ncia
function aplicarSubPadrao(){
  if(!ordemAtual || !procAtual) return;
  const sug = getSugSubProcesso(ordemAtual.ref, procAtual);
  const sel = document.getElementById('fSub');
  if(!sel) return;
  // Remove badge anterior se existir
  const oldBadge = document.getElementById('subPadraoBadge');
  if(oldBadge) oldBadge.remove();
  if(!sug) return;
  // Seleciona a op√ß√£o correspondente
  let found = false;
  for(let i=0; i<sel.options.length; i++){
    if(sel.options[i].value === sug || sel.options[i].text === sug){
      sel.selectedIndex = i; found = true; break;
    }
  }
  if(!found) return;
  // Badge informativo abaixo do select: "Roteiro sugere: X"
  const badge = document.createElement('div');
  badge.id = 'subPadraoBadge';
  badge.style.cssText = 'display:flex;align-items:center;gap:6px;margin-top:5px;font-size:10px;color:#93c5fd;font-weight:700;';
  badge.innerHTML = '<span style="font-size:14px;">üó∫Ô∏è</span> Roteiro t√©cnico sugere: <strong style="color:var(--text);">' + sug + '</strong>';
  sel.parentNode.appendChild(badge);
  // Destaca o select com borda azul
  sel.style.borderColor = 'rgba(59,130,246,.6)';
  sel.style.background = 'rgba(59,130,246,.06)';
  sel.addEventListener('change', ()=>{
    badge.remove();
    sel.style.borderColor = '';
    sel.style.background = '';
  }, {once:true});
}

// ‚ïê‚ïê DASHBOARD REVISADO COM PER√çODO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
preencherSelectColab();
atualizarBadgeGargalo();
checarBackupAuto();
// Migrar lan√ßamentos antigos sem turno
DB.lancamentos.forEach(l=>{ if(!l.turno) l.turno=getTurno(l.hini||null); });
</script>
</body>
</html>
